{% extends "base.html" %}
{% block title %}Ø±Ø³ÛŒØ¯Ù‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±{% endblock %}
{% block nav_pending_receipts %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">Ø±Ø³ÛŒØ¯Ù‡Ø§ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
{% endblock %}

{% block extra_head %}
<style>
.receipt-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:1rem; }
.receipt-card { background:#fff; border:1.5px solid var(--surface-2); border-radius:12px; overflow:hidden; }
.receipt-img { background:#f8fafc; display:flex; align-items:center; justify-content:center; min-height:180px; cursor:zoom-in; }
.receipt-img img { max-width:100%; max-height:240px; object-fit:contain; }
#lb { display:none; position:fixed; inset:0; background:rgba(0,0,0,.88); z-index:9999; place-items:center; cursor:zoom-out; }
#lb.on { display:grid; }
</style>
{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;flex-wrap:wrap;gap:.75rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“ Ø±Ø³ÛŒØ¯Ù‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ø¨Ø±Ø±Ø³ÛŒ Ø±Ø³ÛŒØ¯ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</p>
  </div>
  {% if total_pending > 0 %}
  <span style="background:#fef3c7;color:#92400e;border-radius:8px;padding:.35rem .85rem;font-size:.82rem;font-weight:700">
    â³ {{ total_pending }} Ø±Ø³ÛŒØ¯ Ù…Ù†ØªØ¸Ø± Ø¨Ø±Ø±Ø³ÛŒ
  </span>
  {% else %}
  <span style="background:#d1fae5;color:#065f46;border-radius:8px;padding:.35rem .85rem;font-size:.82rem;font-weight:700">
    âœ… Ù‡Ù…Ù‡ Ø±Ø³ÛŒØ¯Ù‡Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡
  </span>
  {% endif %}
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.6rem 1rem;font-size:.83rem;margin-bottom:.6rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

{% if invoices %}
<!-- Ø´Ù‡Ø±ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± -->
<h2 style="font-size:.88rem;font-weight:800;color:var(--navy);margin-bottom:.75rem">Ø±Ø³ÛŒØ¯Ù‡Ø§ÛŒ Ø´Ù‡Ø±ÛŒÙ‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h2>
<div class="receipt-grid" style="margin-bottom:1.5rem">
  {% for inv in invoices %}
  <div class="receipt-card">
    <div style="padding:.75rem 1rem;border-bottom:1px solid var(--surface-2);background:var(--surface-1);display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong style="font-size:.88rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</strong>
        <span style="font-size:.72rem;color:var(--text-muted);display:block">{{ inv.category.name }} â€” {{ inv.jalali_year }}/{% if inv.jalali_month < 10 %}0{% endif %}{{ inv.jalali_month }}</span>
      </div>
      <span style="font-family:monospace;font-weight:900;font-size:.9rem">{{ inv.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
    </div>
    <!-- ØªØµÙˆÛŒØ± -->
    <div class="receipt-img" onclick="openLB('{{ inv.receipt_image.url }}')">
      {% if inv.receipt_image %}
      <img src="{{ inv.receipt_image.url }}" alt="Ø±Ø³ÛŒØ¯">
      {% else %}
      <span style="color:var(--text-muted);font-size:.82rem">Ø¨Ø¯ÙˆÙ† ØªØµÙˆÛŒØ±</span>
      {% endif %}
    </div>
    <!-- Ø§Ù‚Ø¯Ø§Ù… -->
    <div style="padding:.75rem 1rem;display:flex;flex-direction:column;gap:.5rem">
      <form method="post" onsubmit="return confirm('ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ')">
        {% csrf_token %}
        <input type="hidden" name="invoice_pk" value="{{ inv.pk }}">
        <input type="hidden" name="action"     value="confirm">
        <input type="text" name="notes" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)..."
               style="width:100%;padding:.4rem .6rem;border:1.5px solid var(--surface-2);border-radius:6px;font-size:.8rem;margin-bottom:.4rem;box-sizing:border-box">
        <button class="btn btn-green" style="width:100%;font-size:.82rem">âœ… ØªØ£ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      </form>
      <form method="post" onsubmit="return confirm('Ø±Ø³ÛŒØ¯ Ø±Ø¯ Ø´ÙˆØ¯ØŸ')">
        {% csrf_token %}
        <input type="hidden" name="invoice_pk" value="{{ inv.pk }}">
        <input type="hidden" name="action"     value="reject">
        <input type="text" name="notes" placeholder="Ø¯Ù„ÛŒÙ„ Ø±Ø¯..."
               style="width:100%;padding:.4rem .6rem;border:1.5px solid var(--surface-2);border-radius:6px;font-size:.8rem;margin-bottom:.4rem;box-sizing:border-box">
        <button class="btn btn-outline" style="width:100%;font-size:.82rem;color:var(--red);border-color:var(--red)">âŒ Ø±Ø¯ Ø±Ø³ÛŒØ¯</button>
      </form>
      {% if inv.receipt_image %}
      <a href="{{ inv.receipt_image.url }}" target="_blank" download
         style="text-align:center;font-size:.75rem;color:var(--navy)">â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% if is_paginated %}
<div style="display:flex;justify-content:center;gap:.4rem;padding:.75rem">
  {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline btn-sm">â†</a>{% endif %}
  <span style="padding:.45rem .7rem;font-size:.8rem">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline btn-sm">â†’</a>{% endif %}
</div>
{% endif %}
{% else %}
<div style="text-align:center;padding:4rem;color:var(--text-muted)">
  <div style="font-size:3rem;margin-bottom:.75rem">âœ…</div>
  <p style="font-weight:800;font-size:1rem">Ø±Ø³ÛŒØ¯ Ø¬Ø¯ÛŒØ¯ÛŒ Ù†ÛŒØ³Øª</p>
  <p style="font-size:.85rem">Ù‡Ù…Ù‡ Ø±Ø³ÛŒØ¯Ù‡Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯</p>
</div>
{% endif %}

<!-- ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ -->
{% if salary_pending %}
<h2 style="font-size:.88rem;font-weight:800;color:var(--navy);margin-bottom:.75rem;margin-top:1.5rem">â³ ÙÛŒØ´ Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù† â€” Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ù…Ø±Ø¨ÛŒ</h2>
<div style="background:#fffbeb;border:1.5px solid #fbbf24;border-radius:10px;padding:.75rem 1rem;font-size:.82rem;color:#92400e">
  {% for sal in salary_pending %}
  <div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid #fde68a">
    <span>{{ sal.coach }} â€” {{ sal.category.name }} ({{ sal.attendance_sheet.jalali_year }}/{% if sal.attendance_sheet.jalali_month < 10 %}0{% endif %}{{ sal.attendance_sheet.jalali_month }})</span>
    <span style="font-family:monospace;font-weight:700">{{ sal.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ú¯ÛŒØ±Ù†Ø¯Ù‡ -->
{% if staff_pending %}
<h2 style="font-size:.88rem;font-weight:800;color:var(--navy);margin-bottom:.75rem;margin-top:1.5rem">â³ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ â€” Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ú¯ÛŒØ±Ù†Ø¯Ù‡</h2>
<div style="background:#ede9fe;border:1.5px solid #a78bfa;border-radius:10px;padding:.75rem 1rem;font-size:.82rem;color:#4c1d95">
  {% for si in staff_pending %}
  <div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid #c4b5fd">
    <span>{{ si.recipient.get_full_name }} â€” {{ si.title }}</span>
    <span style="font-family:monospace;font-weight:700">{{ si.amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- lightbox -->
<div id="lb" onclick="this.classList.remove('on')">
  <img id="lb-img" style="max-width:92vw;max-height:92vh;object-fit:contain;border-radius:8px">
</div>
<script>
function openLB(url){document.getElementById('lb-img').src=url;document.getElementById('lb').classList.add('on');}
</script>
{% endblock %}