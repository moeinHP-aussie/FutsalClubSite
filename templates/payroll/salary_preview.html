{% extends "base.html" %}
{% block title %}Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø­Ù‚ÙˆÙ‚ â€” {{ coach }}{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:salary-list' category.pk %}?year={{ month.year }}&month={{ month.month }}" style="text-decoration:none;color:inherit">Ø­Ù‚ÙˆÙ‚ {{ category.name }}</a>
  <span class="sep">â€º</span><span class="cur">{{ coach }}</span>
{% endblock %}

{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">
      ğŸ’° Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø­Ù‚ÙˆÙ‚ â€” {{ coach.first_name }} {{ coach.last_name }}
    </h1>
    <p style="font-size:.82rem;color:var(--text-muted)">
      Ø¯Ø³ØªÙ‡: {{ category.name }} &nbsp;|&nbsp; Ù…Ø§Ù‡: {{ month.year }}/{{ month.month|stringformat:"02d" }}
    </p>
  </div>
  <div style="display:flex;gap:.5rem;align-items:center">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† {{ prev_month.year }}/{{ prev_month.month|stringformat:"02d" }}</a>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">{{ next_month.year }}/{{ next_month.month|stringformat:"02d" }} â†’</a>
    <a href="{% url 'payroll:salary-list' category.pk %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.65rem 1rem;font-size:.85rem;margin-bottom:.45rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

{% if error %}
<div style="background:#fee2e2;color:#b91c1c;border-radius:10px;padding:1.25rem;text-align:center">
  <div style="font-size:1.8rem;margin-bottom:.5rem">âš ï¸</div>
  <p style="font-weight:700;font-size:.95rem">{{ error }}</p>
  <p style="font-size:.82rem;margin-top:.5rem">
    Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ
    ÛŒØ§ Ù†Ø±Ø® ØªØ¯Ø±ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø±Ø¨ÛŒ Ùˆ Ø¯Ø³ØªÙ‡ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.
  </p>
  <a href="{% url 'payroll:coach-rate-manage' %}" class="btn btn-navy btn-sm" style="margin-top:.75rem">
    ğŸ’° ØªØ¹ÛŒÛŒÙ† Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒØ§Ù†
  </a>
</div>
{% elif breakdown %}

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:start">

  <!-- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© -->
  <div class="card">
    <div class="card-header"><span class="card-title">ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©</span></div>
    <div style="padding:1.1rem">

      <!-- Ú©Ø§Ø±Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±Ø¨ÛŒ -->
      <div style="display:flex;align-items:center;gap:.75rem;padding:.75rem;background:var(--surface-1);border-radius:10px;margin-bottom:1rem">
        <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--teal));
                    display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#fff;font-weight:900">
          {{ coach.first_name|first|upper }}
        </div>
        <div>
          <p style="font-weight:800;font-size:.9rem;color:var(--navy)">{{ coach.first_name }} {{ coach.last_name }}</p>
          {% if coach.degree %}
          <p style="font-size:.75rem;color:var(--text-muted)">{{ coach.get_degree_display }}</p>
          {% endif %}
        </div>
        {% if breakdown.existing_salary %}
        <span class="badge badge-amber" style="margin-right:auto;font-size:.65rem">
          Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚Ø¨Ù„ÛŒ: {{ breakdown.existing_salary.get_status_display }}
        </span>
        {% endif %}
      </div>

      <!-- Ø¢Ù…Ø§Ø± Ø­Ø¶ÙˆØ± -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem;margin-bottom:1rem;text-align:center">
        <div style="background:#dcfce7;border-radius:8px;padding:.6rem">
          <div style="font-size:1.3rem;font-weight:900;color:#15803d">{{ breakdown.sessions_attended }}</div>
          <div style="font-size:.72rem;color:#15803d">âœ… Ø­Ø§Ø¶Ø±</div>
        </div>
        <div style="background:#fee2e2;border-radius:8px;padding:.6rem">
          <div style="font-size:1.3rem;font-weight:900;color:#b91c1c">{{ breakdown.sessions_absent }}</div>
          <div style="font-size:.72rem;color:#b91c1c">âŒ ØºØ§ÛŒØ¨</div>
        </div>
        <div style="background:#fef9c3;border-radius:8px;padding:.6rem">
          <div style="font-size:1.3rem;font-weight:900;color:#854d0e">{{ breakdown.sessions_excused }}</div>
          <div style="font-size:.72rem;color:#854d0e">âš ï¸ Ù…ÙˆØ¬Ù‡</div>
        </div>
      </div>

      <!-- Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø§Ù„ÛŒ -->
      <table style="width:100%;font-size:.85rem;border-collapse:collapse">
        <tr style="border-bottom:1px solid var(--surface-2)">
          <td style="padding:.45rem 0;color:var(--text-muted)">Ú©Ù„ Ø¬Ù„Ø³Ø§Øª Ù…Ø§Ù‡:</td>
          <td style="text-align:left;font-weight:700">{{ breakdown.sessions_total }} Ø¬Ù„Ø³Ù‡</td>
        </tr>
        <tr style="border-bottom:1px solid var(--surface-2)">
          <td style="padding:.45rem 0;color:var(--text-muted)">Ù†Ø±Ø® Ù‡Ø± Ø¬Ù„Ø³Ù‡:</td>
          <td style="text-align:left;font-family:monospace;font-weight:700;color:var(--navy)">{{ breakdown.session_rate|floatformat:0 }} Ø±ÛŒØ§Ù„</td>
        </tr>
        <tr style="border-bottom:1px solid var(--surface-2)">
          <td style="padding:.45rem 0;color:var(--text-muted)">Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡:</td>
          <td style="text-align:left;font-family:monospace;font-weight:700">
            {{ breakdown.sessions_attended }} Ã— {{ breakdown.session_rate|floatformat:0 }} = {{ breakdown.base_amount|floatformat:0 }} Ø±ÛŒØ§Ù„
          </td>
        </tr>
        {% if breakdown.manual_adjustment and breakdown.manual_adjustment != 0 %}
        <tr style="border-bottom:1px solid var(--surface-2)">
          <td style="padding:.45rem 0;color:var(--text-muted)">ØªØ¹Ø¯ÛŒÙ„ Ø¯Ø³ØªÛŒ:</td>
          <td style="text-align:left;font-family:monospace;color:{% if breakdown.manual_adjustment > 0 %}var(--green){% else %}var(--red){% endif %}">
            {% if breakdown.manual_adjustment > 0 %}+{% endif %}{{ breakdown.manual_adjustment|floatformat:0 }} Ø±ÛŒØ§Ù„
            {% if breakdown.adjustment_reason %}
            <div style="font-size:.7rem;color:var(--text-muted)">{{ breakdown.adjustment_reason }}</div>
            {% endif %}
          </td>
        </tr>
        {% endif %}
        <tr style="background:var(--navy);color:#fff">
          <td style="padding:.6rem .5rem;border-radius:0 0 0 8px;font-weight:800">ğŸ’° Ø­Ù‚ÙˆÙ‚ Ù†Ù‡Ø§ÛŒÛŒ:</td>
          <td style="text-align:left;font-family:monospace;font-size:1.05rem;font-weight:900;border-radius:0 0 8px 0;padding:.6rem .5rem">
            {{ breakdown.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„
          </td>
        </tr>
      </table>

      <!-- Ø¯Ø±ØµØ¯ Ø­Ø¶ÙˆØ± -->
      <div style="margin-top:.85rem">
        <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:.3rem">
          <span style="color:var(--text-muted)">Ø¯Ø±ØµØ¯ Ø­Ø¶ÙˆØ±:</span>
          <strong>{{ breakdown.attendance_pct }}%</strong>
        </div>
        <div style="height:6px;background:var(--surface-2);border-radius:3px;overflow:hidden">
          <div style="height:100%;width:{{ breakdown.attendance_pct }}%;background:{% if breakdown.attendance_pct >= 80 %}var(--green){% elif breakdown.attendance_pct >= 60 %}var(--amber){% else %}#ef4444{% endif %};border-radius:3px;transition:width .4s"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ÙØ±Ù… Ø°Ø®ÛŒØ±Ù‡ -->
  <div style="display:flex;flex-direction:column;gap:1rem">
    <div class="card">
      <div class="card-header"><span class="card-title">âœï¸ ØªØ£ÛŒÛŒØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø­Ù‚ÙˆÙ‚</span></div>
      <form method="post" style="padding:1.1rem">
        {% csrf_token %}
        <input type="hidden" name="year"         value="{{ month.year }}">
        <input type="hidden" name="month"        value="{{ month.month }}">
        <input type="hidden" name="coach_pk"     value="{{ coach.pk }}">
        <input type="hidden" name="category_pk"  value="{{ category.pk }}">

        <div style="margin-bottom:.75rem">
          <label style="font-size:.8rem;font-weight:700;display:block;margin-bottom:.3rem">
            ØªØ¹Ø¯ÛŒÙ„ Ø¯Ø³ØªÛŒ (Ø±ÛŒØ§Ù„)
            <span style="font-size:.7rem;font-weight:400;color:var(--text-muted)"> â€” Ù…Ø«Ø¨Øª: Ø§Ø¶Ø§ÙÙ‡â€ŒÙ¾Ø±Ø¯Ø§Ø®Øª / Ù…Ù†ÙÛŒ: Ú©Ø³Ø±</span>
          </label>
          <input type="number" name="manual_adjustment" value="0" step="1000"
                 class="fi" placeholder="Ù…Ø«Ø§Ù„: 500000 ÛŒØ§ -200000"
                 style="font-family:monospace">
        </div>

        <div style="margin-bottom:1rem">
          <label style="font-size:.8rem;font-weight:700;display:block;margin-bottom:.3rem">Ø¯Ù„ÛŒÙ„ ØªØ¹Ø¯ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <textarea name="adjustment_reason" rows="2" class="fi" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù¾Ø§Ø¯Ø§Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯ØŒ Ú©Ø³Ø± ØªØ£Ø®ÛŒØ±..."></textarea>
        </div>

        <div style="background:#eff6ff;border-radius:8px;padding:.75rem;font-size:.82rem;margin-bottom:1rem">
          <strong style="color:var(--navy)">ğŸ’¡ ØªÙˆØ¬Ù‡:</strong>
          Ø­Ù‚ÙˆÙ‚ Ù†Ù‡Ø§ÛŒÛŒ = {{ breakdown.base_amount|floatformat:0 }} + ØªØ¹Ø¯ÛŒÙ„ ÙˆØ§Ø±Ø¯â€ŒØ´Ø¯Ù‡
        </div>

        {% if breakdown.existing_salary %}
        <div style="background:#fef9c3;border-radius:8px;padding:.6rem .75rem;font-size:.78rem;margin-bottom:.75rem;color:#92400e">
          âš ï¸ ÛŒÚ© Ø±Ú©ÙˆØ±Ø¯ Ø­Ù‚ÙˆÙ‚ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
          ({{ breakdown.existing_salary.get_status_display }}).
          Ø°Ø®ÛŒØ±Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¢Ù† Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        </div>
        {% endif %}

        <button type="submit" class="btn btn-navy btn-sm" style="width:100%">
          ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚
        </button>
      </form>
    </div>

    {% if breakdown.existing_salary %}
    <div class="card">
      <div class="card-header"><span class="card-title">ğŸ”– ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</span></div>
      <div style="padding:1rem;font-size:.85rem;display:grid;gap:.4rem">
        <div style="display:flex;justify-content:space-between;border-bottom:1px solid var(--surface-2);padding:.3rem 0">
          <span style="color:var(--text-muted)">ÙˆØ¶Ø¹ÛŒØª:</span>
          <span class="badge {% if breakdown.existing_salary.status == 'paid' %}badge-green{% elif breakdown.existing_salary.status == 'approved' %}badge-navy{% else %}badge-amber{% endif %}" style="font-size:.65rem">
            {{ breakdown.existing_salary.get_status_display }}
          </span>
        </div>
        <div style="display:flex;justify-content:space-between;border-bottom:1px solid var(--surface-2);padding:.3rem 0">
          <span style="color:var(--text-muted)">Ù…Ø¨Ù„Øº Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡:</span>
          <span style="font-family:monospace;font-weight:700">{{ breakdown.existing_salary.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        </div>
        {% if breakdown.existing_salary.paid_at %}
        <div style="display:flex;justify-content:space-between;padding:.3rem 0">
          <span style="color:var(--text-muted)">ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
          <span>{{ breakdown.existing_salary.paid_at|date:"Y/m/d" }}</span>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>

</div>
{% endif %}

<style>
.fi { width:100%; padding:.5rem .75rem; border:1.5px solid var(--surface-2); border-radius:8px; font-family:inherit; font-size:.875rem; box-sizing:border-box; }
.fi:focus { outline:none; border-color:var(--navy); }
</style>
{% endblock %}