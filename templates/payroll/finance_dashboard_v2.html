{% extends "base.html" %}
{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span><span class="cur">Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ</span>
{% endblock %}

{% block content %}

<!-- Header + nav Ù…Ø§Ù‡ -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.15rem;font-weight:900;color:var(--navy)">ğŸ’° Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ù‡Ø±ÛŒÙ‡ØŒ Ø­Ù‚ÙˆÙ‚ Ùˆ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø´Ú¯Ø§Ù‡</p>
  </div>
  <div style="display:flex;align-items:center;gap:.5rem">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† {{ prev_month.year }}/{{ prev_month.month }}</a>
    <span style="font-weight:800;font-size:.95rem;color:var(--navy)">{{ month.year }}/{{ month.month|stringformat:"02d" }}</span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">{{ next_month.year }}/{{ next_month.month }} â†’</a>
  </div>
</div>

<!-- Stats Row -->
<div class="grid-auto" style="margin-bottom:1.25rem">
  <div class="stat-card green">
    <div class="stat-label">Ø´Ù‡Ø±ÛŒÙ‡ Ø¯Ø±ÛŒØ§ÙØªâ€ŒØ´Ø¯Ù‡</div>
    <div class="stat-value" style="font-size:1.1rem">{{ invoice_stats.paid_amount|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„ â€” {{ invoice_stats.paid }} ÙØ§Ú©ØªÙˆØ±</div>
    <span class="stat-icon">âœ…</span>
  </div>
  <div class="stat-card amber">
    <div class="stat-label">Ø´Ù‡Ø±ÛŒÙ‡ Ù…Ø¹ÙˆÙ‚</div>
    <div class="stat-value" style="font-size:1.1rem">{{ invoice_stats.pending_amount|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„ â€” {{ invoice_stats.pending|add:invoice_stats.debtor }} ÙØ§Ú©ØªÙˆØ±</div>
    <span class="stat-icon">â³</span>
  </div>
  <div class="stat-card navy">
    <div class="stat-label">Ø­Ù‚ÙˆÙ‚ ØªØ£ÛŒÛŒØ¯â€ŒØ´Ø¯Ù‡ Ù…Ø±Ø¨ÛŒØ§Ù†</div>
    <div class="stat-value" style="font-size:1.1rem">{{ salary_stats.total_amount|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„ â€” {{ salary_stats.approved }} Ù…Ø±Ø¨ÛŒ</div>
    <span class="stat-icon">ğŸ‘¨â€ğŸ«</span>
  </div>
  <div class="stat-card teal">
    <div class="stat-label">ÙØ§Ú©ØªÙˆØ± Ø¯Ø³ØªÛŒ Ù…Ø¹Ù„Ù‚</div>
    <div class="stat-value">{{ staff_invoice_stats.pending_count }}</div>
    <div class="stat-sub">{{ staff_invoice_stats.pending_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">ğŸ“„</span>
  </div>
</div>

<!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ø³Ø±ÛŒØ¹ -->
<div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1.25rem">
  <a href="{% url 'payroll:coach-payroll-summary' %}" class="btn btn-navy btn-sm">ğŸ‘¨â€ğŸ« Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†</a>
  <a href="{% url 'payroll:player-payment-status' %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-navy btn-sm">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø´Ù‡Ø±ÛŒÙ‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</a>
  <a href="{% url 'payroll:coach-rate-manage' %}" class="btn btn-amber btn-sm">ğŸ’° ØªØ¹ÛŒÛŒÙ† Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒØ§Ù†</a>
  <a href="{% url 'payroll:staff-invoice-create' %}" class="btn btn-amber btn-sm">ğŸ“„ ÙØ§Ú©ØªÙˆØ± Ø¯Ø³ØªÛŒ Ø¬Ø¯ÛŒØ¯</a>
  <a href="{% url 'payroll:expense-create' %}" class="btn btn-outline btn-sm">ğŸ’¸ Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</a>
  <a href="{% url 'payroll:finance-attendance-cats' %}" class="btn btn-outline btn-sm">ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</a>
  <a href="{% url 'payroll:all-financial-history' %}" class="btn btn-outline btn-sm">ğŸ“Š ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„</a>
  <form method="post" action="{% url 'payroll:invoice-generate-all' %}" style="display:inline">
    {% csrf_token %}
    <input type="hidden" name="year"  value="{{ month.year }}">
    <input type="hidden" name="month" value="{{ month.month }}">
    <button type="submit" class="btn btn-outline btn-sm"
            onclick="return confirm('ÙØ§Ú©ØªÙˆØ± Ù…Ø§Ù‡ {{ month.year }}/{{ month.month }} Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ ØµØ§Ø¯Ø± Ø´ÙˆØ¯ØŸ')">
      âš¡ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§
    </button>
  </form>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">

  <!-- ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“‹ Ø±Ø³ÛŒØ¯ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>
      <span style="font-size:.75rem;color:var(--amber);font-weight:700">{{ invoice_stats.pending_confirm }} Ù…ÙˆØ±Ø¯</span>
    </div>
    {% if awaiting_confirm %}
    <div style="padding:.5rem .85rem">
      {% for inv in awaiting_confirm %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <div>
          <strong style="font-size:.85rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</strong>
          <div style="font-size:.72rem;color:var(--text-muted)">{{ inv.category.name }}</div>
        </div>
        <div style="display:flex;gap:.35rem;align-items:center">
          <span style="font-size:.78rem;font-weight:700">{{ inv.final_amount|floatformat:0 }}</span>
          <form method="post" action="{% url 'payroll:invoice-status-update' inv.pk %}" style="margin:0">
            {% csrf_token %}
            <input type="hidden" name="new_status" value="paid">
            <button class="btn btn-green btn-sm" style="padding:.2rem .5rem;font-size:.72rem">âœ… ØªØ£ÛŒÛŒØ¯</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.85rem">Ø±Ø³ÛŒØ¯ Ù…Ø¹Ù„Ù‚ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ âœ“</div>
    {% endif %}
  </div>

  <!-- Ø´Ù‡Ø±ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">âš ï¸ Ø´Ù‡Ø±ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚</span>
      <span style="font-size:.75rem;color:var(--red);font-weight:700">{{ invoice_stats.debtor }} Ù…ÙˆØ±Ø¯</span>
    </div>
    {% if debtor_invoices %}
    <div style="padding:.5rem .85rem">
      {% for inv in debtor_invoices %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <div>
          <strong style="font-size:.85rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</strong>
          <div style="font-size:.72rem;color:var(--text-muted)">{{ inv.category.name }} â€” {{ inv.jalali_year }}/{{ inv.jalali_month|stringformat:"02d" }}</div>
        </div>
        <span style="font-size:.78rem;font-weight:700;color:var(--red)">{{ inv.final_amount|floatformat:0 }}</span>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.85rem">Ø¨Ø¯Ù‡ÛŒ Ù…Ø¹ÙˆÙ‚ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ âœ“</div>
    {% endif %}
  </div>

  <!-- Ø­Ù‚ÙˆÙ‚ ØªØ£ÛŒÛŒØ¯â€ŒØ´Ø¯Ù‡ Ù‡Ù†ÙˆØ² Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ‘¨â€ğŸ« Ø­Ù‚ÙˆÙ‚ ØªØ£ÛŒÛŒØ¯â€ŒØ´Ø¯Ù‡ (Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ†Ø´Ø¯Ù‡)</span>
      <a href="{% url 'payroll:coach-payroll-summary' %}" class="btn btn-navy btn-sm">Ù¾Ø±Ø¯Ø§Ø®Øª</a>
    </div>
    {% if approved_salaries %}
    <div style="padding:.5rem .85rem">
      {% for sal in approved_salaries %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <div>
          <strong style="font-size:.85rem">{{ sal.coach.first_name }} {{ sal.coach.last_name }}</strong>
          <div style="font-size:.72rem;color:var(--text-muted)">{{ sal.category.name }}</div>
        </div>
        <span style="font-size:.78rem;font-weight:700;color:var(--amber)">{{ sal.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.85rem">Ø­Ù‚ÙˆÙ‚ Ù…Ø¹Ù„Ù‚ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ âœ“</div>
    {% endif %}
  </div>

  <!-- Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ + Ù„ÛŒÙ†Ú© Ø³Ø±ÛŒØ¹ -->
  <div class="card">
    <div class="card-header"><span class="card-title">ğŸ—‚ï¸ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</span></div>
    <div style="padding:.6rem .85rem">
      {% for cat in categories %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.45rem 0;border-bottom:1px solid var(--surface-2)">
        <span style="font-size:.85rem;font-weight:700">{{ cat.name }}</span>
        <div style="display:flex;gap:.3rem">
          <a href="{% url 'payroll:invoice-list' cat.pk %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .45rem">ğŸ’³ ÙØ§Ú©ØªÙˆØ±</a>
          <a href="{% url 'payroll:salary-list' cat.pk %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .45rem">ğŸ‘¨â€ğŸ« Ø­Ù‚ÙˆÙ‚</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}