{% extends "base.html" %}
{% block title %}ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ â€” {{ category.name }}{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">{{ category.name }}</span>
{% endblock %}

{% block content %}

<!-- Header -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.1rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“‹ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø´Ù‡Ø±ÛŒÙ‡ â€” {{ category.name }}</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ø´Ù‡Ø±ÛŒÙ‡ Ù…Ø§Ù‡Ø§Ù†Ù‡: {{ category.monthly_fee|floatformat:0 }} Ø±ÛŒØ§Ù„</p>
  </div>
  <!-- Ù…Ø§Ù‡â€ŒÚ¯Ø±Ø¯ÛŒ -->
  <div style="display:flex;align-items:center;gap:.5rem">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† {{ prev_month.year }}/{{ prev_month.month|stringformat:"02d" }}</a>
    <span style="font-weight:800;font-size:.95rem;color:var(--navy);background:var(--surface-1);padding:.3rem .7rem;border-radius:8px">
      {{ month.year }}/{{ month.month|stringformat:"02d" }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">{{ next_month.year }}/{{ next_month.month|stringformat:"02d" }} â†’</a>
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.65rem 1rem;font-size:.85rem;margin-bottom:.45rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

<!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
<div class="grid-auto" style="margin-bottom:1.1rem">
  <div class="stat-card green">
    <div class="stat-label">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</div>
    <div class="stat-value">{{ status_counts.paid }}</div>
    <div class="stat-sub">{{ total_paid|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">âœ…</span>
  </div>
  <div class="stat-card amber">
    <div class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
    <div class="stat-value">{{ status_counts.pending }}</div>
    <div class="stat-sub">ÙØ§Ú©ØªÙˆØ± Ù…Ø¹ÙˆÙ‚</div>
    <span class="stat-icon">â³</span>
  </div>
  <div class="stat-card red">
    <div class="stat-label">Ø¨Ø¯Ù‡Ú©Ø§Ø±</div>
    <div class="stat-value">{{ status_counts.debtor }}</div>
    <div class="stat-sub">ÙØ§Ú©ØªÙˆØ± Ù…Ø¹ÙˆÙ‚</div>
    <span class="stat-icon">ğŸ”´</span>
  </div>
  <div class="stat-card teal">
    <div class="stat-label">Ø±Ø³ÛŒØ¯ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
    <div class="stat-value">{{ status_counts.pending_confirm }}</div>
    <div class="stat-sub">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯</div>
    <span class="stat-icon">ğŸ“</span>
  </div>
</div>

<!-- Ø§Ù‚Ø¯Ø§Ù…Ø§Øª -->
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1.1rem;align-items:center">
  {% if request.user.is_finance_manager %}
  <form method="post" action="{% url 'payroll:invoice-generate' category.pk %}" style="margin:0">
    {% csrf_token %}
    <input type="hidden" name="year"  value="{{ month.year }}">
    <input type="hidden" name="month" value="{{ month.month }}">
    <button type="submit" class="btn btn-navy btn-sm"
            onclick="return confirm('ÙØ§Ú©ØªÙˆØ± Ù…Ø§Ù‡ {{ month.year }}/{{ month.month|stringformat:"02d" }} Ø¨Ø±Ø§ÛŒ {{ category.name }} ØµØ§Ø¯Ø± Ø´ÙˆØ¯ØŸ')">
      âš¡ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ± Ø§ÛŒÙ† Ù…Ø§Ù‡
    </button>
  </form>
  {% endif %}

  <!-- ÙÛŒÙ„ØªØ± ÙˆØ¶Ø¹ÛŒØª -->
  <form method="get" style="display:flex;gap:.4rem;margin:0">
    <input type="hidden" name="year"  value="{{ month.year }}">
    <input type="hidden" name="month" value="{{ month.month }}">
    <select name="status" class="field-input" style="padding:.35rem .65rem;font-size:.82rem;border-radius:8px;border:1.5px solid var(--surface-2)">
      <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
      {% for val, label in status_choices %}
      <option value="{{ val }}" {% if request.GET.status == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-outline btn-sm">ğŸ” ÙÛŒÙ„ØªØ±</button>
  </form>

  <a href="{% url 'payroll:finance-dashboard' %}" class="btn btn-outline btn-sm">â† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ -->
{% if invoices %}
<div class="card">
  <div style="overflow-x:auto">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>
          <th>Ù…Ø¨Ù„Øº</th>
          <th>ØªØ®ÙÛŒÙ</th>
          <th>Ù†Ù‡Ø§ÛŒÛŒ</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ø±Ø³ÛŒØ¯</th>
          {% if request.user.is_finance_manager %}<th>Ø§Ù‚Ø¯Ø§Ù…</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td style="font-size:.78rem;color:var(--text-muted)">{{ forloop.counter }}</td>
          <td>
            <strong style="font-size:.88rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</strong>
            {% if inv.player.phone %}<div style="font-size:.72rem;color:var(--text-muted);font-family:monospace">{{ inv.player.phone }}</div>{% endif %}
          </td>
          <td style="font-family:monospace;font-size:.85rem">{{ inv.amount|floatformat:0 }}</td>
          <td style="font-family:monospace;font-size:.85rem;color:var(--green)">
            {% if inv.discount %}{{ inv.discount|floatformat:0 }}{% else %}â€”{% endif %}
          </td>
          <td style="font-family:monospace;font-size:.9rem;font-weight:700;color:var(--navy)">{{ inv.final_amount|floatformat:0 }}</td>
          <td>
            {% if inv.status == 'paid' %}
              <span class="badge badge-green" style="font-size:.68rem">âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
            {% elif inv.status == 'pending_confirm' %}
              <span class="badge badge-amber" style="font-size:.68rem">ğŸ“ Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>
            {% elif inv.status == 'debtor' %}
              <span class="badge badge-red" style="font-size:.68rem">ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
            {% else %}
              <span class="badge" style="background:#e5e7eb;color:#374151;font-size:.68rem">â³ Ù…Ø¹ÙˆÙ‚</span>
            {% endif %}
          </td>
          <td>
            {% if inv.receipt_image %}
              <a href="{{ inv.receipt_image.url }}" target="_blank" class="btn btn-outline btn-sm" style="font-size:.7rem">ğŸ“ Ø±Ø³ÛŒØ¯</a>
            {% else %}
              <span style="font-size:.75rem;color:var(--text-muted)">â€”</span>
            {% endif %}
          </td>
          {% if request.user.is_finance_manager %}
          <td>
            <div style="display:flex;gap:.3rem;flex-wrap:wrap">
              {% if inv.status == 'pending_confirm' %}
              <form method="post" action="{% url 'payroll:invoice-confirm' inv.pk %}" style="margin:0">
                {% csrf_token %}
                <button class="btn btn-green btn-sm" style="font-size:.7rem;padding:.2rem .5rem"
                        onclick="return confirm('Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ')">âœ… ØªØ£ÛŒÛŒØ¯</button>
              </form>
              {% endif %}
              {% if inv.status != 'paid' %}
              <form method="post" action="{% url 'payroll:invoice-status-update' inv.pk %}" style="margin:0">
                {% csrf_token %}
                <select name="new_status" style="font-size:.72rem;border:1px solid var(--surface-2);border-radius:6px;padding:.2rem">
                  {% for val, label in status_choices %}
                  <option value="{{ val }}" {% if inv.status == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .4rem">ØªØºÛŒÛŒØ±</button>
              </form>
              {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
  <div style="padding:.75rem 1rem;border-top:1px solid var(--surface-2);display:flex;gap:.4rem;justify-content:center">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}&year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â†</a>{% endif %}
    <span style="padding:.35rem .75rem;font-size:.82rem">ØµÙØ­Ù‡ {{ page_obj.number }} Ø§Ø² {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}&year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â†’</a>{% endif %}
  </div>
  {% endif %}
</div>
{% else %}
<div style="text-align:center;padding:3rem;color:var(--text-muted)">
  <div style="font-size:2.5rem;margin-bottom:.5rem">ğŸ“‹</div>
  <p style="font-size:.95rem;font-weight:700">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
  <p style="font-size:.82rem">{% if request.user.is_finance_manager %}Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Â«ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±Â» ÙØ§Ú©ØªÙˆØ± ØµØ§Ø¯Ø± Ú©Ù†ÛŒØ¯.{% endif %}</p>
</div>
{% endif %}

{% endblock %}