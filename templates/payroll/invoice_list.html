{% extends "base.html" %}
{% block title %}ÙØ§Ú©ØªÙˆØ± Ø´Ù‡Ø±ÛŒÙ‡ â€” {{ category.name }}{% endblock %}
{% block nav_tuition %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:tuition-categories' %}" style="text-decoration:none;color:inherit">Ø´Ù‡Ø±ÛŒÙ‡</a>
  <span class="sep">â€º</span><span class="cur">{{ category.name }}</span>
{% endblock %}

{% block extra_head %}
<style>
.status-pending { background:#fef3c7; color:#92400e; }
.status-debtor  { background:#fee2e2; color:#991b1b; }
.status-pending_confirm { background:#dbeafe; color:#1e3a8a; }
.status-paid    { background:#d1fae5; color:#065f46; }
.action-row { display:flex; gap:.3rem; flex-wrap:wrap; }
</style>
{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem">
  <div>
    <h1 style="font-size:1.05rem;font-weight:900;color:var(--navy)">ğŸ§¾ {{ category.name }}</h1>
    <p style="font-size:.78rem;color:var(--text-muted)">Ø´Ù‡Ø±ÛŒÙ‡ {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}</p>
  </div>
  <div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„</a>
    <span style="font-weight:800;font-size:.88rem;background:var(--surface-1);padding:.3rem .65rem;border-radius:6px">
      {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ â†’</a>
    {% if request.user.is_finance_manager %}
    <form method="post" action="{% url 'payroll:invoice-generate' category.pk %}" style="margin:0"
          onsubmit="return confirm('ÙØ§Ú©ØªÙˆØ± ØµØ§Ø¯Ø± Ø´ÙˆØ¯ØŸ')">
      {% csrf_token %}
      <input type="hidden" name="year" value="{{ month.year }}">
      <input type="hidden" name="month" value="{{ month.month }}">
      <button class="btn btn-navy btn-sm">ğŸ“¤ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±</button>
    </form>
    {% endif %}
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.6rem .9rem;font-size:.83rem;margin-bottom:.5rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

<!-- Ø¢Ù…Ø§Ø± -->
<div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:1rem">
  <div style="background:#d1fae5;border-radius:8px;padding:.5rem .9rem;font-size:.8rem">
    <span style="font-weight:900;color:var(--green);font-size:.95rem">{{ stats.paid }}</span>
    <span style="color:#065f46"> Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</span>
    <span style="font-family:monospace;font-size:.75rem;color:#065f46"> ({{ stats.paid_amount|floatformat:0 }} Ø±ÛŒØ§Ù„)</span>
  </div>
  <div style="background:#fef3c7;border-radius:8px;padding:.5rem .9rem;font-size:.8rem">
    <span style="font-weight:900;color:#92400e;font-size:.95rem">{{ stats.pending }}</span> Ù…Ø¹ÙˆÙ‚
  </div>
  <div style="background:#fee2e2;border-radius:8px;padding:.5rem .9rem;font-size:.8rem">
    <span style="font-weight:900;color:#991b1b;font-size:.95rem">{{ stats.debtor }}</span> Ø¨Ø¯Ù‡Ú©Ø§Ø±
  </div>
  {% if stats.pending_confirm > 0 %}
  <a href="{% url 'payroll:pending-receipts' %}" style="text-decoration:none"
     style="background:#dbeafe;border-radius:8px;padding:.5rem .9rem;font-size:.8rem;display:flex;align-items:center;gap:.4rem">
    <span style="font-weight:900;color:#1e3a8a;font-size:.95rem">{{ stats.pending_confirm }}</span>
    <span style="color:#1e3a8a">ğŸ“ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ â†’</span>
  </a>
  {% endif %}
  <!-- ÙÛŒÙ„ØªØ± -->
  <div style="margin-right:auto;display:flex;gap:.3rem">
    <a href="?year={{ month.year }}&month={{ month.month }}"
       class="btn btn-sm {% if not status_filter %}btn-navy{% else %}btn-outline{% endif %}">Ù‡Ù…Ù‡</a>
    <a href="?year={{ month.year }}&month={{ month.month }}&status=pending_confirm"
       class="btn btn-sm {% if status_filter == 'pending_confirm' %}btn-amber{% else %}btn-outline{% endif %}">ğŸ“ Ø±Ø³ÛŒØ¯</a>
    <a href="?year={{ month.year }}&month={{ month.month }}&status=debtor"
       class="btn btn-sm {% if status_filter == 'debtor' %}btn-red{% else %}btn-outline{% endif %}">Ø¨Ø¯Ù‡Ú©Ø§Ø±</a>
  </div>
</div>

<div class="card">
  {% if invoices %}
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>
          <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ø±Ø³ÛŒØ¯</th>
          {% if request.user.is_finance_manager %}<th>Ø§Ù‚Ø¯Ø§Ù…</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td style="font-size:.75rem;color:var(--text-muted)">{{ forloop.counter }}</td>
          <td>
            <div style="font-weight:700;font-size:.88rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</div>
            {% if inv.player.phone %}<div style="font-size:.7rem;color:var(--text-muted)">{{ inv.player.phone }}</div>{% endif %}
          </td>
          <td style="font-family:monospace;font-size:.9rem;font-weight:700">{{ inv.final_amount|floatformat:0 }}</td>
          <td>
            <span class="badge status-{{ inv.status }}" style="font-size:.68rem;border-radius:99px;padding:.18rem .55rem">
              {% if inv.status == 'pending' %}â³ Ù…Ø¹ÙˆÙ‚
              {% elif inv.status == 'debtor' %}ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±
              {% elif inv.status == 'pending_confirm' %}ğŸ“ Ø±Ø³ÛŒØ¯ Ø¯Ø§Ø±Ø¯
              {% elif inv.status == 'paid' %}âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡
              {% endif %}
            </span>
          </td>
          <td>
            {% if inv.receipt_image %}
            <a href="{{ inv.receipt_image.url }}" target="_blank"
               class="btn btn-outline btn-sm" style="font-size:.7rem">ğŸ‘ï¸ Ø±Ø³ÛŒØ¯</a>
            {% else %}â€”{% endif %}
          </td>
          {% if request.user.is_finance_manager %}
          <td>
            <div class="action-row">
              {% if inv.status == 'pending_confirm' %}
              <form method="post" action="{% url 'payroll:invoice-confirm' inv.pk %}" style="margin:0"
                    onsubmit="return confirm('Ø±Ø³ÛŒØ¯ ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ')">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button class="btn btn-green btn-sm" style="font-size:.7rem">âœ… ØªØ£ÛŒÛŒØ¯</button>
              </form>
              {% endif %}
              {% if inv.status != 'paid' %}
              <form method="post" action="{% url 'payroll:invoice-status-update' inv.pk %}"
                    style="margin:0;display:flex;gap:.25rem">
                {% csrf_token %}
                <input type="hidden" name="redirect_to" value="{{ request.get_full_path }}">
                <select name="new_status"
                        style="font-size:.7rem;border:1.5px solid var(--surface-2);border-radius:5px;padding:.2rem .35rem">
                  {% for val, lbl in status_choices %}
                  <option value="{{ val }}" {% if inv.status == val %}selected{% endif %}>{{ lbl }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline btn-sm" style="font-size:.7rem">âœ“</button>
              </form>
              {% if inv.player.user %}
              <form method="post" action="{% url 'payroll:send-reminder' %}" style="margin:0"
                    onsubmit="return confirm('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')">
                {% csrf_token %}
                <input type="hidden" name="invoice_pk" value="{{ inv.pk }}">
                <button class="btn btn-amber btn-sm" style="font-size:.7rem" title="Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ">ğŸ””</button>
              </form>
              {% endif %}
              {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ -->
  {% if request.user.is_finance_manager %}
  <div style="padding:.75rem 1rem;border-top:1px solid var(--surface-2);display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
    <form method="post" action="{% url 'payroll:send-reminder' %}" style="margin:0"
          onsubmit="return confirm('Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù† Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')">
      {% csrf_token %}
      <input type="hidden" name="year"   value="{{ month.year }}">
      <input type="hidden" name="month"  value="{{ month.month }}">
      <button class="btn btn-amber btn-sm">ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†</button>
    </form>
  </div>
  {% endif %}

  {% if is_paginated %}
  <div style="display:flex;justify-content:center;gap:.4rem;padding:.85rem">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}&year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â†</a>{% endif %}
    <span style="padding:.5rem .75rem;font-size:.82rem">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}&year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â†’</a>{% endif %}
  </div>
  {% endif %}

  {% else %}
  <div style="padding:2.5rem;text-align:center;color:var(--text-muted)">
    <div style="font-size:2rem;margin-bottom:.5rem">ğŸ§¾</div>
    <p style="font-weight:700">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ ØµØ§Ø¯Ø± Ù†Ø´Ø¯Ù‡</p>
    {% if request.user.is_finance_manager %}
    <form method="post" action="{% url 'payroll:invoice-generate' category.pk %}" style="margin:.75rem 0 0">
      {% csrf_token %}
      <input type="hidden" name="year" value="{{ month.year }}">
      <input type="hidden" name="month" value="{{ month.month }}">
      <button class="btn btn-navy">ğŸ“¤ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±</button>
    </form>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}