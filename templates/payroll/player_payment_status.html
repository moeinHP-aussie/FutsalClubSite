{% extends "base.html" %}
{% block title %}ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù‡Ø±ÛŒÙ‡{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">ÙˆØ¶Ø¹ÛŒØª Ø´Ù‡Ø±ÛŒÙ‡</span>
{% endblock %}

{% block content %}

<!-- Header -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.1rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ù‡Ø±ÛŒÙ‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">
      {% if request.user.is_finance_manager %}Ù…Ø¯ÛŒØ± Ù…Ø§Ù„ÛŒ â€” ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ùˆ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª{% else %}Ù…Ø¯ÛŒØ± ÙÙ†ÛŒ â€” Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ{% endif %}
    </p>
  </div>
  <!-- Ù…Ø§Ù‡â€ŒÚ¯Ø±Ø¯ÛŒ -->
  <div style="display:flex;align-items:center;gap:.5rem">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}{% if selected_cat %}&category={{ selected_cat.pk }}{% endif %}" class="btn btn-outline btn-sm">â†</a>
    <span style="font-weight:800;font-size:.95rem;color:var(--navy);background:var(--surface-1);padding:.3rem .8rem;border-radius:8px">
      {{ month.year }}/{{ month.month|stringformat:"02d" }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}{% if selected_cat %}&category={{ selected_cat.pk }}{% endif %}" class="btn btn-outline btn-sm">â†’</a>
  </div>
</div>

{% if request.user.is_finance_manager and stats.pending or stats.debtor %}
<div style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:1rem;padding:.75rem 1rem;background:#fffbeb;border-radius:10px;border:1.5px solid #fbbf24">
  <span style="font-size:.82rem;font-weight:700;color:#92400e">âš ï¸ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡:</span>
  <span style="font-size:.82rem;color:#78350f">
    {{ stats.pending }} Ù…Ø¹ÙˆÙ‚ + {{ stats.debtor }} Ø¨Ø¯Ù‡Ú©Ø§Ø±
  </span>
  <form method="post" action="{% url 'payroll:send-reminder' %}"
        onsubmit="return confirm('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¨Ø¯Ù‡Ú©Ø§Ø± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')"
        style="margin-right:auto">
    {% csrf_token %}
    <input type="hidden" name="year"  value="{{ month.year }}">
    <input type="hidden" name="month" value="{{ month.month }}">
    <button type="submit" class="btn btn-amber btn-sm">
      ğŸ”” Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø±Ø§Ù†
    </button>
  </form>
</div>
{% endif %}

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.65rem 1rem;font-size:.85rem;margin-bottom:.45rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

<!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
<div class="grid-auto" style="margin-bottom:1.1rem">
  <div class="stat-card green">
    <div class="stat-label">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</div>
    <div class="stat-value">{{ stats.paid }}</div>
    <div class="stat-sub">{{ stats.total_collected|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">âœ…</span>
  </div>
  <div class="stat-card amber">
    <div class="stat-label">Ù…Ø¹ÙˆÙ‚</div>
    <div class="stat-value">{{ stats.pending }}</div>
    <div class="stat-sub">{{ stats.total_pending|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">â³</span>
  </div>
  <div class="stat-card red">
    <div class="stat-label">Ø¨Ø¯Ù‡Ú©Ø§Ø±</div>
    <div class="stat-value">{{ stats.debtor }}</div>
    <div class="stat-sub">ÙØ§Ú©ØªÙˆØ±</div>
    <span class="stat-icon">ğŸ”´</span>
  </div>
  <div class="stat-card teal">
    <div class="stat-label">Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</div>
    <div class="stat-value">{{ stats.pending_confirm }}</div>
    <div class="stat-sub">Ø±Ø³ÛŒØ¯ Ø¢Ù¾Ù„ÙˆØ¯Ø´Ø¯Ù‡</div>
    <span class="stat-icon">ğŸ“</span>
  </div>
</div>

<!-- ÙÛŒÙ„ØªØ± Ø¯Ø³ØªÙ‡ -->
<div class="card" style="margin-bottom:1rem;padding:.75rem 1rem">
  <form method="get" style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
    <input type="hidden" name="year"  value="{{ month.year }}">
    <input type="hidden" name="month" value="{{ month.month }}">
    <select name="category" style="padding:.4rem .65rem;border:1.5px solid var(--surface-2);border-radius:8px;font-size:.85rem;font-family:inherit">
      <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
      {% for cat in categories %}
      <option value="{{ cat.pk }}" {% if selected_cat and selected_cat.pk == cat.pk %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-outline btn-sm">ğŸ” ÙÛŒÙ„ØªØ±</button>
    {% if selected_cat %}
    <a href="?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">Ã— Ø­Ø°Ù ÙÛŒÙ„ØªØ±</a>
    {% endif %}
  </form>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ -->
{% if invoices %}
<div class="card">
  <div style="overflow-x:auto">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          {% if not selected_cat %}<th>Ø¯Ø³ØªÙ‡</th>{% endif %}
          <th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>
          <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø·Ø±ÛŒÙ‚</th>
          <th>Ø±Ø³ÛŒØ¯</th>
          {% if request.user.is_finance_manager %}<th>Ø§Ù‚Ø¯Ø§Ù…</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr style="{% if inv.status == 'pending_confirm' %}background:#fffbeb{% elif inv.status == 'paid' %}background:#f0fdf4{% elif inv.status == 'debtor' %}background:#fef2f2{% endif %}">
          <td style="font-size:.75rem;color:var(--text-muted)">{{ forloop.counter }}</td>
          {% if not selected_cat %}<td style="font-size:.82rem">{{ inv.category.name }}</td>{% endif %}
          <td>
            <div style="font-weight:700;font-size:.88rem">{{ inv.player.first_name }} {{ inv.player.last_name }}</div>
            {% if inv.player.phone %}<div style="font-size:.72rem;color:var(--text-muted);font-family:monospace">{{ inv.player.phone }}</div>{% endif %}
          </td>
          <td style="font-family:monospace;font-size:.9rem;font-weight:{% if inv.status != 'paid' %}700{% else %}400{% endif %}">
            {{ inv.final_amount|floatformat:0 }}
          </td>
          <td>
            {% if inv.status == 'paid' %}
              <span class="badge badge-green" style="font-size:.68rem">âœ… Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</span>
              {% if inv.confirmed_by %}<div style="font-size:.7rem;color:var(--text-muted)">ØªÙˆØ³Ø·: {{ inv.confirmed_by.get_full_name }}</div>{% endif %}
            {% elif inv.status == 'pending_confirm' %}
              <span class="badge badge-amber" style="font-size:.68rem">ğŸ“ Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>
            {% elif inv.status == 'debtor' %}
              <span class="badge badge-red" style="font-size:.68rem">ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
            {% else %}
              <span class="badge" style="background:#e5e7eb;color:#374151;font-size:.68rem">â³ Ù…Ø¹ÙˆÙ‚</span>
            {% endif %}
          </td>
          <td style="font-size:.78rem;color:var(--text-muted)">
            {% if inv.zarinpal_ref_id %}
              <span style="color:var(--green);font-family:monospace">ğŸ’³ {{ inv.zarinpal_ref_id|truncatechars:10 }}</span>
            {% elif inv.receipt_image %}
              Ø±Ø³ÛŒØ¯ Ú©Ø§Ø±Øª
            {% else %}â€”{% endif %}
          </td>
          <td>
            {% if inv.receipt_image %}
              <a href="{{ inv.receipt_image.url }}" target="_blank" class="btn btn-outline btn-sm" style="font-size:.7rem">ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
            {% else %}â€”{% endif %}
          </td>
          {% if request.user.is_finance_manager %}
          <td>
            <div style="display:flex;gap:.3rem;flex-wrap:wrap">
              {% if inv.status == 'pending_confirm' %}
              <form method="post" action="{% url 'payroll:invoice-confirm' inv.pk %}" style="margin:0">
                {% csrf_token %}
                <button class="btn btn-green btn-sm" style="font-size:.72rem;padding:.25rem .55rem"
                        onclick="return confirm('Ù¾Ø±Ø¯Ø§Ø®Øª {{ inv.player.first_name }} ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ')">
                  âœ… ØªØ£ÛŒÛŒØ¯
                </button>
              </form>
              {% endif %}
              {% if inv.status != 'paid' %}
              <form method="post" action="{% url 'payroll:invoice-status-update' inv.pk %}" style="margin:0;display:flex;gap:.2rem">
                {% csrf_token %}
                <input type="hidden" name="redirect_to" value="{% url 'payroll:player-payment-status' %}?year={{ month.year }}&month={{ month.month }}{% if selected_cat %}&category={{ selected_cat.pk }}{% endif %}">
                <select name="new_status" style="font-size:.72rem;border:1.5px solid var(--surface-2);border-radius:6px;padding:.25rem .4rem">
                  {% for val, label in status_choices %}
                  <option value="{{ val }}" {% if inv.status == val %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.25rem .4rem">Ø«Ø¨Øª</button>
              </form>
              {% if inv.player.user %}
              <form method="post" action="{% url 'payroll:send-reminder' %}" style="margin:0">
                {% csrf_token %}
                <input type="hidden" name="invoice_pk" value="{{ inv.pk }}">
                <button class="btn btn-amber btn-sm" style="font-size:.7rem;padding:.25rem .55rem"
                        onclick="return confirm('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ {{ inv.player.first_name }} Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')"
                        title="Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª">
                  ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ
                </button>
              </form>
              {% endif %}
              {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div style="text-align:center;padding:3rem;color:var(--text-muted)">
  <div style="font-size:2.5rem;margin-bottom:.5rem">ğŸ“‹</div>
  <p style="font-weight:700">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
  <p style="font-size:.82rem">
    {% if request.user.is_finance_manager %}
      Ø§Ø² <a href="{% url 'payroll:finance-dashboard' %}">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</a> ÙØ§Ú©ØªÙˆØ± ØµØ§Ø¯Ø± Ú©Ù†ÛŒØ¯.
    {% endif %}
  </p>
</div>
{% endif %}

{% endblock %}