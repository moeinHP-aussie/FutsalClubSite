{% extends "base.html" %}
{% block title %}Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†{% endblock %}
{% block nav_coach_payroll %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†</span>
{% endblock %}

{% block extra_head %}
<style>
.coach-card {
  background: var(--white);
  border: 1.5px solid var(--surface-2);
  border-radius: var(--radius);
  padding: 1.1rem 1.25rem;
  transition: box-shadow .15s, border-color .15s;
  cursor: pointer;
  position: relative;
}
.coach-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.08); }
.coach-card.selected {
  border-color: var(--amber);
  background: #fffbeb;
  box-shadow: 0 0 0 3px rgba(245,158,11,.12);
}
.coach-card.all-paid { border-color: #10b981; background: #f0fdf4; cursor: default; }
.status-badge {
  display: inline-flex; align-items: center; gap: .3rem;
  font-size: .72rem; font-weight: 700; padding: .2rem .6rem; border-radius: 99px;
}
.s-approved  { background: #dbeafe; color: #1e3a8a; }
.s-calculated{ background: #fef3c7; color: #92400e; }
.s-paid      { background: #d1fae5; color: #065f46; }
.salary-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: .3rem 0; font-size: .8rem; border-bottom: 1px dashed var(--surface-2);
}
.salary-row:last-child { border-bottom: none; }

/* sticky pay bar */
.pay-bar {
  position: sticky; bottom: 0; left: 0; right: 0;
  background: var(--navy); color: #fff;
  padding: .85rem 1.5rem;
  display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: .75rem;
  border-radius: var(--radius) var(--radius) 0 0;
  box-shadow: 0 -4px 20px rgba(0,0,0,.15);
  z-index: 100;
  margin-top: 1.5rem;
  transition: opacity .2s;
}
.pay-bar.hidden { opacity: 0; pointer-events: none; }
</style>
{% endblock %}

{% block content %}

<!-- Header + month nav -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.2rem;font-weight:900;color:var(--navy)">ğŸ§¾ Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø®Ù„Ø§ØµÙ‡ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒÚ©Ø¬Ø§</p>
  </div>
  <!-- Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù…Ø§Ù‡ -->
  <div style="display:flex;align-items:center;gap:.5rem">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}"
       class="btn btn-outline btn-sm">â† Ù…Ø§Ù‡ Ù‚Ø¨Ù„</a>
    <span style="font-size:.9rem;font-weight:800;color:var(--navy);padding:.35rem .75rem;
                 background:#f8fafc;border-radius:8px;border:1.5px solid var(--surface-2)">
      {{ month.year }}/{{ month.month|stringformat:"02d" }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}"
       class="btn btn-outline btn-sm">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â†’</a>
  </div>
</div>

<!-- Summary cards -->
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.85rem;margin-bottom:1.25rem">
  <div class="card" style="padding:.9rem 1.1rem;border-right:4px solid var(--navy)">
    <div style="font-size:.72rem;color:var(--text-muted);margin-bottom:.2rem">Ú©Ù„ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
    <div style="font-size:1.3rem;font-weight:900;color:var(--navy)">{{ grand_approved|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
  </div>
  <div class="card" style="padding:.9rem 1.1rem;border-right:4px solid #10b981">
    <div style="font-size:.72rem;color:var(--text-muted);margin-bottom:.2rem">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</div>
    <div style="font-size:1.3rem;font-weight:900;color:#10b981">{{ grand_paid|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
  </div>
  <div class="card" style="padding:.9rem 1.1rem;border-right:4px solid var(--amber)">
    <div style="font-size:.72rem;color:var(--text-muted);margin-bottom:.2rem">Ø¬Ù…Ø¹ Ú©Ù„ Ø§ÛŒÙ† Ù…Ø§Ù‡</div>
    <div style="font-size:1.3rem;font-weight:900;color:var(--amber)">{{ grand_total|floatformat:0 }} Ø±ÛŒØ§Ù„</div>
  </div>
</div>

{% if coaches %}

<!-- Select all toolbar -->
{% if any_payable %}
<div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.75rem">
  <label style="display:flex;align-items:center;gap:.4rem;cursor:pointer;font-size:.85rem;font-weight:700">
    <input type="checkbox" id="select-all-cb" onclick="toggleSelectAll(this)"
           style="accent-color:var(--navy);width:16px;height:16px">
    Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡ (Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª)
  </label>
  <span style="font-size:.78rem;color:var(--text-muted)" id="sel-info"></span>
</div>
{% endif %}

<!-- Coach cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1rem;margin-bottom:5rem">
  {% for entry in coaches %}
  <div class="coach-card {% if entry.all_paid %}all-paid{% endif %}"
       id="cc-{{ entry.coach.pk }}"
       data-id="{{ entry.coach.pk }}"
       data-payable="{{ entry.can_pay|yesno:'1,0' }}"
       data-amount="{{ entry.approved }}"
       onclick="toggleCoach(this)">

    <!-- checkbox indicator -->
    {% if entry.can_pay %}
    <div style="position:absolute;top:.75rem;left:.85rem">
      <div class="cc-check" style="width:20px;height:20px;border-radius:50%;
           border:2px solid var(--surface-2);background:#fff;
           display:flex;align-items:center;justify-content:center;
           font-size:.7rem;font-weight:900;transition:.1s">
      </div>
    </div>
    {% endif %}

    <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.75rem">
      <div style="width:40px;height:40px;border-radius:50%;
           background:linear-gradient(135deg,var(--navy),var(--teal));
           color:#fff;display:flex;align-items:center;justify-content:center;
           font-weight:900;font-size:.85rem;flex-shrink:0">
        {{ entry.coach.first_name|slice:":1" }}{{ entry.coach.last_name|slice:":1" }}
      </div>
      <div style="flex:1">
        <div style="font-weight:800;font-size:.9rem;color:var(--navy)">
          {{ entry.coach.first_name }} {{ entry.coach.last_name }}
        </div>
        {% if entry.coach.bank_card_number %}
        <div style="font-size:.72rem;color:var(--text-muted);font-family:monospace">
          ğŸ’³ ****-{{ entry.coach.bank_card_number|slice:"-4:" }}
        </div>
        {% endif %}
      </div>
      {% if entry.all_paid %}
        <span class="status-badge s-paid">âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
      {% elif entry.can_pay %}
        <span class="status-badge s-approved">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</span>
      {% else %}
        <span class="status-badge s-calculated">ğŸ”¢ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯</span>
      {% endif %}
    </div>

    <!-- Ø¬Ø²Ø¦ÛŒØ§Øª Ø­Ù‚ÙˆÙ‚ Ù‡Ø± Ø¯Ø³ØªÙ‡ -->
    <div style="border:1px solid var(--surface-2);border-radius:8px;overflow:hidden;margin-bottom:.75rem">
      {% for salary in entry.salaries %}
      <div class="salary-row" style="padding:.4rem .75rem">
        <span style="color:var(--text-muted)">{{ salary.category.name }}</span>
        <div style="display:flex;align-items:center;gap:.5rem">
          <span class="status-badge {% if salary.status == 'approved' %}s-approved{% elif salary.status == 'paid' %}s-paid{% else %}s-calculated{% endif %}">
            {% if salary.status == 'approved' %}ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡{% elif salary.status == 'paid' %}Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡{% else %}Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡{% endif %}
          </span>
          <span style="font-weight:700;font-size:.82rem">{{ salary.final_amount|floatformat:0 }}</span>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Ù…Ø¬Ù…ÙˆØ¹ -->
    <div style="display:flex;justify-content:space-between;align-items:center">
      <span style="font-size:.78rem;color:var(--text-muted)">Ø¬Ù…Ø¹ Ø§ÛŒÙ† Ù…Ø§Ù‡</span>
      <span style="font-size:1.05rem;font-weight:900;color:{% if entry.all_paid %}#10b981{% else %}var(--navy){% endif %}">
        {{ entry.total|floatformat:0 }} Ø±ÛŒØ§Ù„
      </span>
    </div>
    {% if entry.approved > 0 %}
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.25rem">
      <span style="font-size:.75rem;color:#1e3a8a">Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù„Ø§Ù†</span>
      <span style="font-size:.9rem;font-weight:800;color:#1d4ed8">{{ entry.approved|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- Sticky pay bar -->
<div class="pay-bar hidden" id="pay-bar">
  <div>
    <div style="font-size:.78rem;opacity:.7">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
    <div style="font-size:1.2rem;font-weight:900" id="pay-total-lbl">Û° Ø±ÛŒØ§Ù„</div>
  </div>
  <div style="display:flex;gap:.6rem;align-items:center">
    <span style="font-size:.82rem;opacity:.8" id="pay-count-lbl"></span>
    <button class="btn btn-amber" onclick="openPayModal()">ğŸ’¸ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡â€ŒÙ‡Ø§</button>
  </div>
</div>

{% else %}
<div class="card" style="text-align:center;padding:3rem">
  <div style="font-size:3rem;margin-bottom:1rem">ğŸ§¾</div>
  <h3 style="font-weight:800;margin-bottom:.5rem">Ø­Ù‚ÙˆÙ‚ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
  <p style="color:var(--text-muted);font-size:.875rem">
    Ø§Ø¨ØªØ¯Ø§ Ø§Ø² Ø¨Ø®Ø´ Â«Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†Â» Ø­Ù‚ÙˆÙ‚ Ø±Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.
  </p>
  <a href="{% url 'payroll:finance-dashboard' %}" class="btn btn-navy" style="margin-top:1rem">
    â†’ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ
  </a>
</div>
{% endif %}

<!-- Pay confirmation modal -->
<div id="pay-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:.75rem">ğŸ’¸ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div id="modal-coach-list" style="max-height:200px;overflow-y:auto;margin-bottom:1.25rem;
         border:1px solid var(--surface-2);border-radius:8px;padding:.5rem .75rem"></div>
    <div style="background:#d1fae5;border-radius:8px;padding:.65rem .85rem;margin-bottom:1.25rem">
      <div style="font-size:.75rem;color:#065f46;margin-bottom:.15rem">Ø¬Ù…Ø¹ Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</div>
      <div style="font-size:1.2rem;font-weight:900;color:#065f46" id="modal-total"></div>
    </div>
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:1.25rem">
      âš¡ Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ØŒ Ø§Ø¹Ù„Ø§Ù† Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ø±Ø¨ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closePayModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-amber" id="pay-confirm-btn" onclick="confirmPay()">ğŸ’¸ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const PAY_URL = "{% url 'payroll:coach-payroll-pay' %}";
const CSRF    = "{{ csrf_token }}";
const YEAR    = {{ month.year }};
const MONTH   = {{ month.month }};

let selected = new Set();

function toggleCoach(card) {
  const id      = parseInt(card.dataset.id);
  const payable = card.dataset.payable === "1";
  if (!payable) return;

  if (selected.has(id)) {
    selected.delete(id);
    card.classList.remove("selected");
    card.querySelector(".cc-check").textContent = "";
    card.querySelector(".cc-check").style.borderColor = "var(--surface-2)";
    card.querySelector(".cc-check").style.background  = "#fff";
  } else {
    selected.add(id);
    card.classList.add("selected");
    card.querySelector(".cc-check").textContent = "âœ“";
    card.querySelector(".cc-check").style.borderColor = "var(--amber)";
    card.querySelector(".cc-check").style.background  = "var(--amber)";
    card.querySelector(".cc-check").style.color = "#fff";
  }
  updatePayBar();
}

function toggleSelectAll(cb) {
  document.querySelectorAll(".coach-card[data-payable='1']").forEach(card => {
    const id = parseInt(card.dataset.id);
    if (cb.checked) {
      selected.add(id);
      card.classList.add("selected");
      if (card.querySelector(".cc-check")) {
        card.querySelector(".cc-check").textContent = "âœ“";
        card.querySelector(".cc-check").style.cssText += ";border-color:var(--amber);background:var(--amber);color:#fff";
      }
    } else {
      selected.delete(id);
      card.classList.remove("selected");
      if (card.querySelector(".cc-check")) {
        card.querySelector(".cc-check").textContent = "";
        card.querySelector(".cc-check").style.cssText += ";border-color:var(--surface-2);background:#fff";
      }
    }
  });
  updatePayBar();
}

function updatePayBar() {
  const bar = document.getElementById("pay-bar");
  if (selected.size === 0) { bar.classList.add("hidden"); return; }
  bar.classList.remove("hidden");

  let total = 0;
  selected.forEach(id => {
    const card = document.getElementById("cc-" + id);
    if (card) total += parseInt(card.dataset.amount || 0);
  });

  document.getElementById("pay-total-lbl").textContent = total.toLocaleString("fa-IR") + " Ø±ÛŒØ§Ù„";
  document.getElementById("pay-count-lbl").textContent = selected.size + " Ù…Ø±Ø¨ÛŒ";
  const info = document.getElementById("sel-info");
  if (info) info.textContent = `(${selected.size} Ù…Ø±Ø¨ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡)`;
}

function openPayModal() {
  if (selected.size === 0) return;
  let total = 0;
  let listHTML = "";
  selected.forEach(id => {
    const card = document.getElementById("cc-" + id);
    if (!card) return;
    const name = card.querySelector("[style*='font-weight:800']")?.textContent?.trim() || "";
    const amt  = parseInt(card.dataset.amount || 0);
    total += amt;
    listHTML += `<div style="display:flex;justify-content:space-between;padding:.35rem 0;font-size:.85rem;border-bottom:1px solid var(--surface-2)">
      <span>${name}</span><span style="font-weight:700">${amt.toLocaleString("fa-IR")} Ø±ÛŒØ§Ù„</span></div>`;
  });
  document.getElementById("modal-desc").textContent   = `Ø­Ù‚ÙˆÙ‚ ${selected.size} Ù…Ø±Ø¨ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯:`;
  document.getElementById("modal-coach-list").innerHTML = listHTML;
  document.getElementById("modal-total").textContent  = total.toLocaleString("fa-IR") + " Ø±ÛŒØ§Ù„";
  document.getElementById("pay-modal").style.display  = "flex";
}
function closePayModal() { document.getElementById("pay-modal").style.display = "none"; }

async function confirmPay() {
  const btn = document.getElementById("pay-confirm-btn");
  btn.disabled    = true;
  btn.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª...";

  try {
    const res  = await fetch(PAY_URL, {
      method:  "POST",
      headers: { "Content-Type":"application/json","X-CSRFToken":CSRF },
      body:    JSON.stringify({ coach_ids: [...selected], year: YEAR, month: MONTH }),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    closePayModal();
    // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª Ùˆ reload
    selected.forEach(id => {
      const card = document.getElementById("cc-" + id);
      if (card) {
        card.classList.remove("selected");
        card.classList.add("all-paid");
        card.dataset.payable = "0";
        const badge = card.querySelector(".status-badge");
        if (badge) { badge.className = "status-badge s-paid"; badge.textContent = "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡"; }
      }
    });
    selected.clear();
    document.getElementById("pay-bar").classList.add("hidden");

    showToast(`âœ… Ø­Ù‚ÙˆÙ‚ ${data.paid_count} Ù…Ø±Ø¨ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯`, "ok");
    setTimeout(() => location.reload(), 1800);
  } catch (err) {
    showToast("âŒ " + err.message, "err");
    btn.disabled    = false;
    btn.textContent = "ğŸ’¸ ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª";
  }
}

function showToast(msg, type) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);
    background:${type==="ok"?"#10b981":"#ef4444"};color:#fff;
    padding:.65rem 1.35rem;border-radius:99px;font-size:.85rem;font-weight:700;
    z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);white-space:nowrap`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}
</script>
{% endblock %}