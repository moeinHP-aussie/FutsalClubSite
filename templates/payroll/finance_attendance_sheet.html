{% extends "base.html" %}
{% block title %}Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ + Ø´Ù‡Ø±ÛŒÙ‡ â€” {{ category.name }}{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:tuition-categories' %}?year={{ month.year }}&month={{ month.month }}" style="text-decoration:none;color:inherit">Ø´Ù‡Ø±ÛŒÙ‡</a>
  <span class="sep">â€º</span><span class="cur">{{ category.name }}</span>
{% endblock %}

{% block extra_head %}
<style>
.att-table { border-collapse:collapse; min-width:100%; }
.att-table th, .att-table td { border:1px solid var(--surface-2); padding:.35rem .5rem; font-size:.78rem; white-space:nowrap; }
.att-table thead th { background:var(--surface-1); font-weight:700; text-align:center; }
.att-table .sticky-col { position:sticky; right:0; background:#fff; z-index:1; border-left:2px solid var(--surface-2); min-width:140px; text-align:right; padding-right:.75rem; }
.att-table thead .sticky-col { background:var(--surface-1); }
.att-p  { background:#dcfce7; color:#15803d; text-align:center; font-size:.75rem; font-weight:700; }
.att-a  { background:#fee2e2; color:#991b1b; text-align:center; font-size:.75rem; }
.att-e  { background:#fef9c3; color:#92400e; text-align:center; font-size:.75rem; }
.att-n  { background:var(--surface-1); text-align:center; color:var(--text-muted); font-size:.72rem; }
.pay-paid    { background:#d1fae5; color:#065f46; }
.pay-pending { background:#fef3c7; color:#92400e; }
.pay-debtor  { background:#fee2e2; color:#991b1b; }
.pay-confirm { background:#dbeafe; color:#1e3a8a; }
.pay-none    { background:var(--surface-1); color:var(--text-muted); }
</style>
{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“‹ {{ category.name }} â€” Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ + Ø´Ù‡Ø±ÛŒÙ‡</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">
      {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}
      {% if sheet %} | {{ sessions|length }} Ø¬Ù„Ø³Ù‡{% endif %}
      <span style="background:#dbeafe;color:#1e3a8a;border-radius:6px;font-size:.7rem;padding:.15rem .45rem;font-weight:700;margin-right:.5rem">ğŸ‘ï¸ ÙÙ‚Ø·â€ŒØ®ÙˆØ§Ù†Ø¯Ù†ÛŒ</span>
    </p>
  </div>
  <div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„</a>
    <span style="font-weight:800;font-size:.88rem;background:var(--surface-1);padding:.3rem .65rem;border-radius:6px">
      {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ â†’</a>
    <a href="{% url 'payroll:invoice-list' category.pk %}?year={{ month.year }}&month={{ month.month }}"
       class="btn btn-navy btn-sm">ğŸ§¾ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</a>
    <a href="{% url 'payroll:tuition-categories' %}?year={{ month.year }}&month={{ month.month }}"
       class="btn btn-outline btn-sm">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
  </div>
</div>

{% if not sheet %}
<div class="card" style="text-align:center;padding:2.5rem">
  <div style="font-size:2.5rem;margin-bottom:.75rem">ğŸ“‹</div>
  <h3 style="font-weight:800;margin-bottom:.5rem">Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h3>
  <p style="font-size:.85rem;color:var(--text-muted)">
    Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ø¯Ø± Ù…Ø§Ù‡ {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }} Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
  </p>
</div>
{% elif not sessions %}
<div class="card" style="text-align:center;padding:2rem;color:var(--text-muted)">
  <p>Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ø§Ù…Ø§ Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</p>
</div>
{% else %}

<!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem;font-size:.75rem;align-items:center">
  <span style="font-weight:700;color:var(--text-muted)">Ø­Ø¶ÙˆØ±:</span>
  <span class="att-p" style="padding:.2rem .5rem;border-radius:4px">âœ… Ø­Ø§Ø¶Ø±</span>
  <span class="att-a" style="padding:.2rem .5rem;border-radius:4px">âŒ ØºØ§ÛŒØ¨</span>
  <span class="att-e" style="padding:.2rem .5rem;border-radius:4px">âš ï¸ Ù…ÙˆØ¬Ù‡</span>
  <span style="margin-right:.75rem;font-weight:700;color:var(--text-muted)">Ø´Ù‡Ø±ÛŒÙ‡:</span>
  <span class="pay-paid" style="padding:.2rem .5rem;border-radius:4px">âœ… Ù¾Ø±Ø¯Ø§Ø®Øª</span>
  <span class="pay-confirm" style="padding:.2rem .5rem;border-radius:4px">ğŸ“ Ø±Ø³ÛŒØ¯</span>
  <span class="pay-pending" style="padding:.2rem .5rem;border-radius:4px">â³ Ù…Ø¹ÙˆÙ‚</span>
  <span class="pay-debtor" style="padding:.2rem .5rem;border-radius:4px">ğŸ”´ Ø¨Ø¯Ù‡Ú©Ø§Ø±</span>
</div>

<div class="card" style="padding:0;overflow:hidden">
  <div style="overflow-x:auto">
    <table class="att-table">
      <thead>
        <tr>
          <th class="sticky-col">Ø¨Ø§Ø²ÛŒÚ©Ù†</th>
          {% for session in sessions %}
          <th style="text-align:center;min-width:52px" title="{{ session.date }}">
            <div>Ø¬{{ session.session_number }}</div>
            <div style="font-size:.65rem;font-weight:400;color:var(--text-muted)">{{ session.date }}</div>
          </th>
          {% endfor %}
          <th style="min-width:80px;text-align:center">Ø­Ø§Ø¶Ø±/Ú©Ù„</th>
          <th style="min-width:95px;text-align:center">Ø´Ù‡Ø±ÛŒÙ‡</th>
          {% if request.user.is_finance_manager %}<th style="min-width:70px;text-align:center">Ø§Ù‚Ø¯Ø§Ù…</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td class="sticky-col">
            <div style="font-weight:700;font-size:.85rem">{{ row.player.first_name }} {{ row.player.last_name }}</div>
            {% if row.player.phone %}<div style="font-size:.68rem;color:var(--text-muted)">{{ row.player.phone }}</div>{% endif %}
          </td>
          {% for att in row.att_row %}
          {% if att == 'present' %}
          <td class="att-p">âœ…</td>
          {% elif att == 'absent' %}
          <td class="att-a">âŒ</td>
          {% elif att == 'excused' %}
          <td class="att-e">âš ï¸</td>
          {% else %}
          <td class="att-n">â€”</td>
          {% endif %}
          {% endfor %}
          <!-- Ø®Ù„Ø§ØµÙ‡ Ø­Ø¶ÙˆØ± -->
          <td style="text-align:center;font-size:.8rem">
            <span style="font-weight:700;color:var(--green)">{{ row.present_count }}</span>
            <span style="color:var(--text-muted)">/{{ sessions|length }}</span>
            {% if row.absent_count > 0 %}
            <span style="font-size:.68rem;color:var(--red)"> ({{ row.absent_count }} Øº)</span>
            {% endif %}
          </td>
          <!-- ÙˆØ¶Ø¹ÛŒØª Ø´Ù‡Ø±ÛŒÙ‡ -->
          <td class="{% if row.invoice %}{% if row.invoice.status == 'paid' %}pay-paid{% elif row.invoice.status == 'pending_confirm' %}pay-confirm{% elif row.invoice.status == 'debtor' %}pay-debtor{% else %}pay-pending{% endif %}{% else %}pay-none{% endif %}"
              style="text-align:center;font-size:.78rem">
            {% if row.invoice %}
              {% if row.invoice.status == 'paid' %}âœ…{% elif row.invoice.status == 'pending_confirm' %}ğŸ“{% elif row.invoice.status == 'debtor' %}ğŸ”´{% else %}â³{% endif %}
              <div style="font-size:.68rem;font-family:monospace;margin-top:.1rem">{{ row.invoice.final_amount|floatformat:0 }}</div>
            {% else %}â€”{% endif %}
          </td>
          {% if request.user.is_finance_manager %}
          <td style="text-align:center">
            {% if row.invoice and row.invoice.status == 'pending_confirm' %}
            <a href="{% url 'payroll:invoice-list' category.pk %}?year={{ month.year }}&month={{ month.month }}&status=pending_confirm"
               class="btn btn-amber btn-sm" style="font-size:.68rem;padding:.2rem .45rem">Ø¨Ø±Ø±Ø³ÛŒ</a>
            {% elif row.invoice and row.invoice.status != 'paid' and row.invoice.player.user %}
            <form method="post" action="{% url 'payroll:send-reminder' %}" style="margin:0"
                  onsubmit="return confirm('ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯ØŸ')">
              {% csrf_token %}
              <input type="hidden" name="invoice_pk" value="{{ row.invoice.pk }}">
              <button class="btn btn-outline btn-sm" style="font-size:.68rem;padding:.2rem .45rem"
                      title="Ø§Ø±Ø³Ø§Ù„ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ">ğŸ””</button>
            </form>
            {% else %}â€”{% endif %}
          </td>
          {% endif %}
        </tr>
        {% empty %}
        <tr>
          <td colspan="{{ sessions|length|add:4 }}" style="text-align:center;padding:2rem;color:var(--text-muted)">
            Ù‡ÛŒÚ† Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <!-- Ø®Ù„Ø§ØµÙ‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ -->
      {% if rows %}
      <tfoot>
        <tr style="background:var(--surface-1);font-weight:700">
          <td class="sticky-col" style="font-size:.78rem">Ø¬Ù…Ø¹ Ø­Ø§Ø¶Ø±Ø§Ù†</td>
          {% for session in sessions %}
          <td style="text-align:center;font-size:.78rem;color:var(--green)">
            {{ session.player_records.count }}
          </td>
          {% endfor %}
          <td colspan="{% if request.user.is_finance_manager %}3{% else %}2{% endif %}"></td>
        </tr>
      </tfoot>
      {% endif %}
    </table>
  </div>
</div>

{% if coach_rows %}
<!-- Ø­Ø¶ÙˆØ± Ù…Ø±Ø¨ÛŒØ§Ù† -->
<div class="card" style="margin-top:1rem">
  <div class="card-header"><span class="card-title">ğŸ‘¨â€ğŸ« Ø­Ø¶ÙˆØ± Ù…Ø±Ø¨ÛŒØ§Ù†</span></div>
  <div style="overflow-x:auto">
    <table class="att-table">
      <thead>
        <tr>
          <th class="sticky-col">Ù…Ø±Ø¨ÛŒ</th>
          {% for session in sessions %}
          <th style="text-align:center;min-width:46px" title="{{ session.date }}">Ø¬{{ session.session_number }}</th>
          {% endfor %}
          <th style="text-align:center">Ø­Ø§Ø¶Ø±/Ú©Ù„</th>
        </tr>
      </thead>
      <tbody>
        {% for crow in coach_rows %}
        <tr>
          <td class="sticky-col">{{ crow.coach.first_name }} {{ crow.coach.last_name }}</td>
          {% for att in crow.att_row %}
            {% if att == 'present' %}<td class="att-p">âœ…</td>
            {% elif att == 'absent' %}<td class="att-a">âŒ</td>
            {% elif att == 'excused' %}<td class="att-e">âš ï¸</td>
            {% else %}<td class="att-n">â€”</td>
            {% endif %}
          {% endfor %}
          <td style="text-align:center;font-size:.8rem">
            <span style="font-weight:700;color:var(--green)">{{ crow.present_count }}</span>
            <span style="color:var(--text-muted)">/{{ sessions|length }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% endif %}
{% endblock %}