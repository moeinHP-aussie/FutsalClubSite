{% extends "base.html" %}
{% block title %}Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ â€” {{ category.name }}{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:salary-list' category.pk %}?year={{ month.year }}&month={{ month.month }}" style="text-decoration:none;color:inherit">Ø­Ù‚ÙˆÙ‚ {{ category.name }}</a>
  <span class="sep">â€º</span><span class="cur">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ</span>
{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">âš¡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ Ù‡Ù…Ù‡ Ù…Ø±Ø¨ÛŒØ§Ù† â€” {{ category.name }}</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ù…Ø§Ù‡: {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}</p>
  </div>
  <div style="display:flex;gap:.5rem;align-items:center">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† Ù…Ø§Ù‡ Ù‚Ø¨Ù„</a>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ â†’</a>
    <a href="{% url 'payroll:salary-list' category.pk %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">â† Ø¨Ø§Ø²Ú¯Ø´Øª</a>
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.65rem 1rem;font-size:.85rem;margin-bottom:.45rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

{% if breakdowns %}
<form method="post">
  {% csrf_token %}
  <input type="hidden" name="year"  value="{{ month.year }}">
  <input type="hidden" name="month" value="{{ month.month }}">

  <div class="card" style="margin-bottom:1rem">
    <div style="overflow-x:auto">
      <table class="table">
        <thead>
          <tr>
            <th>Ù…Ø±Ø¨ÛŒ</th>
            <th>Ø¬Ù„Ø³Ø§Øª Ú©Ù„</th>
            <th>Ø­Ø§Ø¶Ø±</th>
            <th>ØºØ§ÛŒØ¨</th>
            <th>Ù†Ø±Ø®/Ø¬Ù„Ø³Ù‡</th>
            <th>Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡</th>
            <th>ØªØ¹Ø¯ÛŒÙ„ Ø¯Ø³ØªÛŒ</th>
            <th>Ø¯Ù„ÛŒÙ„ ØªØ¹Ø¯ÛŒÙ„</th>
            <th>Ù†Ù‡Ø§ÛŒÛŒ</th>
          </tr>
        </thead>
        <tbody>
          {% for bd in breakdowns %}
          <tr>
            <td>
              <strong style="font-size:.88rem">{{ bd.coach.first_name }} {{ bd.coach.last_name }}</strong>
              {% if bd.existing_salary %}
              <div style="font-size:.7rem;color:var(--amber)">âš ï¸ Ù‚Ø¨Ù„Ø§Ù‹ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</div>
              {% endif %}
            </td>
            <td style="text-align:center">{{ bd.sessions_total }}</td>
            <td style="text-align:center;color:var(--green);font-weight:700">{{ bd.sessions_attended }}</td>
            <td style="text-align:center;color:var(--red)">{{ bd.sessions_absent }}</td>
            <td style="font-family:monospace;font-size:.85rem">{{ bd.session_rate|floatformat:0 }}</td>
            <td style="font-family:monospace;font-size:.85rem;font-weight:700">{{ bd.base_amount|floatformat:0 }}</td>
            <td style="width:130px">
              <input type="number" name="adjustment_{{ bd.coach.pk }}"
                     value="0" step="10000"
                     class="fi" style="font-family:monospace;font-size:.82rem;text-align:center"
                     placeholder="Â±Ø±ÛŒØ§Ù„">
            </td>
            <td style="width:160px">
              <input type="text" name="reason_{{ bd.coach.pk }}"
                     class="fi" style="font-size:.78rem" placeholder="Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            </td>
            <td style="font-family:monospace;font-size:.9rem;font-weight:700;color:var(--navy)">
              <span id="final_{{ bd.coach.pk }}">{{ bd.final_amount|floatformat:0 }}</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr style="background:var(--surface-1)">
            <td colspan="5" style="text-align:left;font-weight:700;font-size:.85rem">Ø¬Ù…Ø¹ Ú©Ù„:</td>
            <td colspan="3" style="font-family:monospace;font-weight:900;color:var(--navy)">{{ total|floatformat:0 }} Ø±ÛŒØ§Ù„</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div style="display:flex;gap:.75rem;justify-content:flex-end">
    <a href="{% url 'payroll:salary-list' category.pk %}?year={{ month.year }}&month={{ month.month }}" class="btn btn-outline btn-sm">Ø§Ù†ØµØ±Ø§Ù</a>
    <button type="submit" class="btn btn-navy btn-sm"
            onclick="return confirm('Ø­Ù‚ÙˆÙ‚ ØªÙ…Ø§Ù… Ù…Ø±Ø¨ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯ØŸ')">
      ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø­Ù‚ÙˆÙ‚ Ù‡Ù…Ù‡ Ù…Ø±Ø¨ÛŒØ§Ù†
    </button>
  </div>
</form>
{% else %}
<div style="text-align:center;padding:3rem;color:var(--text-muted)">
  <div style="font-size:2.5rem;margin-bottom:.5rem">âš ï¸</div>
  <p style="font-weight:700">Ø§Ù…Ú©Ø§Ù† Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
  <p style="font-size:.85rem">
    Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒØ§Ù† ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
  </p>
  <a href="{% url 'payroll:coach-rate-manage' %}" class="btn btn-amber btn-sm" style="margin-top:.75rem">âš™ï¸ ØªØ¹ÛŒÛŒÙ† Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒØ§Ù†</a>
</div>
{% endif %}

<style>
.fi { width:100%; padding:.35rem .55rem; border:1.5px solid var(--surface-2); border-radius:7px; font-family:inherit; box-sizing:border-box; }
.fi:focus { outline:none; border-color:var(--navy); }
</style>
{% endblock %}