{% extends "base.html" %}
{% block title %}ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø§Ù„ÛŒ Ù…Ù†{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span><span class="cur">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø§Ù„ÛŒ</span>
{% endblock %}

{% block extra_head %}
<style>
.receipt-thumb { width:48px; height:48px; border-radius:6px; object-fit:cover; border:1px solid var(--surface-2); cursor:zoom-in; }
#lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;place-items:center;cursor:zoom-out}
#lb.on{display:grid}
</style>
{% endblock %}

{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“Š ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø§Ù„ÛŒ Ù…Ù†</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§Ù„ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§</p>
  </div>
</div>

<!-- Ø®Ù„Ø§ØµÙ‡ Ú©Ù„ÛŒ -->
<div class="grid-auto" style="margin-bottom:1.25rem">
  {% if pending_invoices %}
  <div class="stat-card amber">
    <div class="stat-label">Ø´Ù‡Ø±ÛŒÙ‡ Ù…Ø¹ÙˆÙ‚</div>
    <div class="stat-value">{{ pending_invoices|length }}</div>
    <div class="stat-sub">ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª</div>
    <span class="stat-icon">âš ï¸</span>
  </div>
  {% endif %}
  {% if pending_salary_count > 0 %}
  <div class="stat-card red">
    <div class="stat-label">Ø­Ù‚ÙˆÙ‚ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</div>
    <div class="stat-value">{{ pending_salary_count }}</div>
    <div class="stat-sub">ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡</div>
    <span class="stat-icon">ğŸ’°</span>
  </div>
  {% endif %}
  <div class="stat-card navy">
    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</div>
    <div class="stat-value" style="font-size:1rem">{{ total_debit|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">ğŸ’¸</span>
  </div>
  {% if total_credit > 0 %}
  <div class="stat-card green">
    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØªâ€ŒÙ‡Ø§</div>
    <div class="stat-value" style="font-size:1rem">{{ total_credit|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">ğŸ’°</span>
  </div>
  {% endif %}
</div>

<!-- Ø´Ù‡Ø±ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚ (Ø¨Ø§Ø²ÛŒÚ©Ù†) -->
{% if pending_invoices %}
<div class="card" style="margin-bottom:1rem;border:2px solid var(--amber)">
  <div class="card-header" style="background:#fffbeb">
    <span class="card-title">âš ï¸ Ø´Ù‡Ø±ÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚</span>
  </div>
  <div style="padding:.6rem 1rem">
    {% for inv in pending_invoices %}
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--surface-2)">
      <div>
        <strong style="font-size:.875rem">{{ inv.jalali_year }}/{{ inv.jalali_month|stringformat:"02d" }}</strong>
        <span style="font-size:.78rem;color:var(--text-muted);margin-right:.5rem">{{ inv.category.name }}</span>
      </div>
      <div style="display:flex;align-items:center;gap:.75rem">
        <span style="font-size:.875rem;font-weight:700">{{ inv.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        <span class="badge {% if inv.status == 'debtor' %}badge-red{% else %}badge-amber{% endif %}" style="font-size:.68rem">
          {{ inv.get_status_display }}
        </span>
        <a href="{% url 'payroll:player-invoices' %}" class="btn btn-green btn-sm" style="font-size:.72rem">Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Ø­Ù‚ÙˆÙ‚ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ (Ù…Ø±Ø¨ÛŒ) -->
{% if pending_salaries %}
<div class="card" style="margin-bottom:1rem;border:2px solid #fbbf24">
  <div class="card-header" style="background:#fffbeb">
    <span class="card-title" style="color:#92400e">â³ Ø­Ù‚ÙˆÙ‚ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§</span>
  </div>
  <div style="padding:.6rem 1rem">
    {% for sal in pending_salaries %}
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.7rem 0;border-bottom:1px solid var(--surface-2)">
      <div style="display:flex;align-items:center;gap:.75rem">
        {% if sal.bank_receipt %}
        <img src="{{ sal.bank_receipt.url }}" class="receipt-thumb"
             onclick="openLB('{{ sal.bank_receipt.url }}')" alt="ÙÛŒØ´ Ø­Ù‚ÙˆÙ‚">
        {% else %}
        <div style="width:48px;height:48px;border-radius:6px;background:var(--surface-2);display:flex;align-items:center;justify-content:center;font-size:1.2rem">ğŸ“</div>
        {% endif %}
        <div>
          <div style="font-weight:700;font-size:.88rem">{{ sal.category.name }}</div>
          <div style="font-size:.75rem;color:var(--text-muted)">
            {{ sal.attendance_sheet.jalali_year }}/{% if sal.attendance_sheet.jalali_month < 10 %}0{% endif %}{{ sal.attendance_sheet.jalali_month }}
            â€” {{ sal.sessions_attended }} Ø¬Ù„Ø³Ù‡
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:.65rem">
        <span style="font-family:monospace;font-weight:800;font-size:.9rem">{{ sal.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        <a href="{% url 'payroll:coach-confirm-salary' sal.pk %}" class="btn btn-green btn-sm" style="font-size:.78rem">
          âœ… Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ£ÛŒÛŒØ¯
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ -->
{% if pending_staff_invoices %}
<div class="card" style="margin-bottom:1rem;border:2px solid #a78bfa">
  <div class="card-header" style="background:#f5f3ff">
    <span class="card-title" style="color:#5b21b6">â³ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>
  </div>
  <div style="padding:.6rem 1rem">
    {% for inv in pending_staff_invoices %}
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.7rem 0;border-bottom:1px solid var(--surface-2)">
      <div style="display:flex;align-items:center;gap:.75rem">
        {% if inv.bank_receipt %}
        <img src="{{ inv.bank_receipt.url }}" class="receipt-thumb"
             onclick="openLB('{{ inv.bank_receipt.url }}')" alt="ÙÛŒØ´ ÙØ§Ú©ØªÙˆØ±">
        {% else %}
        <div style="width:48px;height:48px;border-radius:6px;background:var(--surface-2);display:flex;align-items:center;justify-content:center;font-size:1.2rem">ğŸ“„</div>
        {% endif %}
        <div>
          <div style="font-weight:700;font-size:.88rem">{{ inv.title }}</div>
          <div style="font-size:.75rem;color:var(--text-muted)">{{ inv.created_at|date:"Y/m/d" }}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:.65rem">
        <span style="font-family:monospace;font-weight:800;font-size:.9rem">{{ inv.amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        <a href="{% url 'payroll:staff-invoice-confirm' inv.pk %}" class="btn btn-green btn-sm" style="font-size:.78rem">
          âœ… Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ£ÛŒÛŒØ¯
        </a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡ -->
{% if confirmed_salaries or confirmed_staff_invoices %}
<div class="card" style="margin-bottom:1rem">
  <div class="card-header"><span class="card-title">âœ… ÙÛŒØ´â€ŒÙ‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span></div>
  <div style="padding:.6rem 1rem">
    {% for sal in confirmed_salaries %}
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--surface-2)">
      <div>
        <strong style="font-size:.88rem">Ø­Ù‚ÙˆÙ‚ {{ sal.category.name }}</strong>
        <span style="font-size:.75rem;color:var(--text-muted);margin-right:.5rem">
          {{ sal.attendance_sheet.jalali_year }}/{% if sal.attendance_sheet.jalali_month < 10 %}0{% endif %}{{ sal.attendance_sheet.jalali_month }}
        </span>
        <span style="background:#d1fae5;color:#065f46;border-radius:6px;font-size:.65rem;padding:.15rem .45rem;font-weight:700">âœ… ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
      </div>
      <div style="display:flex;align-items:center;gap:.65rem">
        <span style="font-family:monospace;font-weight:700">{{ sal.final_amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        {% if sal.bank_receipt %}
        <button type="button" class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .5rem"
                onclick="openLB('{{ sal.bank_receipt.url }}')">ğŸ“ ÙÛŒØ´</button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% for inv in confirmed_staff_invoices %}
    <div style="display:flex;align-items:center;justify-content:space-between;padding:.55rem 0;border-bottom:1px solid var(--surface-2)">
      <div>
        <strong style="font-size:.88rem">{{ inv.title }}</strong>
        <span style="font-size:.75rem;color:var(--text-muted);margin-right:.5rem">{{ inv.created_at|date:"Y/m/d" }}</span>
        <span style="background:#d1fae5;color:#065f46;border-radius:6px;font-size:.65rem;padding:.15rem .45rem;font-weight:700">âœ… ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
      </div>
      <div style="display:flex;align-items:center;gap:.65rem">
        <span style="font-family:monospace;font-weight:700">{{ inv.amount|floatformat:0 }} Ø±ÛŒØ§Ù„</span>
        {% if inv.bank_receipt %}
        <button type="button" class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .5rem"
                onclick="openLB('{{ inv.bank_receipt.url }}')">ğŸ“ ÙÛŒØ´</button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ -->
<div class="card">
  <div class="card-header">
    <span class="card-title">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</span>
  </div>
  {% if transactions %}
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>ØªØ§Ø±ÛŒØ®</th>
          <th>Ù†ÙˆØ¹</th>
          <th>Ø´Ø±Ø­</th>
          <th>Ø¬Ù‡Øª</th>
          <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in transactions %}
        <tr>
          <td style="font-size:.78rem;color:var(--text-muted)">{{ tx.created_at|date:"Y/m/d" }}</td>
          <td style="font-size:.78rem">{{ tx.get_tx_type_display }}</td>
          <td style="font-size:.82rem">{{ tx.description }}</td>
          <td>
            {% if tx.direction == 'credit' %}
            <span class="badge badge-green" style="font-size:.68rem">Ø¯Ø±ÛŒØ§ÙØª â†“</span>
            {% else %}
            <span class="badge badge-red" style="font-size:.68rem">Ù¾Ø±Ø¯Ø§Ø®Øª â†‘</span>
            {% endif %}
          </td>
          <td style="font-weight:700;font-size:.875rem;font-family:monospace;
                     color:{% if tx.direction == 'credit' %}var(--green){% else %}var(--navy){% endif %}">
            {{ tx.amount|floatformat:0 }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
  <div style="display:flex;justify-content:center;gap:.4rem;padding:.85rem">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„ÛŒ</a>
    {% endif %}
    <span style="padding:.5rem .75rem;font-size:.82rem;color:var(--text-muted)">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ÛŒ â†’</a>
    {% endif %}
  </div>
  {% endif %}
  {% else %}
  <div style="padding:2.5rem;text-align:center;color:var(--text-muted)">
    <div style="font-size:2.5rem;opacity:.4;margin-bottom:.75rem">ğŸ“Š</div>
    <p style="font-size:.875rem">Ù‡Ù†ÙˆØ² ØªØ±Ø§Ú©Ù†Ø´ Ù…Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>
  </div>
  {% endif %}
</div>

<div id="lb" onclick="this.classList.remove('on')">
  <img id="lb-img" style="max-width:92vw;max-height:92vh;object-fit:contain;border-radius:8px">
</div>
<script>function openLB(u){document.getElementById('lb-img').src=u;document.getElementById('lb').classList.add('on');}</script>
{% endblock %}