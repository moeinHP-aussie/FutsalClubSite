{% extends "base.html" %}
{% block title %}ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ</span>
{% endblock %}

{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ“„ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø¹Ø¶Ø§Ø¡</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">{{ total_pending }} Ù…Ø¹Ù„Ù‚</p>
  </div>
  <a href="{% url 'payroll:staff-invoice-create' %}" class="btn btn-amber">+ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</a>
</div>

<!-- ÙÛŒÙ„ØªØ± -->
<form method="get" style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.85rem">
  <select name="status" style="padding:.45rem .65rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.82rem">
    <option value="">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
    {% for val, label in status_choices %}
    <option value="{{ val }}" {% if status_filter == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <input type="text" name="recipient" value="{{ recipient_filter }}" placeholder="Ù†Ø§Ù… ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..."
         style="padding:.45rem .75rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.82rem;min-width:180px">
  <button type="submit" class="btn btn-outline btn-sm">Ø¬Ø³ØªØ¬Ùˆ</button>
  {% if status_filter or recipient_filter %}<a href="?" class="btn btn-outline btn-sm">âœ•</a>{% endif %}
</form>

{% if invoices %}
<div class="card">
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>ØªØ§Ø±ÛŒØ®</th>
          <th>Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</th>
          <th>Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ù…Ø¨Ù„Øº</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td style="font-size:.78rem;color:var(--text-muted)">{{ inv.created_at|date:"Y/m/d" }}</td>
          <td>
            <strong style="font-size:.85rem">{{ inv.recipient.get_full_name }}</strong>
            <div style="font-size:.72rem;color:var(--text-muted)">{{ inv.recipient.username }}</div>
          </td>
          <td style="font-size:.85rem">
            {{ inv.title }}
            {% if inv.description %}
            <div style="font-size:.72rem;color:var(--text-muted)">{{ inv.description|truncatechars:60 }}</div>
            {% endif %}
          </td>
          <td style="font-weight:700;font-family:monospace">{{ inv.amount|floatformat:0 }}</td>
          <td>
            {% if inv.status == 'paid' %}
            <span class="badge badge-green">âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
            {% if inv.paid_at %}<div style="font-size:.68rem;color:var(--text-muted)">{{ inv.paid_at|date:"Y/m/d" }}</div>{% endif %}
            {% elif inv.status == 'canceled' %}
            <span class="badge" style="background:#f1f5f9;color:#64748b">Ù„ØºÙˆ</span>
            {% else %}
            <span class="badge badge-amber">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
            {% endif %}
          </td>
          <td>
            {% if inv.bank_receipt %}
            <a href="{{ inv.bank_receipt.url }}" target="_blank"
               class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .5rem;display:block;margin-bottom:.3rem">
              ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙÛŒØ´
            </a>
            {% endif %}
            {% if inv.status == 'pending' %}
            <div style="display:flex;gap:.3rem;flex-wrap:wrap">
              <!-- Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª ÛŒÚ©Ø¬Ø§ -->
              <form method="post" action="{% url 'payroll:staff-invoice-receipt' inv.pk %}"
                    enctype="multipart/form-data" style="margin:0">
                {% csrf_token %}
                <label style="cursor:pointer" title="Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ Ùˆ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª">
                  <input type="file" name="bank_receipt" accept="image/jpeg,image/png,image/webp"
                         style="display:none"
                         onchange="if(this.files[0]&&confirm('ÙÛŒØ´ Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ ÙØ§Ú©ØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ'))this.form.submit()">
                  <span class="btn btn-green btn-sm" style="font-size:.72rem">ğŸ’¸ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´</span>
                </label>
              </form>
              <!-- ØªÙˆØ¶ÛŒØ­: Ù¾Ø±Ø¯Ø§Ø®Øª Ø­ØªÙ…Ø§Ù‹ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¯Ø§Ø±Ø¯ -->
              <!-- Ù„ØºÙˆ -->
              <form method="post" action="{% url 'payroll:staff-invoice-cancel' inv.pk %}"
                    onsubmit="return confirm('ÙØ§Ú©ØªÙˆØ± Ù„ØºÙˆ Ø´ÙˆØ¯ØŸ')" style="margin:0">
                {% csrf_token %}
                <button class="btn btn-outline btn-sm" style="font-size:.72rem;color:var(--red)">âœ• Ù„ØºÙˆ</button>
              </form>
            </div>
            {% elif inv.status == 'paid' and inv.zarinpal_ref_id %}
            <span style="font-size:.72rem;font-family:monospace;color:var(--teal)">Ù…Ø±Ø¬Ø¹: {{ inv.zarinpal_ref_id|truncatechars:12 }}</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
  <div style="display:flex;justify-content:center;gap:.4rem;padding:.75rem">
    {% if page_obj.has_previous %}<a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„ÛŒ</a>{% endif %}
    <span style="padding:.5rem .75rem;font-size:.82rem;color:var(--text-muted)">{{ page_obj.number }}/{{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}<a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ÛŒ â†’</a>{% endif %}
  </div>
  {% endif %}
</div>
{% else %}
<div class="card" style="text-align:center;padding:2.5rem">
  <div style="font-size:2.5rem;opacity:.4;margin-bottom:.75rem">ğŸ“„</div>
  <h3>ÙØ§Ú©ØªÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
</div>
{% endif %}

<!-- Modal ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª -->
<div id="pay-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:440px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:.75rem">âœ… ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
    <p style="font-size:.85rem;color:var(--text-muted);margin-bottom:1rem" id="pay-modal-desc"></p>
    <form method="post" id="pay-modal-form">
      {% csrf_token %}
      <div style="margin-bottom:.85rem">
        <label style="font-size:.82rem;font-weight:700;display:block;margin-bottom:.3rem">Ø´Ù…Ø§Ø±Ù‡ Ù…Ø±Ø¬Ø¹ Ù¾Ø±Ø¯Ø§Ø®Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
        <input type="text" name="ref_id" id="pay-ref-id" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…Ø±Ø¬Ø¹ ÛŒØ§ ØªØ±Ø§Ú©Ù†Ø´..."
               style="width:100%;padding:.55rem .75rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:monospace;font-size:.85rem">
      </div>
      <div style="display:flex;gap:.6rem;justify-content:flex-end">
        <button type="button" class="btn btn-outline" onclick="closePayModal()">Ø§Ù†ØµØ±Ø§Ù</button>
        <button type="submit" class="btn btn-green">âœ… ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      </div>
    </form>
  </div>
</div>

<script>
function openPayModal(pk, title) {
  document.getElementById('pay-modal-desc').textContent = 'ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª ÙØ§Ú©ØªÙˆØ± Â«' + title + 'Â»';
  document.getElementById('pay-modal-form').action = '/finance/payroll/staff-invoices/' + pk + '/paid/';
  document.getElementById('pay-modal').style.display = 'flex';
}
function closePayModal() {
  document.getElementById('pay-modal').style.display = 'none';
}
</script>
{% endblock %}