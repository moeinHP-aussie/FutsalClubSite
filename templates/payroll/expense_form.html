{% extends "base.html" %}
{% block title %}Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ù…Ø§Ù„ÛŒ{% endblock %}
{% block nav_expenses %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:expense-list' %}" style="text-decoration:none;color:inherit">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</a>
  <span class="sep">â€º</span><span class="cur">ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯</span>
{% endblock %}

{% block extra_head %}
<style>
.upload-zone { border:2px dashed var(--surface-2); border-radius:10px; padding:1.25rem; text-align:center; cursor:pointer; transition:.15s; background:var(--surface-1); }
.upload-zone:hover { border-color:var(--navy); background:#f0f4ff; }
.upload-zone.has-file { border-color:var(--green); background:#f0fdf4; }
.fg { margin-bottom:1rem; }
.fg label { font-size:.85rem; font-weight:700; display:block; margin-bottom:.3rem; color:var(--navy); }
.fg input, .fg select, .fg textarea {
  width:100%; padding:.55rem .85rem; border:1.5px solid var(--surface-2); border-radius:8px;
  font-family:inherit; font-size:.875rem; box-sizing:border-box; transition:border-color .15s;
}
.fg input:focus, .fg select:focus, .fg textarea:focus { outline:none; border-color:var(--navy); }
.kind-btn { flex:1; display:flex; align-items:center; gap:.6rem; padding:.75rem 1rem; border:2px solid var(--surface-2); border-radius:10px; cursor:pointer; transition:.15s; user-select:none; }
.kind-btn.ae { border-color:var(--red); background:#fef2f2; }
.kind-btn.ai { border-color:var(--green); background:#f0fdf4; }
</style>
{% endblock %}

{% block content %}
<div style="max-width:640px;margin:0 auto">
  <div class="card" style="padding:0;overflow:hidden">
    <div style="height:4px;background:linear-gradient(90deg,var(--red),var(--amber))"></div>
    <div style="padding:1.5rem 1.75rem">
      <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:1.5rem">
        <div style="width:42px;height:42px;background:linear-gradient(135deg,#ef4444,#f59e0b);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem">ğŸ“Š</div>
        <div>
          <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ù…Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯</h1>
          <p style="font-size:.78rem;color:var(--text-muted)">Ù‡Ø²ÛŒÙ†Ù‡ ÛŒØ§ Ø¯Ø±Ø¢Ù…Ø¯ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ø±Ø§ Ø¨Ø§ Ø±Ø³ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
      </div>

      {% if not has_categories %}
      <div style="background:#fffbeb;border:1.5px solid #fde68a;border-radius:10px;padding:.85rem 1rem;margin-bottom:1.25rem;font-size:.85rem;color:#92400e;display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap">
        <span>âš ï¸ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø³ØªÙ‡ Ù…Ø§Ù„ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</span>
        <a href="{% url 'payroll:expense-category-create' %}" class="btn btn-amber btn-sm">â• Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯</a>
      </div>
      {% endif %}

      {% if error %}
      <div style="background:#fee2e2;border:1.5px solid #fca5a5;border-radius:10px;padding:.85rem 1rem;margin-bottom:1.25rem;font-size:.85rem;color:#991b1b">âš ï¸ {{ error }}</div>
      {% endif %}

      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ -->
        <div class="fg">
          <label>Ù†ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ <span style="color:var(--red)">*</span></label>
          <div style="display:flex;gap:.6rem">
            <label class="kind-btn ae" id="lbl-e" for="kind-e">
              <input type="radio" id="kind-e" name="transaction_type" value="expense" checked
                     style="accent-color:var(--red);width:16px;height:16px;flex-shrink:0" onchange="upd()">
              <div>
                <div style="font-weight:800;font-size:.9rem;color:var(--red)">ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡</div>
                <div style="font-size:.72rem;color:#b91c1c">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² ØµÙ†Ø¯ÙˆÙ‚</div>
              </div>
            </label>
            <label class="kind-btn" id="lbl-i" for="kind-i">
              <input type="radio" id="kind-i" name="transaction_type" value="income"
                     style="accent-color:var(--green);width:16px;height:16px;flex-shrink:0" onchange="upd()">
              <div>
                <div style="font-weight:800;font-size:.9rem;color:var(--green)">ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯</div>
                <div style="font-size:.72rem;color:#047857">Ø¯Ø±ÛŒØ§ÙØª Ø¨Ù‡ ØµÙ†Ø¯ÙˆÙ‚</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Ø¹Ù†ÙˆØ§Ù† + Ø¯Ø³ØªÙ‡ -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="fg">
            <label for="f-title">Ø¹Ù†ÙˆØ§Ù† <span style="color:var(--red)">*</span></label>
            <input type="text" id="f-title" name="title" required
                   value="{{ prev.title|default:'' }}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¬Ø§Ø±Ù‡ Ø³Ø§Ù„Ù†...">
          </div>
          <div class="fg">
            <label for="f-cat">
              Ø¯Ø³ØªÙ‡ <span style="color:var(--red)">*</span>
              <a href="{% url 'payroll:expense-category-create' %}" style="font-size:.72rem;font-weight:600;color:var(--amber);margin-right:.4rem">+ Ø¬Ø¯ÛŒØ¯</a>
            </label>
            <select id="f-cat" name="category" required>
              <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡...</option>
              {% for cat in categories %}
              <option value="{{ cat.pk }}" {% if prev.category == cat.pk|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Ù…Ø¨Ù„Øº + ØªØ§Ø±ÛŒØ® -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="fg">
            <label for="f-amount">Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„) <span style="color:var(--red)">*</span></label>
            <input type="number" id="f-amount" name="amount" required min="1"
                   value="{{ prev.amount|default:'' }}" placeholder="5000000" style="font-family:monospace">
          </div>
          <div class="fg">
            <label for="f-date">ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ <span style="color:var(--red)">*</span></label>
            <input type="text" id="f-date" name="date_jalali" required
                   value="{{ prev.date_jalali|default:'' }}" placeholder="Û±Û´Û°Û³/Û°Û¶/Û±Ûµ" dir="ltr">
            <span style="font-size:.7rem;color:var(--text-muted)">ÙØ±Ù…Øª: YYYY/MM/DD</span>
          </div>
        </div>

        <!-- Ø´Ø±Ø­ -->
        <div class="fg">
          <label for="f-desc">Ø´Ø±Ø­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <textarea id="f-desc" name="description" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­ Ø¨ÛŒØ´ØªØ±...">{{ prev.description|default:'' }}</textarea>
        </div>

        <!-- ØªØµÙˆÛŒØ± Ø±Ø³ÛŒØ¯ -->
        <div class="fg">
          <label>ØªØµÙˆÛŒØ± Ø±Ø³ÛŒØ¯ Ø¨Ø§Ù†Ú©ÛŒ <span style="font-size:.72rem;color:var(--text-muted);font-weight:400">(Ø§Ø®ØªÛŒØ§Ø±ÛŒ â€” ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±)</span></label>
          <div class="upload-zone" id="uz" onclick="document.getElementById('f-receipt').click()">
            <input type="file" id="f-receipt" name="receipt_image"
                   accept="image/jpeg,image/png,image/webp" style="display:none" onchange="prev_r(this)">
            <div id="uz-lbl">
              <div style="font-size:1.75rem;margin-bottom:.35rem">ğŸ“·</div>
              <p style="font-size:.85rem;font-weight:700;margin:0">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯</p>
              <p style="font-size:.72rem;color:var(--text-muted);margin:.25rem 0 0">JPEGØŒ PNGØŒ WebP â€” Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª</p>
            </div>
          </div>
          <div id="rp" style="display:none;margin-top:.6rem;text-align:center">
            <img id="ri" style="max-height:150px;border-radius:8px;border:1px solid var(--surface-2)">
            <div style="margin-top:.3rem">
              <span id="rn" style="font-size:.78rem;color:var(--text-muted)"></span>
              <button type="button" onclick="clr()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:.78rem;margin-right:.5rem">âœ• Ø­Ø°Ù</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:.6rem;justify-content:flex-end;padding-top:.75rem;border-top:1px solid var(--surface-2)">
          <a href="{% url 'payroll:expense-list' %}" class="btn btn-outline">Ø§Ù†ØµØ±Ø§Ù</a>
          <button type="submit" class="btn btn-amber" id="sb">âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function upd(){
  const e=document.getElementById('kind-e').checked;
  document.getElementById('lbl-e').className='kind-btn'+(e?' ae':'');
  document.getElementById('lbl-i').className='kind-btn'+(!e?' ai':'');
  document.getElementById('sb').textContent=e?'âœ… Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡':'âœ… Ø«Ø¨Øª Ø¯Ø±Ø¢Ù…Ø¯';
}
function prev_r(inp){
  if(!inp.files||!inp.files[0])return;
  const f=inp.files[0];
  if(f.size>5*1024*1024){alert('Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª');inp.value='';return;}
  const r=new FileReader();
  r.onload=function(e){
    document.getElementById('uz').classList.add('has-file');
    document.getElementById('uz-lbl').innerHTML='<div style="font-size:1.5rem;margin-bottom:.3rem">âœ…</div><p style="font-size:.82rem;font-weight:700;margin:0">'+f.name+'</p>';
    document.getElementById('ri').src=e.target.result;
    document.getElementById('rn').textContent=f.name+' â€” '+(f.size/1024).toFixed(0)+' KB';
    document.getElementById('rp').style.display='block';
  };r.readAsDataURL(f);
}
function clr(){
  document.getElementById('f-receipt').value='';
  document.getElementById('uz').classList.remove('has-file');
  document.getElementById('uz-lbl').innerHTML='<div style="font-size:1.75rem;margin-bottom:.35rem">ğŸ“·</div><p style="font-size:.85rem;font-weight:700;margin:0">Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯</p><p style="font-size:.72rem;color:var(--text-muted);margin:.25rem 0 0">JPEGØŒ PNGØŒ WebP â€” Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª</p>';
  document.getElementById('rp').style.display='none';
}
const uz=document.getElementById('uz');
uz.addEventListener('dragover',e=>{e.preventDefault();uz.style.borderColor='var(--navy)';});
uz.addEventListener('dragleave',()=>uz.style.borderColor='');
uz.addEventListener('drop',e=>{
  e.preventDefault();uz.style.borderColor='';
  const f=e.dataTransfer.files[0];
  if(f){const inp=document.getElementById('f-receipt');const dt=new DataTransfer();dt.items.add(f);inp.files=dt.files;prev_r(inp);}
});
</script>
{% endblock %}