{% extends "base.html" %}
{% load attendance_extras %}
{% block title %}Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¯Ø±Ø¢Ù…Ø¯Ù‡Ø§{% endblock %}
{% block nav_expenses %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</span>
{% endblock %}

{% block extra_head %}
<style>
.range-inp {
  padding:.45rem .65rem;border:1.5px solid var(--surface-2);border-radius:7px;
  font-family:inherit;font-size:.82rem;width:120px;direction:ltr;
}
.range-inp:focus{outline:none;border-color:var(--navy)}
.cat-breakdown { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:.6rem; }
.cat-chip { padding:.55rem .8rem; border-radius:8px; border:1.5px solid var(--surface-2); background:#fff; font-size:.8rem; }
.cat-chip-name { font-weight:700; color:var(--navy); margin-bottom:.2rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.cat-chip-nums { display:flex; justify-content:space-between; font-size:.72rem; }
#lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:9999;place-items:center;cursor:zoom-out}
#lb.on{display:grid}
</style>
{% endblock %}

{% block content %}

<!-- Header -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.25rem;font-weight:900;color:var(--navy)">ğŸ“Š Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¯Ø±Ø¢Ù…Ø¯Ù‡Ø§</h1>
    <p style="font-size:.82rem;color:var(--text-muted);margin-top:.2rem">Ù¾Ø§ÛŒØ´ Ù…Ø§Ù„ÛŒ Ø¨Ø§Ø´Ú¯Ø§Ù‡ â€” ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ØµÙ†Ø¯ÙˆÙ‚</p>
  </div>
  <a href="{% url 'payroll:expense-create' %}" class="btn btn-amber">â• Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ø¬Ø¯ÛŒØ¯</a>
</div>

<!-- Ø®Ù„Ø§ØµÙ‡ -->
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.25rem">
  <div class="card" style="padding:1rem 1.25rem;border-right:4px solid var(--red)">
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:.3rem">
      Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§{% if date_from or date_to or cat_filter %} (ÙÛŒÙ„ØªØ±Ø´Ø¯Ù‡){% endif %}
    </div>
    <div style="font-size:1.3rem;font-weight:900;color:var(--red)">{{ total_expense|floatformat:0 }}</div>
    <div style="font-size:.72rem;color:var(--text-muted)">Ø±ÛŒØ§Ù„</div>
  </div>
  <div class="card" style="padding:1rem 1.25rem;border-right:4px solid var(--green)">
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:.3rem">
      Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯Ù‡Ø§{% if date_from or date_to or cat_filter %} (ÙÛŒÙ„ØªØ±Ø´Ø¯Ù‡){% endif %}
    </div>
    <div style="font-size:1.3rem;font-weight:900;color:var(--green)">{{ total_income|floatformat:0 }}</div>
    <div style="font-size:.72rem;color:var(--text-muted)">Ø±ÛŒØ§Ù„</div>
  </div>
  <div class="card" style="padding:1rem 1.25rem;border-right:4px solid {% if balance >= 0 %}var(--teal){% else %}var(--red){% endif %}">
    <div style="font-size:.78rem;color:var(--text-muted);margin-bottom:.3rem">Ø®Ø§Ù„Øµ Ù…Ø§Ù†Ø¯Ù‡</div>
    <div style="font-size:1.3rem;font-weight:900;color:{% if balance >= 0 %}var(--teal){% else %}var(--red){% endif %}">
      {% if balance >= 0 %}+{% endif %}{{ balance|floatformat:0 }}
    </div>
    <div style="font-size:.72rem;color:var(--text-muted)">Ø±ÛŒØ§Ù„</div>
  </div>
</div>

<!-- ØªÙÚ©ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ -->
{% if cat_breakdown %}
<div class="card" style="padding:.85rem 1rem;margin-bottom:1rem">
  <div style="font-size:.8rem;font-weight:700;color:var(--navy);margin-bottom:.65rem">ğŸ“‚ ØªÙÚ©ÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªÙ‡</div>
  <div class="cat-breakdown">
    {% for cb in cat_breakdown %}
    <div class="cat-chip {% if cb.kind == 'expense' %}{% else %}{% endif %}"
         style="border-color:{% if cb.net < 0 %}#fca5a5{% else %}#86efac{% endif %}">
      <div class="cat-chip-name" title="{{ cb.name }}">{{ cb.name }}</div>
      <div class="cat-chip-nums">
        <span style="color:var(--red)">âˆ’{{ cb.expense|floatformat:0 }}</span>
        <span style="color:var(--green)">+{{ cb.income|floatformat:0 }}</span>
      </div>
      <div style="font-size:.7rem;font-weight:700;margin-top:.2rem;
        color:{% if cb.net < 0 %}var(--red){% else %}var(--teal){% endif %}">
        Ø®Ø§Ù„Øµ: {% if cb.net >= 0 %}+{% endif %}{{ cb.net|floatformat:0 }}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
<div class="card" style="padding:.85rem 1rem;margin-bottom:1rem">
  <form method="get" style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:flex-end">
    <!-- Ø¬Ø³ØªØ¬Ùˆ -->
    <div>
      <div style="font-size:.72rem;font-weight:700;margin-bottom:.2rem;color:var(--text-muted)">Ø¬Ø³ØªØ¬Ùˆ</div>
      <input type="text" name="q" value="{{ q }}" placeholder="Ø¹Ù†ÙˆØ§Ù† ÛŒØ§ Ø´Ø±Ø­..."
             style="padding:.45rem .7rem;border:1.5px solid var(--surface-2);border-radius:7px;font-family:inherit;font-size:.82rem;min-width:150px">
    </div>
    <!-- Ø¯Ø³ØªÙ‡ -->
    <div>
      <div style="font-size:.72rem;font-weight:700;margin-bottom:.2rem;color:var(--text-muted)">Ø¯Ø³ØªÙ‡</div>
      <select name="cat" style="padding:.45rem .6rem;border:1.5px solid var(--surface-2);border-radius:7px;font-family:inherit;font-size:.82rem">
        <option value="">Ù‡Ù…Ù‡</option>
        {% for cat in categories %}
        <option value="{{ cat.pk }}" {% if cat_filter == cat.pk|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>
    <!-- Ù†ÙˆØ¹ -->
    <div>
      <div style="font-size:.72rem;font-weight:700;margin-bottom:.2rem;color:var(--text-muted)">Ù†ÙˆØ¹</div>
      <div style="display:flex;gap:.3rem">
        <a href="?{% if q %}q={{ q }}&{% endif %}kind=expense{% if cat_filter %}&cat={{ cat_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
           class="btn btn-sm {% if kind_filter == 'expense' %}btn-red{% else %}btn-outline{% endif %}" style="font-size:.78rem;padding:.4rem .7rem">Ù‡Ø²ÛŒÙ†Ù‡</a>
        <a href="?{% if q %}q={{ q }}&{% endif %}kind=income{% if cat_filter %}&cat={{ cat_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}"
           class="btn btn-sm {% if kind_filter == 'income' %}btn-green{% else %}btn-outline{% endif %}" style="font-size:.78rem;padding:.4rem .7rem">Ø¯Ø±Ø¢Ù…Ø¯</a>
      </div>
    </div>
    <!-- Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ -->
    <div>
      <div style="font-size:.72rem;font-weight:700;margin-bottom:.2rem;color:var(--text-muted)">Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</div>
      <input type="text" name="date_from" value="{{ date_from }}" class="range-inp" placeholder="Û±Û´Û°Û³/Û°Û±/Û°Û±">
    </div>
    <div>
      <div style="font-size:.72rem;font-weight:700;margin-bottom:.2rem;color:var(--text-muted)">ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</div>
      <input type="text" name="date_to" value="{{ date_to }}" class="range-inp" placeholder="Û±Û´Û°Û³/Û±Û²/Û²Û¹">
    </div>
    <button type="submit" class="btn btn-primary btn-sm">ğŸ” Ø§Ø¹Ù…Ø§Ù„</button>
    {% if q or cat_filter or kind_filter or date_from or date_to %}
    <a href="?" class="btn btn-outline btn-sm" style="color:var(--red)">âœ• Ù¾Ø§Ú©</a>
    {% endif %}
  </form>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ -->
{% if expenses %}
<div class="card">
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th>ØªØ§Ø±ÛŒØ®</th>
          <th>Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø¯Ø³ØªÙ‡</th>
          <th>Ù†ÙˆØ¹</th>
          <th>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</th>
          <th>Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡</th>
          <th>Ø±Ø³ÛŒØ¯</th>
        </tr>
      </thead>
      <tbody>
        {% for exp in expenses %}
        <tr>
          <td style="font-size:.82rem;font-family:monospace;white-space:nowrap">{{ exp.date }}</td>
          <td>
            <strong style="font-size:.875rem">{{ exp.title }}</strong>
            {% if exp.description %}
            <div style="font-size:.72rem;color:var(--text-muted);margin-top:.1rem">{{ exp.description|truncatechars:55 }}</div>
            {% endif %}
          </td>
          <td style="font-size:.82rem">{{ exp.category.name }}</td>
          <td>
            {% if exp.transaction_type == 'expense' %}
            <span class="badge badge-red" style="font-size:.68rem">ğŸ’¸ Ù‡Ø²ÛŒÙ†Ù‡</span>
            {% else %}
            <span class="badge badge-green" style="font-size:.68rem">ğŸ’° Ø¯Ø±Ø¢Ù…Ø¯</span>
            {% endif %}
          </td>
          <td style="font-size:.9rem;font-weight:700;text-align:left;font-family:monospace;
              color:{% if exp.transaction_type == 'expense' %}var(--red){% else %}var(--green){% endif %}">
            {% if exp.transaction_type == 'expense' %}âˆ’{% else %}+{% endif %}{{ exp.amount|floatformat:0 }}
          </td>
          <td style="font-size:.78rem;color:var(--text-muted)">{{ exp.recorded_by.get_full_name|default:"â€”" }}</td>
          <td>
            {% if exp.receipt_image %}
            <button type="button" class="btn btn-outline btn-sm"
                    onclick="openLB('{{ exp.receipt_image.url }}')"
                    style="font-size:.7rem;padding:.2rem .5rem">ğŸ“· Ø±Ø³ÛŒØ¯</button>
            {% elif exp.attachment %}
            <a href="{{ exp.attachment.url }}" target="_blank" class="btn btn-outline btn-sm" style="font-size:.7rem;padding:.2rem .5rem">ğŸ“</a>
            {% else %}â€”{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div style="display:flex;justify-content:center;gap:.4rem;margin-top:1rem">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if cat_filter %}&cat={{ cat_filter }}{% endif %}{% if kind_filter %}&kind={{ kind_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„ÛŒ</a>
  {% endif %}
  <span style="padding:.5rem .85rem;font-size:.82rem;color:var(--text-muted)">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if cat_filter %}&cat={{ cat_filter }}{% endif %}{% if kind_filter %}&kind={{ kind_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ÛŒ â†’</a>
  {% endif %}
</div>
{% endif %}

{% else %}
<div class="card" style="text-align:center;padding:3rem">
  <div style="font-size:3rem;margin-bottom:1rem">ğŸ“Š</div>
  <h3 style="font-weight:800;margin-bottom:.5rem">Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø§ Ø§ÛŒÙ† ÙÛŒÙ„ØªØ± ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
  {% if q or cat_filter or kind_filter or date_from or date_to %}
  <a href="?" class="btn btn-outline" style="margin-top:.75rem">âœ• Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±</a>
  {% else %}
  <a href="{% url 'payroll:expense-create' %}" class="btn btn-amber" style="margin-top:.75rem">â• Ø§ÙˆÙ„ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯</a>
  {% endif %}
</div>
{% endif %}

<!-- lightbox -->
<div id="lb" onclick="this.classList.remove('on')">
  <img id="lb-img" style="max-width:92vw;max-height:92vh;object-fit:contain;border-radius:8px">
</div>
<script>function openLB(u){document.getElementById('lb-img').src=u;document.getElementById('lb').classList.add('on');}</script>
{% endblock %}