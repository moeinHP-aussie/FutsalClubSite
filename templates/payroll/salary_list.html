{% extends "base.html" %}
{% block title %}Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù† â€” {{ category.name }}{% endblock %}
{% block nav_finance %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">Ø­Ù‚ÙˆÙ‚ {{ category.name }}</span>
{% endblock %}

{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.1rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">ğŸ’° Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù† â€” {{ category.name }}</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª Ø­Ø¶ÙˆØ± Ã— Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒ</p>
  </div>
  <div style="display:flex;align-items:center;gap:.5rem">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† {{ prev_month.year }}/{{ prev_month.month|stringformat:"02d" }}</a>
    <span style="font-weight:800;font-size:.95rem;color:var(--navy);background:var(--surface-1);padding:.3rem .7rem;border-radius:8px">
      {{ month.year }}/{{ month.month|stringformat:"02d" }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">{{ next_month.year }}/{{ next_month.month|stringformat:"02d" }} â†’</a>
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.65rem 1rem;font-size:.85rem;margin-bottom:.45rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

<div class="grid-auto" style="margin-bottom:1.1rem">
  <div class="stat-card navy">
    <div class="stat-label">Ú©Ù„ Ù…Ø±Ø¨ÛŒØ§Ù†</div>
    <div class="stat-value">{{ salaries|length }}</div>
    <span class="stat-icon">ğŸ‘¨â€ğŸ«</span>
  </div>
  <div class="stat-card green">
    <div class="stat-label">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</div>
    <div class="stat-value">{{ paid_count }}</div>
    <span class="stat-icon">âœ…</span>
  </div>
  <div class="stat-card amber">
    <div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ø­Ù‚ÙˆÙ‚</div>
    <div class="stat-value" style="font-size:.9rem">{{ total_amount|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">ğŸ’°</span>
  </div>
</div>

<!-- Ø§Ù‚Ø¯Ø§Ù…Ø§Øª -->
{% if request.user.is_finance_manager %}
<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem">
  <a href="{% url 'payroll:salary-bulk' category.pk %}?year={{ month.year }}&month={{ month.month }}"
     class="btn btn-navy btn-sm">
    âš¡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ Ù‡Ù…Ù‡ Ù…Ø±Ø¨ÛŒØ§Ù† Ø§ÛŒÙ† Ù…Ø§Ù‡
  </a>
  <a href="{% url 'payroll:coach-rate-manage' %}" class="btn btn-outline btn-sm">âš™ï¸ ØªØ¹ÛŒÛŒÙ† Ù†Ø±Ø® Ù…Ø±Ø¨ÛŒØ§Ù†</a>
</div>
{% endif %}

{% if salaries %}
<div class="card">
  <div style="overflow-x:auto">
    <table class="table">
      <thead>
        <tr>
          <th>Ù…Ø±Ø¨ÛŒ</th>
          <th>Ø¬Ù„Ø³Ø§Øª Ø­Ø§Ø¶Ø±</th>
          <th>Ù†Ø±Ø®/Ø¬Ù„Ø³Ù‡</th>
          <th>Ù…Ø¨Ù„Øº Ù¾Ø§ÛŒÙ‡</th>
          <th>ØªØ¹Ø¯ÛŒÙ„</th>
          <th>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          {% if request.user.is_finance_manager %}<th>Ø§Ù‚Ø¯Ø§Ù…</th>{% endif %}
        </tr>
      </thead>
      <tbody>
        {% for salary in salaries %}
        <tr>
          <td>
            <strong>{{ salary.coach.first_name }} {{ salary.coach.last_name }}</strong>
            {% if salary.coach.degree %}<div style="font-size:.72rem;color:var(--text-muted)">{{ salary.coach.get_degree_display }}</div>{% endif %}
          </td>
          <td style="text-align:center;font-weight:700">{{ salary.sessions_attended }}</td>
          <td style="font-family:monospace;font-size:.85rem">{{ salary.session_rate|floatformat:0 }}</td>
          <td style="font-family:monospace;font-size:.85rem">{{ salary.base_amount|floatformat:0 }}</td>
          <td style="font-family:monospace;font-size:.85rem;color:{% if salary.manual_adjustment > 0 %}var(--green){% elif salary.manual_adjustment < 0 %}var(--red){% else %}var(--text-muted){% endif %}">
            {% if salary.manual_adjustment %}{{ salary.manual_adjustment|floatformat:0 }}{% else %}â€”{% endif %}
          </td>
          <td style="font-family:monospace;font-size:.9rem;font-weight:700;color:var(--navy)">{{ salary.final_amount|floatformat:0 }}</td>
          <td>
            {% if salary.status == 'paid' %}
              <span class="badge badge-green" style="font-size:.68rem">âœ… Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡</span>
            {% elif salary.status == 'approved' %}
              <span class="badge badge-teal" style="font-size:.68rem">â˜‘ï¸ ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡</span>
            {% elif salary.status == 'calculated' %}
              <span class="badge badge-amber" style="font-size:.68rem">ğŸ”¢ Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ´Ø¯Ù‡</span>
            {% endif %}
          </td>
          {% if request.user.is_finance_manager %}
          <td>
            <div style="display:flex;gap:.3rem;flex-wrap:wrap">
              <!-- Ù„ÛŒÙ†Ú© Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø§ Ø§Ù…Ú©Ø§Ù† ØªØ¹Ø¯ÛŒÙ„ Ø¯Ø³ØªÛŒ -->
              <a href="{% url 'payroll:salary-calculate' salary.coach_id category.pk %}?year={{ month.year }}&month={{ month.month }}"
                 class="btn btn-outline btn-sm" style="font-size:.7rem">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</a>
              {% if salary.status == 'calculated' %}
              <form method="post" action="{% url 'payroll:salary-approve' salary.pk %}" style="margin:0">
                {% csrf_token %}
                <button class="btn btn-teal btn-sm" style="font-size:.7rem" onclick="return confirm('ØªØ£ÛŒÛŒØ¯ Ø´ÙˆØ¯ØŸ')">â˜‘ï¸ ØªØ£ÛŒÛŒØ¯</button>
              </form>
              {% elif salary.status == 'approved' %}
              <form method="post" action="{% url 'payroll:salary-pay' salary.pk %}" style="margin:0">
                {% csrf_token %}
                <button class="btn btn-green btn-sm" style="font-size:.7rem" onclick="return confirm('Ù¾Ø±Ø¯Ø§Ø®Øª Ø´ÙˆØ¯ØŸ')">ğŸ’¸ Ù¾Ø±Ø¯Ø§Ø®Øª</button>
              </form>
              {% endif %}
            </div>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% else %}
<div style="text-align:center;padding:3rem;color:var(--text-muted)">
  <div style="font-size:2.5rem;margin-bottom:.5rem">ğŸ’°</div>
  <p style="font-weight:700">Ø­Ù‚ÙˆÙ‚ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡</p>
  {% if request.user.is_finance_manager %}
  <a href="{% url 'payroll:salary-bulk' category.pk %}?year={{ month.year }}&month={{ month.month }}"
     class="btn btn-navy btn-sm" style="margin-top:.75rem">âš¡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ Ù‡Ù…Ù‡ Ù…Ø±Ø¨ÛŒØ§Ù†</a>
  {% endif %}
</div>
{% endif %}

{% endblock %}
