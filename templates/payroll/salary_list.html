{% extends "base.html" %}
{% block title %}Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù† â€” {{ category.name }}{% endblock %}
{% block nav_coach_payroll %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'payroll:finance-dashboard' %}" style="text-decoration:none;color:inherit">Ù…Ø§Ù„ÛŒ</a>
  <span class="sep">â€º</span><span class="cur">Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†</span>
{% endblock %}

{% block extra_head %}
<style>
#lb{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;place-items:center;cursor:zoom-out}
#lb.on{display:grid}
</style>
{% endblock %}

{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem">
  <div>
    <h1 style="font-size:1.05rem;font-weight:900;color:var(--navy)">ğŸ‘¨â€ğŸ« {{ category.name }} â€” Ø­Ù‚ÙˆÙ‚ Ù…Ø±Ø¨ÛŒØ§Ù†</h1>
  </div>
  <div style="display:flex;gap:.4rem;align-items:center;flex-wrap:wrap">
    <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„</a>
    <span style="font-weight:800;font-size:.88rem;background:var(--surface-1);padding:.3rem .65rem;border-radius:6px">
      {{ month.year }}/{% if month.month < 10 %}0{% endif %}{{ month.month }}
    </span>
    <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ â†’</a>
    <a href="{% url 'payroll:salary-bulk' category.pk %}?year={{ month.year }}&month={{ month.month }}"
       class="btn btn-navy btn-sm">ğŸ”¢ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ</a>
  </div>
</div>

{% if messages %}{% for msg in messages %}
<div style="border-radius:8px;padding:.6rem .9rem;font-size:.83rem;margin-bottom:.5rem;
  background:{% if msg.tags == 'success' %}#dcfce7{% elif msg.tags == 'error' %}#fee2e2{% else %}#fef9c3{% endif %};
  color:{% if msg.tags == 'success' %}#15803d{% elif msg.tags == 'error' %}#b91c1c{% else %}#854d0e{% endif %}">{{ msg }}</div>
{% endfor %}{% endif %}

<div class="card">
{% if salaries %}
<div class="table-wrap">
  <table class="data-table">
    <thead>
      <tr>
        <th>Ù…Ø±Ø¨ÛŒ</th>
        <th>Ø¬Ù„Ø³Ø§Øª</th>
        <th>Ù†Ø±Ø®/Ø¬Ù„Ø³Ù‡</th>
        <th>Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡</th>
        <th>ØªØ¹Ø¯ÛŒÙ„</th>
        <th>Ù†Ù‡Ø§ÛŒÛŒ</th>
        <th>ÙˆØ¶Ø¹ÛŒØª</th>
        <th>ÙÛŒØ´</th>
        <th>Ø§Ù‚Ø¯Ø§Ù…</th>
      </tr>
    </thead>
    <tbody>
      {% for sal in salaries %}
      <tr style="{% if sal.status == 'confirmed' %}background:#f0fdf4{% elif sal.status == 'paid' %}background:#fffbeb{% endif %}">
        <td style="font-weight:700;font-size:.88rem">{{ sal.coach.first_name }} {{ sal.coach.last_name }}</td>
        <td style="text-align:center;font-family:monospace">{{ sal.sessions_attended }}</td>
        <td style="font-family:monospace;font-size:.82rem">{{ sal.session_rate|floatformat:0 }}</td>
        <td style="font-family:monospace;font-size:.82rem">{{ sal.base_amount|floatformat:0 }}</td>
        <td style="font-family:monospace;font-size:.82rem;
            color:{% if sal.manual_adjustment > 0 %}var(--green){% elif sal.manual_adjustment < 0 %}var(--red){% else %}var(--text-muted){% endif %}">
          {% if sal.manual_adjustment != 0 %}
          {{ sal.manual_adjustment|floatformat:0 }}
          {% else %}â€”{% endif %}
        </td>
        <td style="font-family:monospace;font-weight:900">{{ sal.final_amount|floatformat:0 }}</td>
        <td>
          {% if sal.status == 'confirmed' %}
          <span class="badge badge-green" style="font-size:.68rem">âœ… ØªØ£ÛŒÛŒØ¯ Ù…Ø±Ø¨ÛŒ</span>
          {% elif sal.status == 'paid' %}
          <span class="badge badge-amber" style="font-size:.68rem">â³ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯</span>
          {% elif sal.status == 'approved' %}
          <span class="badge badge-teal" style="font-size:.68rem">â˜‘ï¸ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
          {% else %}
          <span class="badge" style="font-size:.68rem;background:#e5e7eb">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡</span>
          {% endif %}
        </td>
        <td>
          {% if sal.bank_receipt %}
          <button onclick="openLB('{{ sal.bank_receipt.url }}')"
                  class="btn btn-outline btn-sm" style="font-size:.7rem">ğŸ“ ÙÛŒØ´</button>
          {% else %}â€”{% endif %}
        </td>
        <td>
          <div style="display:flex;gap:.25rem;flex-wrap:wrap">
            {% if sal.status == 'calculated' %}
            <form method="post" action="{% url 'payroll:salary-approve' sal.pk %}" style="margin:0">
              {% csrf_token %}<button class="btn btn-teal btn-sm" style="font-size:.7rem">â˜‘ï¸</button>
            </form>
            {% elif sal.status == 'approved' %}
            <!-- Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª -->
            <form method="post" action="{% url 'payroll:salary-pay' sal.pk %}"
                  enctype="multipart/form-data" style="margin:0">
              {% csrf_token %}
              <label style="cursor:pointer" title="Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´ Ø¨Ø§Ù†Ú©ÛŒ Ùˆ Ø«Ø¨Øª Ù¾Ø±Ø¯Ø§Ø®Øª">
                <input type="file" name="bank_receipt" accept="image/jpeg,image/png,image/webp"
                       style="display:none"
                       onchange="if(this.files[0]&&confirm('ÙÛŒØ´ Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ'))this.form.submit()">
                <span class="btn btn-green btn-sm" style="font-size:.7rem">ğŸ’¸ Ø¢Ù¾Ù„ÙˆØ¯ ÙÛŒØ´</span>
              </label>
            </form>
            {% elif sal.status in 'paid,confirmed' and sal.bank_receipt %}
            <!-- Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ ÙÛŒØ´ -->
            <form method="post" action="{% url 'payroll:salary-pay' sal.pk %}"
                  enctype="multipart/form-data" style="margin:0">
              {% csrf_token %}
              <label style="cursor:pointer" title="Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ ÙÛŒØ´">
                <input type="file" name="bank_receipt" accept="image/jpeg,image/png,image/webp"
                       style="display:none"
                       onchange="if(this.files[0]&&confirm('ÙÛŒØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯ØŸ'))this.form.submit()">
                <span class="btn btn-outline btn-sm" style="font-size:.7rem">ğŸ”„</span>
              </label>
            </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    {% if total_amount %}
    <tfoot>
      <tr style="background:var(--surface-1)">
        <td colspan="5" style="font-weight:900;font-size:.85rem;padding:.6rem 1rem">Ø¬Ù…Ø¹ Ú©Ù„</td>
        <td style="font-family:monospace;font-weight:900;font-size:.9rem">{{ total_amount|floatformat:0 }}</td>
        <td colspan="3"></td>
      </tr>
    </tfoot>
    {% endif %}
  </table>
</div>
{% else %}
<div style="padding:2.5rem;text-align:center;color:var(--text-muted)">
  <div style="font-size:2rem;margin-bottom:.5rem">ğŸ‘¨â€ğŸ«</div>
  <p style="font-weight:700">Ø­Ù‚ÙˆÙ‚ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡</p>
  <a href="{% url 'payroll:salary-bulk' category.pk %}?year={{ month.year }}&month={{ month.month }}"
     class="btn btn-navy" style="margin-top:.75rem">ğŸ”¢ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚</a>
</div>
{% endif %}
</div>

<div id="lb" onclick="this.classList.remove('on')">
  <img id="lb-img" style="max-width:92vw;max-height:92vh;object-fit:contain;border-radius:8px">
</div>
<script>function openLB(u){document.getElementById('lb-img').src=u;document.getElementById('lb').classList.add('on');}</script>
{% endblock %}