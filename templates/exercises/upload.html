{% comment %}templates/exercises/upload.html{% endcomment %}
{% extends "base.html" %}
{% block title %}Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ…Ø±ÛŒÙ†{% endblock %}
{% block nav_exercises %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'exercises:gallery' %}" style="text-decoration:none;color:inherit">Ù…Ø®Ø²Ù† ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§</a>
  <span class="sep">â€º</span>
  <span class="cur">Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</span>
{% endblock %}

{% block extra_head %}
<style>
.upload-form { max-width: 680px; }
.drop-zone {
  border: 2px dashed var(--surface-2);
  border-radius: var(--radius);
  padding: 2.5rem;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  background: var(--surface);
  position: relative;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--amber);
  background: #fffbeb;
}
.drop-zone input[type=file] {
  position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.drop-icon { font-size: 2.5rem; margin-bottom: .75rem; }
.drop-text { font-size: .9rem; font-weight: 600; color: var(--text-muted); }
.drop-sub  { font-size: .78rem; color: var(--text-light); margin-top: .3rem; }
.file-preview {
  display: none;
  padding: .85rem;
  background: #d1fae5;
  border: 1px solid #a7f3d0;
  border-radius: var(--radius-sm);
  font-size: .85rem; color: #065f46;
  display: flex; align-items: center; gap: .75rem;
}
.file-preview.show { display: flex; }
.media-type-selector { display: grid; grid-template-columns: repeat(4,1fr); gap: .5rem; }
.type-card {
  border: 1.5px solid var(--surface-2);
  border-radius: var(--radius-sm);
  padding: .85rem .5rem;
  text-align: center; cursor: pointer;
  transition: var(--transition);
}
.type-card:hover { border-color: var(--navy); background: var(--surface); }
.type-card input { display: none; }
.type-card input:checked + .type-content { color: var(--navy); }
.type-card:has(input:checked) { border-color: var(--navy); background: rgba(13,27,42,.05); }
.type-icon { font-size: 1.5rem; display: block; margin-bottom: .25rem; }
.type-label { font-size: .78rem; font-weight: 600; }
.public-toggle {
  display: flex; align-items: center; gap: .75rem;
  padding: .85rem 1rem;
  border: 1.5px solid var(--surface-2); border-radius: var(--radius-sm);
  cursor: pointer; transition: var(--transition);
}
.public-toggle:hover { border-color: var(--teal); background: #ecfeff; }
input[type=checkbox]#is_public:checked ~ .toggle-body .toggle-sw { background: var(--teal); }
.toggle-sw {
  width: 40px; height: 22px; border-radius: 99px;
  background: var(--surface-2); position: relative; flex-shrink: 0; transition: background .2s;
}
.toggle-sw::after {
  content: ""; position: absolute;
  width: 16px; height: 16px; border-radius: 50%;
  background: var(--white); top: 3px; right: 3px;
  transition: right .2s; box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
.cat-chips { display: flex; flex-wrap: wrap; gap: .4rem; margin-top: .4rem; }
.cat-chip { display: none; }
.cat-chip-label {
  padding: .35rem .85rem; border-radius: 99px;
  border: 1.5px solid var(--surface-2);
  font-size: .78rem; font-weight: 600;
  cursor: pointer; transition: var(--transition); color: var(--text-muted);
}
.cat-chip:checked + .cat-chip-label {
  border-color: var(--navy); background: var(--navy); color: var(--white);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>â¬†ï¸ Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ…Ø±ÛŒÙ† Ø¬Ø¯ÛŒØ¯</h1>
    <p>ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆØŒ ØªØµÙˆÛŒØ±ØŒ Ú¯ÛŒÙ ÛŒØ§ Ø³Ù†Ø¯ Ø¢Ù…ÙˆØ²Ø´ÛŒ</p>
  </div>
  <a href="{% url 'exercises:gallery' %}" class="btn btn-outline">â† Ù…Ø®Ø²Ù† ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§</a>
</div>

<div class="upload-form">
  <form method="post" enctype="multipart/form-data" id="upload-form">
    {% csrf_token %}

    {% if form.errors %}
    <div class="alert alert-danger mb-2">
      <span class="alert-icon">âŒ</span>
      <div>
        {% for f, errors in form.errors.items %}
          {% for e in errors %}<div>{{ e }}</div>{% endfor %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- â”€â”€ Media Type Selection â”€â”€ -->
    <div class="card mb-2">
      <div class="card-header"><span class="card-title">ğŸ“‚ Ù†ÙˆØ¹ Ø±Ø³Ø§Ù†Ù‡</span></div>
      <div class="card-body">
        <div class="media-type-selector">
          {% for val, label in form.media_type.field.choices %}
          <label class="type-card">
            <input type="radio" name="media_type" value="{{ val }}"
                   {% if form.media_type.value == val or forloop.first and not form.media_type.value %}checked{% endif %}
                   onchange="updateDropZone(this.value)">
            <div class="type-content">
              <span class="type-icon">
                {% if val == 'video' %}ğŸ¬{% elif val == 'image' %}ğŸ–¼ï¸{% elif val == 'gif' %}âœ¨{% else %}ğŸ“„{% endif %}
              </span>
              <div class="type-label">{{ label }}</div>
            </div>
          </label>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- â”€â”€ File Upload â”€â”€ -->
    <div class="card mb-2">
      <div class="card-header"><span class="card-title">ğŸ“ ÙØ§ÛŒÙ„ ØªÙ…Ø±ÛŒÙ† <span style="color:var(--red)">*</span></span></div>
      <div class="card-body">
        <div class="drop-zone" id="drop-zone">
          <input type="file" name="file" id="file-input" required onchange="onFileSelected(this)">
          <div class="drop-icon" id="drop-icon">ğŸ¬</div>
          <div class="drop-text">ÙØ§ÛŒÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
          <div class="drop-sub" id="drop-sub">MP4, WebM, MOV â€” Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª</div>
        </div>
        <div class="file-preview" id="file-preview">
          <span style="font-size:1.5rem">âœ…</span>
          <div>
            <div style="font-weight:600" id="file-name">â€”</div>
            <div style="font-size:.75rem;color:#065f46" id="file-size">â€”</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Details â”€â”€ -->
    <div class="card mb-2">
      <div class="card-header"><span class="card-title">ğŸ“ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙ…Ø±ÛŒÙ†</span></div>
      <div class="card-body">
        <div class="form-group mb-2">
          <label class="form-label">Ø¹Ù†ÙˆØ§Ù† <span class="req">*</span></label>
          <input type="text" name="title" class="form-control" required
                 value="{{ form.title.value|default:'' }}"
                 placeholder="Ø¹Ù†ÙˆØ§Ù† ØªÙˆØµÛŒÙÛŒ ØªÙ…Ø±ÛŒÙ†">
        </div>
        <div class="form-group mb-2">
          <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª</label>
          <textarea name="description" class="form-control" rows="3"
                    placeholder="Ù‡Ø¯Ù ØªÙ…Ø±ÛŒÙ†ØŒ Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§ØŒ Ù†Ú©Ø§Øª ÙÙ†ÛŒ...">{{ form.description.value|default:'' }}</textarea>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label class="form-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
            <input type="number" name="duration_minutes" class="form-control"
                   value="{{ form.duration_minutes.value|default:'' }}"
                   placeholder="Ù…Ø«Ø§Ù„: Û±Ûµ" min="1" inputmode="numeric">
          </div>
          <div class="form-group">
            <label class="form-label">ØªØµÙˆÛŒØ± Ø¨Ù†Ø¯Ø§Ù†Ú¯Ø´ØªÛŒ</label>
            <input type="file" name="thumbnail" class="form-control" accept="image/*">
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Categories â”€â”€ -->
    {% if form.categories.field.choices %}
    <div class="card mb-2">
      <div class="card-header"><span class="card-title">ğŸ—‚ï¸ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø·</span></div>
      <div class="card-body">
        <div class="cat-chips">
          {% for val, label in form.categories.field.choices %}
          <div>
            <input type="checkbox" name="categories" value="{{ val }}"
                   id="cat_{{ val }}" class="cat-chip"
                   {% if val|stringformat:'s' in form.categories.value|default:'' %}checked{% endif %}>
            <label for="cat_{{ val }}" class="cat-chip-label">{{ label }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- â”€â”€ Visibility â”€â”€ -->
    <div class="card mb-2">
      <div class="card-header"><span class="card-title">ğŸ‘ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ</span></div>
      <div class="card-body">
        <input type="checkbox" name="is_public" id="is_public"
               style="display:none" {% if form.is_public.value %}checked{% endif %}
               onchange="togglePublic(this)">
        <label for="is_public" class="public-toggle">
          <div class="toggle-body" style="display:flex;align-items:center;gap:.75rem;flex:1">
            <div class="toggle-sw" id="pub-toggle-sw"></div>
            <div>
              <div style="font-weight:600;font-size:.9rem" id="pub-label">ğŸ”’ Ø®ØµÙˆØµÛŒ</div>
              <div class="form-hint" id="pub-hint">ÙÙ‚Ø· Ø®ÙˆØ¯Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ø¨ÛŒÙ†Ù…</div>
            </div>
          </div>
        </label>
      </div>
    </div>

    <div style="display:flex;gap:.75rem;justify-content:flex-end">
      <a href="{% url 'exercises:gallery' %}" class="btn btn-outline">Ø§Ù†ØµØ±Ø§Ù</a>
      <button type="submit" class="btn btn-amber" id="upload-btn">
        â¬†ï¸ Ø¢Ù¾Ù„ÙˆØ¯ ØªÙ…Ø±ÛŒÙ†
      </button>
    </div>

  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const TYPE_META = {
  video:    { icon: "ğŸ¬", hint: "MP4, WebM, MOV â€” Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª" },
  image:    { icon: "ğŸ–¼ï¸", hint: "JPG, PNG, WebP â€” Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª" },
  gif:      { icon: "âœ¨", hint: "ÙØ§ÛŒÙ„ GIF â€” Ø­Ø¯Ø§Ú©Ø«Ø± Û³Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª" },
  document: { icon: "ğŸ“„", hint: "PDF, Word â€” Ø­Ø¯Ø§Ú©Ø«Ø± ÛµÛ° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª" },
};

function updateDropZone(type) {
  const m = TYPE_META[type] || TYPE_META.video;
  document.getElementById("drop-icon").textContent = m.icon;
  document.getElementById("drop-sub").textContent  = m.hint;
}

function onFileSelected(input) {
  const file = input.files[0];
  if (!file) return;
  const preview = document.getElementById("file-preview");
  document.getElementById("file-name").textContent = file.name;
  document.getElementById("file-size").textContent = (file.size / 1024 / 1024).toFixed(2) + " MB";
  preview.classList.add("show");
}

function togglePublic(cb) {
  const sw     = document.getElementById("pub-toggle-sw");
  const label  = document.getElementById("pub-label");
  const hint   = document.getElementById("pub-hint");
  sw.style.background = cb.checked ? "var(--teal)" : "";
  if (sw.querySelector) {}
  label.textContent = cb.checked ? "ğŸŒ Ø¹Ù…ÙˆÙ…ÛŒ" : "ğŸ”’ Ø®ØµÙˆØµÛŒ";
  hint.textContent  = cb.checked ? "ØªÙ…Ø§Ù… Ù…Ø±Ø¨ÛŒØ§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø¨ÛŒÙ†Ù†Ø¯" : "ÙÙ‚Ø· Ø®ÙˆØ¯Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ø¨ÛŒÙ†Ù…";
}

// Drag & Drop
const dz = document.getElementById("drop-zone");
dz.addEventListener("dragover",  e => { e.preventDefault(); dz.classList.add("drag-over"); });
dz.addEventListener("dragleave", () => dz.classList.remove("drag-over"));
dz.addEventListener("drop",      e => {
  e.preventDefault(); dz.classList.remove("drag-over");
  const fi = document.getElementById("file-input");
  fi.files = e.dataTransfer.files;
  onFileSelected(fi);
});

// Upload progress UX
document.getElementById("upload-form").addEventListener("submit", function() {
  const btn = document.getElementById("upload-btn");
  btn.disabled    = true;
  btn.textContent = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯...";
});

// Init
document.addEventListener("DOMContentLoaded", () => {
  const checked = document.querySelector('input[name=media_type]:checked');
  if (checked) updateDropZone(checked.value);
});
</script>
{% endblock %}
