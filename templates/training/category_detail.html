{% extends "base.html" %}
{% block title %}{{ category.name }}{% endblock %}
{% block nav_categories %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'training:category-list' %}" style="text-decoration:none;color:inherit">Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</a>
  <span class="sep">â€º</span><span class="cur">{{ category.name }}</span>
{% endblock %}

{% block extra_head %}
<style>
.col-chip {
  display:inline-flex; align-items:center; gap:.25rem;
  padding:.2rem .55rem; border-radius:99px; font-size:.72rem; font-weight:700;
  cursor:pointer; border:1.5px solid var(--surface-2); background:var(--surface-2);
  color:var(--text-muted); transition:.12s; user-select:none;
}
.col-chip.active { background:#dbeafe; border-color:#93c5fd; color:#1e3a8a; }

.time-picker { display:flex; gap:.3rem; align-items:center; }
.time-select {
  padding:.45rem .5rem; border:1.5px solid var(--surface-2); border-radius:8px;
  font-family:inherit; font-size:.82rem; background:#fff; cursor:pointer; min-width:60px;
}
</style>
<script>
function toggleScheduleForm() {
  const el = document.getElementById('sch-add-form');
  const btn = document.getElementById('sch-toggle-btn');
  const open = el.style.display === 'none' || el.style.display === '';
  el.style.display = open ? 'block' : 'none';
  btn.textContent = open ? 'âœ• Ø¨Ø³ØªÙ†' : '+ Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ù„Ø³Ù‡';
  btn.className = open ? 'btn btn-outline btn-sm' : 'btn btn-amber btn-sm';
}
</script>
{% endblock %}

{% block content %}

<!-- Header -->
<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <div style="display:flex;align-items:center;gap:.75rem">
      <h1 style="font-size:1.3rem;font-weight:900;color:var(--navy)">{{ category.name }}</h1>
      {% if category.is_active %}
        <span class="badge badge-green">ÙØ¹Ø§Ù„</span>
      {% else %}
        <span class="badge" style="background:#f1f5f9;color:#64748b">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
      {% endif %}
    </div>
    {% if category.description %}
    <p style="font-size:.85rem;color:var(--text-muted);margin-top:.3rem">{{ category.description }}</p>
    {% endif %}
  </div>
  {% if request.user.is_technical_director or request.user.is_superuser %}
  <div style="display:flex;gap:.5rem">
    <a href="{% url 'training:category-update' category.pk %}" class="btn btn-navy btn-sm">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</a>
    <a href="{% url 'training:attendance-select' %}?cat={{ category.pk }}" class="btn btn-amber btn-sm">ğŸ“… Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</a>
  </div>
  {% endif %}
</div>

<!-- Stats row -->
<div class="grid-auto" style="margin-bottom:1.25rem">
  <div class="stat-card amber">
    <div class="stat-label">Ø´Ù‡Ø±ÛŒÙ‡ Ù…Ø§Ù‡Ø§Ù†Ù‡</div>
    <div class="stat-value" style="font-size:1.4rem">{{ category.monthly_fee|floatformat:0 }}</div>
    <div class="stat-sub">Ø±ÛŒØ§Ù„</div>
    <span class="stat-icon">ğŸ’°</span>
  </div>
  <div class="stat-card navy">
    <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</div>
    <div class="stat-value">{{ players|length }}</div>
    <span class="stat-icon">ğŸ‘¥</span>
  </div>
  <div class="stat-card teal">
    <div class="stat-label">Ù…Ø±Ø¨ÛŒØ§Ù†</div>
    <div class="stat-value">{{ coach_rates|length }}</div>
    <span class="stat-icon">ğŸƒ</span>
  </div>
  <div class="stat-card green">
    <div class="stat-label">Ø¬Ù„Ø³Ø§Øª Ø¯Ø± Ù‡ÙØªÙ‡</div>
    <div class="stat-value">{{ schedules|length }}</div>
    <span class="stat-icon">ğŸ“…</span>
  </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">

  <!-- â”€â”€ Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø±ÛŒÙ†</span>
      {% if request.user.is_technical_director or request.user.is_superuser %}
      <button id="sch-toggle-btn" class="btn btn-amber btn-sm"
              onclick="toggleScheduleForm()">+ Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ù„Ø³Ù‡</button>
      {% endif %}
    </div>

    <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ù„Ø³Ù‡ -->
    {% if request.user.is_technical_director or request.user.is_superuser %}
    <div id="sch-add-form" style="display:none;padding:.85rem 1rem;border-bottom:2px solid var(--amber);background:#fffbeb">
      <form method="post" action="{% url 'training:schedule-add' category.pk %}">
        {% csrf_token %}

        <!-- Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: Ø±ÙˆØ² + Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹ + Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù† -->
        <div style="display:flex;gap:.65rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:.65rem">
          <div>
            <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.3rem">Ø±ÙˆØ² Ù‡ÙØªÙ‡ *</label>
            <select name="weekday" class="time-select" style="min-width:90px">
              <option value="sat">Ø´Ù†Ø¨Ù‡</option>
              <option value="sun">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
              <option value="mon">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option>
              <option value="tue">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</option>
              <option value="wed">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</option>
              <option value="thu">Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡</option>
              <option value="fri">Ø¬Ù…Ø¹Ù‡</option>
            </select>
          </div>

          <!-- Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹ â€” dropdown Ø³Ø§Ø¹Øª + Ø¯Ù‚ÛŒÙ‚Ù‡ -->
          <div>
            <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.3rem">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹ *</label>
            <div class="time-picker">
              <select name="start_hour" class="time-select">
                <option value="06">Û¶</option>
                <option value="07">Û·</option>
                <option value="08">Û¸</option>
                <option value="09">Û¹</option>
                <option value="10">Û±Û°</option>
                <option value="11">Û±Û±</option>
                <option value="12">Û±Û²</option>
                <option value="13">Û±Û³</option>
                <option value="14">Û±Û´</option>
                <option value="15">Û±Ûµ</option>
                <option value="16" selected>Û±Û¶</option>
                <option value="17">Û±Û·</option>
                <option value="18">Û±Û¸</option>
                <option value="19">Û±Û¹</option>
                <option value="20">Û²Û°</option>
                <option value="21">Û²Û±</option>
                <option value="22">Û²Û²</option>
              </select>
              <span style="font-size:.85rem;font-weight:700;color:var(--text-muted)">:</span>
              <select name="start_minute" class="time-select" style="min-width:55px">
                <option value="00" selected>Û°Û°</option>
                <option value="15">Û±Ûµ</option>
                <option value="30">Û³Û°</option>
                <option value="45">Û´Ûµ</option>
              </select>
            </div>
          </div>

          <!-- Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù† -->
          <div>
            <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.3rem">Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†</label>
            <div class="time-picker">
              <select name="end_hour" class="time-select">
                <option value="">â€”</option>
                <option value="06">Û¶</option>
                <option value="07">Û·</option>
                <option value="08">Û¸</option>
                <option value="09">Û¹</option>
                <option value="10">Û±Û°</option>
                <option value="11">Û±Û±</option>
                <option value="12">Û±Û²</option>
                <option value="13">Û±Û³</option>
                <option value="14">Û±Û´</option>
                <option value="15">Û±Ûµ</option>
                <option value="16">Û±Û¶</option>
                <option value="17">Û±Û·</option>
                <option value="18">Û±Û¸</option>
                <option value="19">Û±Û¹</option>
                <option value="20">Û²Û°</option>
                <option value="21">Û²Û±</option>
                <option value="22">Û²Û²</option>
              </select>
              <span style="font-size:.85rem;font-weight:700;color:var(--text-muted)">:</span>
              <select name="end_minute" class="time-select" style="min-width:55px">
                <option value="00" selected>Û°Û°</option>
                <option value="15">Û±Ûµ</option>
                <option value="30">Û³Û°</option>
                <option value="45">Û´Ûµ</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: Ù…Ú©Ø§Ù† + Ø¯Ú©Ù…Ù‡ -->
        <div style="display:flex;gap:.65rem;align-items:flex-end">
          <div style="flex:1">
            <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.3rem">Ù…Ú©Ø§Ù† / Ø³Ø§Ù„Ù†</label>
            <input type="text" name="location" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ù„Ù† Ø§ØµÙ„ÛŒ"
                   style="width:100%;padding:.45rem .7rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.82rem">
          </div>
          <button type="submit" class="btn btn-navy btn-sm" style="white-space:nowrap">âœ… Ø°Ø®ÛŒØ±Ù‡ Ø¬Ù„Ø³Ù‡</button>
        </div>
      </form>
    </div>
    {% endif %}

    {% if schedules %}
    <div style="padding:.6rem .85rem">
      {% for sch in schedules %}
      <div style="display:flex;align-items:center;gap:.6rem;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <span style="font-size:1rem">ğŸ“…</span>
        <div style="flex:1">
          <strong style="font-size:.875rem">{{ sch.get_weekday_display }}</strong>
          {% if sch.location %}
          <span style="font-size:.75rem;color:var(--text-muted);margin-right:.35rem">Â· {{ sch.location }}</span>
          {% endif %}
        </div>
        <span style="font-size:.82rem;color:var(--teal);font-weight:700">
          {{ sch.start_time|time:"H:i" }}
          {% if sch.end_time %}<span style="color:var(--text-muted)"> â€” </span>{{ sch.end_time|time:"H:i" }}{% endif %}
        </span>
        {% if request.user.is_technical_director or request.user.is_superuser %}
        <form method="post" action="{% url 'training:schedule-delete' sch.pk %}"
              onsubmit="return confirm('Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')" style="margin:0">
          {% csrf_token %}
          <button type="submit"
                  style="background:none;border:none;cursor:pointer;font-size:.85rem;color:#ef4444;padding:.2rem .4rem">âœ•</button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.875rem">
      Ù‡Ù†ÙˆØ² Ø¬Ù„Ø³Ù‡â€ŒØ§ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ â€” Ø±ÙˆÛŒ Â«+ Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ù„Ø³Ù‡Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.
    </div>
    {% endif %}
  </div>

  <!-- â”€â”€ Ù…Ø±Ø¨ÛŒØ§Ù† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸƒ Ù…Ø±Ø¨ÛŒØ§Ù†</span>
    </div>
    {% if coach_rates %}
    <div style="padding:.75rem 1rem">
      {% for cr in coach_rates %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--surface-2)">
        <div>
          <div style="font-weight:700;font-size:.875rem">{{ cr.coach.first_name }} {{ cr.coach.last_name }}</div>
          <div style="font-size:.72rem;color:var(--text-muted)">{{ cr.coach.get_degree_display }}</div>
        </div>
        <span style="font-size:.78rem;color:var(--amber);font-weight:700">
          {{ cr.session_rate|floatformat:0 }} Ø±ÛŒØ§Ù„/Ø¬Ù„Ø³Ù‡
        </span>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.875rem">
      Ù‡Ù†ÙˆØ² Ù…Ø±Ø¨ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡
    </div>
    {% endif %}
  </div>
</div>

<!-- â”€â”€ Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card">
  <div class="card-header">
    <span class="card-title">ğŸ‘¥ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† ({{ players|length }})</span>
    {% if request.user.is_technical_director or request.user.is_superuser %}
    <a href="{% url 'training:attendance-select' %}?cat={{ category.pk }}" class="btn btn-amber btn-sm">ğŸ“… Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</a>
    {% endif %}
  </div>

  <!-- ØªÙ†Ø¸ÛŒÙ… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ -->
  <div style="display:flex;flex-wrap:wrap;gap:.3rem;align-items:center;padding:.55rem .85rem;border-bottom:1px solid var(--surface-2)">
    <span style="font-size:.7rem;font-weight:800;color:var(--text-muted)">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§:</span>
    <span class="col-chip active" data-col="c-national"  onclick="toggleCatCol(this)">Ú©Ø¯ Ù…Ù„ÛŒ</span>
    <span class="col-chip active" data-col="c-insurance" onclick="toggleCatCol(this)">Ø¨ÛŒÙ…Ù‡</span>
    <span class="col-chip active" data-col="c-skill"     onclick="toggleCatCol(this)">Ø³Ø·Ø­ ÙÙ†ÛŒ</span>
    <span class="col-chip active" data-col="c-foot"      onclick="toggleCatCol(this)">Ù¾Ø§ÛŒ ØºØ§Ù„Ø¨</span>
    <span class="col-chip active" data-col="c-traits"    onclick="toggleCatCol(this)">ÙˆÛŒÚ˜Ú¯ÛŒ Ù†Ø±Ù…</span>
    <span class="col-chip active" data-col="c-shirt"     onclick="toggleCatCol(this)">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒØ±Ø§Ù‡Ù†</span>
    <span class="col-chip active" data-col="c-position"  onclick="toggleCatCol(this)">Ù¾Ø³Øª</span>
  </div>

  {% if players %}
  <div class="table-wrap">
    <table class="data-table" id="cat-players-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Ù†Ø§Ù…</th>
          <th class="c-national">Ú©Ø¯ Ù…Ù„ÛŒ</th>
          <th class="c-insurance">Ø¨ÛŒÙ…Ù‡</th>
          <th class="c-skill">Ø³Ø·Ø­ ÙÙ†ÛŒ</th>
          <th class="c-foot">Ù¾Ø§ÛŒ ØºØ§Ù„Ø¨</th>
          <th class="c-traits">ÙˆÛŒÚ˜Ú¯ÛŒ Ù†Ø±Ù…</th>
          <th class="c-shirt">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒØ±Ø§Ù‡Ù†</th>
          <th class="c-position">Ù¾Ø³Øª</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for player in players %}
        <tr>
          <td style="color:var(--text-muted);font-size:.78rem">{{ forloop.counter }}</td>
          <td>
            <strong style="font-size:.875rem">{{ player.first_name }} {{ player.last_name }}</strong>
          </td>
          <td class="c-national" style="font-family:monospace;font-size:.8rem">{{ player.national_id }}</td>
          <td class="c-insurance">
            {% if player.insurance_status == 'active' %}
              <span class="badge badge-green" style="font-size:.68rem">âœ…</span>
            {% else %}
              <span class="badge badge-red" style="font-size:.68rem">âŒ</span>
            {% endif %}
          </td>
          <td class="c-skill" style="font-size:.8rem;font-weight:700">
            {{ player.technical_profile.skill_level|default:"â€”" }}
          </td>
          <td class="c-foot" style="font-size:.78rem">
            {{ player.get_preferred_foot_display|default:"â€”" }}
          </td>
          <td class="c-traits" style="font-size:.72rem">
            {% with traits=player.technical_profile.soft_traits.all %}
              {% if traits %}
                {% for t in traits %}
                <span style="background:#ede9fe;color:#4c1d95;border-radius:99px;padding:.1rem .45rem;display:inline-block;margin:.05rem">{{ t.trait_type.name }}</span>
                {% endfor %}
              {% else %}â€”{% endif %}
            {% endwith %}
          </td>
          <td class="c-shirt" style="font-size:.82rem;font-weight:800;color:var(--navy);text-align:center">
            {% if player.technical_profile.shirt_number %}#{{ player.technical_profile.shirt_number }}{% else %}â€”{% endif %}
          </td>
          <td class="c-position" style="font-size:.78rem">
            {% if player.technical_profile.position and player.technical_profile.position != "-" %}
              {{ player.technical_profile.get_position_display }}
            {% else %}â€”{% endif %}
          </td>
          <td>
            <a href="{% url 'training:player-profile' player.pk %}"
               class="btn btn-outline btn-sm">ğŸ‘¤</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div style="padding:2rem;text-align:center;color:var(--text-muted)">
    Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡
  </div>
  {% endif %}
</div>

<script>
// â”€â”€ Column visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CAT_COL_KEY = 'cat_detail_cols';
const ALL_CAT_COLS = ['c-national','c-insurance','c-skill','c-foot','c-traits','c-shirt','c-position'];
let catActiveCols = JSON.parse(localStorage.getItem(CAT_COL_KEY) || 'null')
                   || [...ALL_CAT_COLS];  // Ù‡Ù…Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶

function applyCatCols() {
  ALL_CAT_COLS.forEach(col => {
    const show = catActiveCols.includes(col);
    document.querySelectorAll('.' + col).forEach(el => el.style.display = show ? '' : 'none');
    const chip = document.querySelector(`[data-col="${col}"]`);
    if (chip) chip.classList.toggle('active', show);
  });
}

function toggleCatCol(chip) {
  const col = chip.dataset.col;
  if (catActiveCols.includes(col)) {
    catActiveCols = catActiveCols.filter(c => c !== col);
  } else {
    catActiveCols.push(col);
  }
  localStorage.setItem(CAT_COL_KEY, JSON.stringify(catActiveCols));
  applyCatCols();
}

applyCatCols();
</script>

{% endblock %}