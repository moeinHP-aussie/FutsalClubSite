{% extends "base.html" %}
{% block title %}Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†
<!-- Bulk Action Modal -->
<div id="bulk-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:1rem" id="modal-title">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div style="margin-bottom:1.25rem">
      <label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:.35rem">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="bulk-reason" rows="2" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ..."
                style="width:100%;padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.85rem;resize:none"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-red" id="modal-confirm-btn" onclick="confirmBulk()">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>

{% if request.user.is_technical_director or request.user.is_superuser %}
<script>
const BULK_URL = "{% url 'registration:player-bulk-action' %}";
const CSRF     = "{{ csrf_token }}";
let selectedIds  = new Set();
let pendingAction = "";

function onCheck(cb) {
  const id = parseInt(cb.value);
  if (cb.checked) selectedIds.add(id);
  else            selectedIds.delete(id);
  updateBulkBar();
  document.getElementById("row-" + id).style.background = cb.checked ? "#fffbeb" : "";
}

function toggleAll(masterCb) {
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = masterCb.checked;
    onCheck(cb);
  });
}

function rowClick(e, id) {
  // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒØ´Ù‡ (Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„)
  if (e.target.tagName === "A" || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
  const cb = document.querySelector(`.row-check[value="${id}"]`);
  if (cb) { cb.checked = !cb.checked; onCheck(cb); }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = false;
    document.getElementById("row-" + cb.value).style.background = "";
  });
  const master = document.getElementById("check-all");
  if (master) master.checked = false;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById("bulk-bar");
  const lbl = document.getElementById("sel-label");
  bar.style.display = selectedIds.size > 0 ? "flex" : "none";
  lbl.textContent   = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
}

function bulkAction(action) {
  if (selectedIds.size === 0) return;
  pendingAction = action;
  const modal = document.getElementById("bulk-modal");
  const title = document.getElementById("modal-title");
  const desc  = document.getElementById("modal-desc");
  const btn   = document.getElementById("modal-confirm-btn");

  if (action === "archive") {
    title.textContent = "ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø¨Ø®Ø´ Â«Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡Â» Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.`;
    btn.textContent   = "ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "block";
  } else {
    title.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!`;
    btn.textContent   = "ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ù†";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "none";
  }
  modal.style.display = "flex";
}

function closeModal() { document.getElementById("bulk-modal").style.display = "none"; }

async function confirmBulk() {
  const reason = document.getElementById("bulk-reason").value.trim();
  closeModal();
  try {
    const res = await fetch(BULK_URL, {
      method:  "POST",
      headers: { "Content-Type":"application/json","X-CSRFToken":CSRF },
      body:    JSON.stringify({
        action:     pendingAction,
        player_ids: [...selectedIds],
        reason:     reason,
      }),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    const msg = data.action === "archive"
      ? `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯`
      : `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø­Ø°Ù Ø´Ø¯`;

    // Ø­Ø°Ù Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø² DOM
    selectedIds.forEach(id => {
      const row = document.getElementById("row-" + id);
      if (row) {
        row.style.transition = "opacity .3s, transform .3s";
        row.style.opacity    = "0";
        row.style.transform  = "translateX(20px)";
        setTimeout(() => row.remove(), 300);
      }
    });

    clearSelection();
    showToast("âœ… " + msg, "ok");
    setTimeout(() => location.reload(), 1200);

  } catch (err) {
    showToast("âŒ " + err.message, "err");
  }
}

function showToast(msg, type) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);
    background:${type==="ok"?"#10b981":"#ef4444"};color:#fff;
    padding:.6rem 1.25rem;border-radius:99px;font-size:.85rem;font-weight:700;
    z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);white-space:nowrap`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2700);
}
</script>
{% endif %}

{% endblock %}
{% block nav_players %}active
<!-- Bulk Action Modal -->
<div id="bulk-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:1rem" id="modal-title">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div style="margin-bottom:1.25rem">
      <label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:.35rem">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="bulk-reason" rows="2" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ..."
                style="width:100%;padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.85rem;resize:none"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-red" id="modal-confirm-btn" onclick="confirmBulk()">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>

{% if request.user.is_technical_director or request.user.is_superuser %}
<script>
const BULK_URL = "{% url 'registration:player-bulk-action' %}";
const CSRF     = "{{ csrf_token }}";
let selectedIds  = new Set();
let pendingAction = "";

function onCheck(cb) {
  const id = parseInt(cb.value);
  if (cb.checked) selectedIds.add(id);
  else            selectedIds.delete(id);
  updateBulkBar();
  document.getElementById("row-" + id).style.background = cb.checked ? "#fffbeb" : "";
}

function toggleAll(masterCb) {
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = masterCb.checked;
    onCheck(cb);
  });
}

function rowClick(e, id) {
  // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒØ´Ù‡ (Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„)
  if (e.target.tagName === "A" || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
  const cb = document.querySelector(`.row-check[value="${id}"]`);
  if (cb) { cb.checked = !cb.checked; onCheck(cb); }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = false;
    document.getElementById("row-" + cb.value).style.background = "";
  });
  const master = document.getElementById("check-all");
  if (master) master.checked = false;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById("bulk-bar");
  const lbl = document.getElementById("sel-label");
  bar.style.display = selectedIds.size > 0 ? "flex" : "none";
  lbl.textContent   = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
}

function bulkAction(action) {
  if (selectedIds.size === 0) return;
  pendingAction = action;
  const modal = document.getElementById("bulk-modal");
  const title = document.getElementById("modal-title");
  const desc  = document.getElementById("modal-desc");
  const btn   = document.getElementById("modal-confirm-btn");

  if (action === "archive") {
    title.textContent = "ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø¨Ø®Ø´ Â«Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡Â» Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.`;
    btn.textContent   = "ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "block";
  } else {
    title.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!`;
    btn.textContent   = "ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ù†";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "none";
  }
  modal.style.display = "flex";
}

function closeModal() { document.getElementById("bulk-modal").style.display = "none"; }

async function confirmBulk() {
  const reason = document.getElementById("bulk-reason").value.trim();
  closeModal();
  try {
    const res = await fetch(BULK_URL, {
      method:  "POST",
      headers: { "Content-Type":"application/json","X-CSRFToken":CSRF },
      body:    JSON.stringify({
        action:     pendingAction,
        player_ids: [...selectedIds],
        reason:     reason,
      }),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    const msg = data.action === "archive"
      ? `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯`
      : `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø­Ø°Ù Ø´Ø¯`;

    // Ø­Ø°Ù Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø² DOM
    selectedIds.forEach(id => {
      const row = document.getElementById("row-" + id);
      if (row) {
        row.style.transition = "opacity .3s, transform .3s";
        row.style.opacity    = "0";
        row.style.transform  = "translateX(20px)";
        setTimeout(() => row.remove(), 300);
      }
    });

    clearSelection();
    showToast("âœ… " + msg, "ok");
    setTimeout(() => location.reload(), 1200);

  } catch (err) {
    showToast("âŒ " + err.message, "err");
  }
}

function showToast(msg, type) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);
    background:${type==="ok"?"#10b981":"#ef4444"};color:#fff;
    padding:.6rem 1.25rem;border-radius:99px;font-size:.85rem;font-weight:700;
    z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);white-space:nowrap`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2700);
}
</script>
{% endif %}

{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span><span class="cur">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</span>

<!-- Bulk Action Modal -->
<div id="bulk-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:1rem" id="modal-title">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div style="margin-bottom:1.25rem">
      <label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:.35rem">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="bulk-reason" rows="2" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ..."
                style="width:100%;padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.85rem;resize:none"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-red" id="modal-confirm-btn" onclick="confirmBulk()">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>

{% if request.user.is_technical_director or request.user.is_superuser %}
<script>
const BULK_URL = "{% url 'registration:player-bulk-action' %}";
const CSRF     = "{{ csrf_token }}";
let selectedIds  = new Set();
let pendingAction = "";

function onCheck(cb) {
  const id = parseInt(cb.value);
  if (cb.checked) selectedIds.add(id);
  else            selectedIds.delete(id);
  updateBulkBar();
  document.getElementById("row-" + id).style.background = cb.checked ? "#fffbeb" : "";
}

function toggleAll(masterCb) {
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = masterCb.checked;
    onCheck(cb);
  });
}

function rowClick(e, id) {
  // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒØ´Ù‡ (Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„)
  if (e.target.tagName === "A" || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
  const cb = document.querySelector(`.row-check[value="${id}"]`);
  if (cb) { cb.checked = !cb.checked; onCheck(cb); }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = false;
    document.getElementById("row-" + cb.value).style.background = "";
  });
  const master = document.getElementById("check-all");
  if (master) master.checked = false;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById("bulk-bar");
  const lbl = document.getElementById("sel-label");
  bar.style.display = selectedIds.size > 0 ? "flex" : "none";
  lbl.textContent   = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
}

function bulkAction(action) {
  if (selectedIds.size === 0) return;
  pendingAction = action;
  const modal = document.getElementById("bulk-modal");
  const title = document.getElementById("modal-title");
  const desc  = document.getElementById("modal-desc");
  const btn   = document.getElementById("modal-confirm-btn");

  if (action === "archive") {
    title.textContent = "ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø¨Ø®Ø´ Â«Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡Â» Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.`;
    btn.textContent   = "ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "block";
  } else {
    title.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!`;
    btn.textContent   = "ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ù†";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "none";
  }
  modal.style.display = "flex";
}

function closeModal() { document.getElementById("bulk-modal").style.display = "none"; }

async function confirmBulk() {
  const reason = document.getElementById("bulk-reason").value.trim();
  closeModal();
  try {
    const res = await fetch(BULK_URL, {
      method:  "POST",
      headers: { "Content-Type":"application/json","X-CSRFToken":CSRF },
      body:    JSON.stringify({
        action:     pendingAction,
        player_ids: [...selectedIds],
        reason:     reason,
      }),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    const msg = data.action === "archive"
      ? `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯`
      : `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø­Ø°Ù Ø´Ø¯`;

    // Ø­Ø°Ù Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø² DOM
    selectedIds.forEach(id => {
      const row = document.getElementById("row-" + id);
      if (row) {
        row.style.transition = "opacity .3s, transform .3s";
        row.style.opacity    = "0";
        row.style.transform  = "translateX(20px)";
        setTimeout(() => row.remove(), 300);
      }
    });

    clearSelection();
    showToast("âœ… " + msg, "ok");
    setTimeout(() => location.reload(), 1200);

  } catch (err) {
    showToast("âŒ " + err.message, "err");
  }
}

function showToast(msg, type) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);
    background:${type==="ok"?"#10b981":"#ef4444"};color:#fff;
    padding:.6rem 1.25rem;border-radius:99px;font-size:.85rem;font-weight:700;
    z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);white-space:nowrap`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2700);
}
</script>
{% endif %}

{% endblock %}

{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div>
    <h1 style="font-size:1.25rem;font-weight:900;color:var(--navy)">ğŸ‘¥ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h1>
    <p style="font-size:.82rem;color:var(--text-muted);margin-top:.2rem">{{ total_count }} Ø¨Ø§Ø²ÛŒÚ©Ù† ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡</p>
  </div>
  <div style="display:flex;gap:.5rem">
    <a href="{% url 'registration:applicant-list' %}" class="btn btn-outline btn-sm">ğŸ“‹ Ù…ØªÙ‚Ø§Ø¶ÛŒØ§Ù† Ø¬Ø¯ÛŒØ¯</a>
    <a href="{% url 'registration:bulk-import' %}" class="btn btn-navy btn-sm">ğŸ“¥ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ú©Ø³Ù„</a>
    <a href="{% url 'registration:recycle-bin' %}" class="btn btn-sm" style="border:1.5px solid #ef4444;color:#ef4444">ğŸ—‘ï¸ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡</a>
  </div>
</div>

{% if request.user.is_technical_director or request.user.is_superuser %}
<!-- Bulk action bar - initially hidden -->
<div id="bulk-bar" style="display:none;background:#fff;border:1.5px solid var(--amber);border-radius:var(--radius);padding:.65rem 1rem;margin-bottom:.85rem;align-items:center;gap:.75rem;flex-wrap:wrap">
  <span style="font-weight:700;font-size:.85rem;color:var(--navy)" id="sel-label">Û° Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡</span>
  <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-right:auto">
    <button class="btn btn-sm" style="border:1.5px solid var(--red);color:var(--red)"
            onclick="bulkAction('archive')">ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡</button>

    <button class="btn btn-outline btn-sm" onclick="clearSelection()">âœ• Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨</button>
  </div>
</div>
{% endif %}

<!-- Filter -->
<div class="card" style="padding:.85rem 1rem;margin-bottom:1rem">
  <form method="get" style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:center">
    <input type="text" name="q" value="{{ q }}"
           placeholder="Ù†Ø§Ù…ØŒ Ú©Ø¯ Ù…Ù„ÛŒØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„..."
           style="padding:.55rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.875rem;flex:1;min-width:180px">
    <select name="category"
            style="padding:.55rem .75rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.875rem">
      <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
      {% for cat in all_categories %}
      <option value="{{ cat.pk }}" {% if category_filter == cat.pk|stringformat:"i" %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary btn-sm">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
    {% if q or category_filter %}<a href="?" class="btn btn-outline btn-sm">âœ• Ù¾Ø§Ú©</a>{% endif %}
  </form>
</div>

<!-- ÙÛŒÙ„ØªØ± Ø±Ø¯Ù‡ Ø³Ù†ÛŒ -->
{% if age_category_counts %}
<div style="margin-bottom:.75rem;display:flex;gap:.35rem;flex-wrap:wrap;align-items:center">
  <span style="font-size:.75rem;font-weight:700;color:var(--text-muted)">ğŸ§’ Ø±Ø¯Ù‡ Ø³Ù†ÛŒ:</span>
  <a href="{% url 'training:player-list' %}{% if q or category_filter %}?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category={{ category_filter }}{% endif %}{% endif %}"
     class="btn btn-sm {% if not age_filter %}btn-navy{% else %}btn-outline{% endif %}"
     style="border-radius:99px;padding:.25rem .7rem;font-size:.75rem">Ù‡Ù…Ù‡</a>
  {% for cat, cnt in age_category_counts %}
  <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}age_cat={{ cat }}"
     class="btn btn-sm {% if age_filter == cat %}btn-navy{% else %}btn-outline{% endif %}"
     style="border-radius:99px;padding:.25rem .7rem;font-size:.75rem">
    {{ cat }} <span style="opacity:.7">({{ cnt }})</span>
  </a>
  {% endfor %}
</div>
{% endif %}

<!-- Table -->
{% if players %}
<div class="card">
  <div class="table-wrap">
    <table class="data-table">
      <thead>
        <tr>
          <th style="width:36px">
            {% if request.user.is_technical_director or request.user.is_superuser %}
            <input type="checkbox" id="check-all" onclick="toggleAll(this)"
                   style="accent-color:var(--navy);width:15px;height:15px">
            {% endif %}
          </th>
          <th>#</th>
          <th>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</th>
          <th>Ú©Ø¯ Ù…Ù„ÛŒ</th>
          <th>Ù…ÙˆØ¨Ø§ÛŒÙ„</th>
          <th>Ù¾Ø¯Ø±</th>
          <th>Ø±Ø¯Ù‡ Ø³Ù†ÛŒ</th>
          <th>Ø¯Ø³ØªÙ‡</th>
          <th>Ø¨ÛŒÙ…Ù‡</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for player in players %}
        <tr id="row-{{ player.pk }}" onclick="rowClick(event, {{ player.pk }})">
          <td>
            {% if request.user.is_technical_director or request.user.is_superuser %}
            <input type="checkbox" class="row-check" value="{{ player.pk }}"
                   onclick="event.stopPropagation();onCheck(this)"
                   style="accent-color:var(--navy);width:15px;height:15px">
            {% endif %}
          </td>
          <td style="color:var(--text-muted);font-size:.8rem">
            {{ page_obj.start_index|add:forloop.counter0 }}
          </td>
          <td>
            <strong>{{ player.first_name }} {{ player.last_name }}</strong>
            <div style="font-size:.72rem;color:var(--text-muted)">{{ player.father_name }}</div>
          </td>
          <td style="font-family:monospace;font-size:.82rem">{{ player.national_id }}</td>
          <td style="font-size:.82rem">{{ player.phone }}</td>
          <td style="font-size:.82rem">{{ player.father_phone }}</td>
          <td style="font-size:.78rem;font-weight:700;color:var(--navy)">
            {% if player.dob %}{{ player.get_age_category }}{% else %}â€”{% endif %}
          </td>
          <td>
            {% for cat in player.categories.all %}
            <span style="background:rgba(14,165,233,.1);color:var(--teal);border-radius:6px;padding:.15rem .5rem;font-size:.7rem;font-weight:600">{{ cat.name }}</span>
            {% empty %}<span style="color:var(--text-muted);font-size:.75rem">â€”</span>
            {% endfor %}
          </td>
          <td>
            {% if player.insurance_status == 'active' %}
              <span class="badge badge-green">âœ…</span>
            {% else %}
              <span class="badge badge-red">âŒ</span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'training:player-profile' player.pk %}"
               class="btn btn-outline btn-sm">ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div style="display:flex;justify-content:center;gap:.4rem;margin-top:1rem">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„ÛŒ</a>
  {% endif %}
  <span style="padding:.5rem .85rem;font-size:.82rem;color:var(--text-muted)">
    ØµÙØ­Ù‡ {{ page_obj.number }} Ø§Ø² {{ page_obj.paginator.num_pages }}
  </span>
  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ÛŒ â†’</a>
  {% endif %}
</div>
{% endif %}

{% else %}
<div class="card" style="text-align:center;padding:3rem">
  <div style="font-size:3rem;margin-bottom:1rem">ğŸ‘¥</div>
  <h3 style="font-weight:800;margin-bottom:.5rem">Ù‡ÛŒÚ† Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
  <p style="color:var(--text-muted);font-size:.875rem">
    {% if q %}Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Â«{{ q }}Â» Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯{% else %}Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒÚ©Ù† ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯{% endif %}
  </p>
</div>
{% endif %}


<!-- Bulk Action Modal -->
<div id="bulk-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:1rem" id="modal-title">Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div style="margin-bottom:1.25rem">
      <label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:.35rem">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="bulk-reason" rows="2" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ..."
                style="width:100%;padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.85rem;resize:none"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-red" id="modal-confirm-btn" onclick="confirmBulk()">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>

{% if request.user.is_technical_director or request.user.is_superuser %}
<script>
const BULK_URL = "{% url 'registration:player-bulk-action' %}";
const CSRF     = "{{ csrf_token }}";
let selectedIds  = new Set();
let pendingAction = "";

function onCheck(cb) {
  const id = parseInt(cb.value);
  if (cb.checked) selectedIds.add(id);
  else            selectedIds.delete(id);
  updateBulkBar();
  document.getElementById("row-" + id).style.background = cb.checked ? "#fffbeb" : "";
}

function toggleAll(masterCb) {
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = masterCb.checked;
    onCheck(cb);
  });
}

function rowClick(e, id) {
  // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø±ÙˆÛŒ Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒØ´Ù‡ (Ù†Ù‡ Ø¯Ú©Ù…Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„)
  if (e.target.tagName === "A" || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
  const cb = document.querySelector(`.row-check[value="${id}"]`);
  if (cb) { cb.checked = !cb.checked; onCheck(cb); }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll(".row-check").forEach(cb => {
    cb.checked = false;
    document.getElementById("row-" + cb.value).style.background = "";
  });
  const master = document.getElementById("check-all");
  if (master) master.checked = false;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById("bulk-bar");
  const lbl = document.getElementById("sel-label");
  bar.style.display = selectedIds.size > 0 ? "flex" : "none";
  lbl.textContent   = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡`;
}

function bulkAction(action) {
  if (selectedIds.size === 0) return;
  pendingAction = action;
  const modal = document.getElementById("bulk-modal");
  const title = document.getElementById("modal-title");
  const desc  = document.getElementById("modal-desc");
  const btn   = document.getElementById("modal-confirm-btn");

  if (action === "archive") {
    title.textContent = "ğŸ“¦ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø¨Ø®Ø´ Â«Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡Â» Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.`;
    btn.textContent   = "ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "block";
  } else {
    title.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ø¯Ø§Ø¦Ù…ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†";
    desc.textContent  = `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!`;
    btn.textContent   = "ğŸ—‘ï¸ Ø­Ø°Ù Ú©Ù†";
    btn.className     = "btn btn-red";
    document.getElementById("bulk-reason").style.display = "none";
  }
  modal.style.display = "flex";
}

function closeModal() { document.getElementById("bulk-modal").style.display = "none"; }

async function confirmBulk() {
  const reason = document.getElementById("bulk-reason").value.trim();
  closeModal();
  try {
    const res = await fetch(BULK_URL, {
      method:  "POST",
      headers: { "Content-Type":"application/json","X-CSRFToken":CSRF },
      body:    JSON.stringify({
        action:     pendingAction,
        player_ids: [...selectedIds],
        reason:     reason,
      }),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    const msg = data.action === "archive"
      ? `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯`
      : `${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø­Ø°Ù Ø´Ø¯`;

    // Ø­Ø°Ù Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ø² DOM
    selectedIds.forEach(id => {
      const row = document.getElementById("row-" + id);
      if (row) {
        row.style.transition = "opacity .3s, transform .3s";
        row.style.opacity    = "0";
        row.style.transform  = "translateX(20px)";
        setTimeout(() => row.remove(), 300);
      }
    });

    clearSelection();
    showToast("âœ… " + msg, "ok");
    setTimeout(() => location.reload(), 1200);

  } catch (err) {
    showToast("âŒ " + err.message, "err");
  }
}

function showToast(msg, type) {
  const el = document.createElement("div");
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);
    background:${type==="ok"?"#10b981":"#ef4444"};color:#fff;
    padding:.6rem 1.25rem;border-radius:99px;font-size:.85rem;font-weight:700;
    z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2);white-space:nowrap`;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2700);
}
</script>
{% endif %}

{% endblock %}