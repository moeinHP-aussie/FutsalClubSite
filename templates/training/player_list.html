{% extends "base.html" %}
{% block title %}Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†{% endblock %}
{% block nav_players %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span><span class="cur">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</span>
{% endblock %}

{% block extra_head %}
<style>
/* ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ */
.adv-filter-panel {
  display:none; background:#f8fafc; border:1.5px solid var(--surface-2);
  border-radius:var(--radius); padding:1rem 1.25rem; margin-bottom:.85rem;
}
.adv-filter-panel.open { display:block; }
.filter-row { display:flex; flex-wrap:wrap; gap:.65rem; align-items:flex-end; margin-bottom:.65rem; }
.filter-row:last-child { margin-bottom:0; }
.filter-group { display:flex; flex-direction:column; gap:.2rem; }
.filter-label { font-size:.72rem; font-weight:800; color:var(--text-muted); }
.filter-select {
  padding:.4rem .65rem; border:1.5px solid var(--surface-2); border-radius:8px;
  font-family:inherit; font-size:.82rem; background:#fff; cursor:pointer;
}

/* ØªÙ†Ø¸ÛŒÙ… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ */
.col-toggle-bar {
  display:flex; flex-wrap:wrap; gap:.3rem; align-items:center;
  padding:.6rem .85rem; background:#fff; border:1.5px solid var(--surface-2);
  border-radius:var(--radius); margin-bottom:.75rem;
}
.col-chip {
  display:flex; align-items:center; gap:.25rem; padding:.2rem .55rem;
  border-radius:99px; font-size:.72rem; font-weight:700; cursor:pointer;
  border:1.5px solid var(--surface-2); background:var(--surface-2);
  color:var(--text-muted); transition:.12s; user-select:none;
}
.col-chip.active { background:#dbeafe; border-color:#93c5fd; color:#1e3a8a; }

/* Ø±Ø¯Ù‡ Ø³Ù†ÛŒ chip */
.age-chip {
  display:inline-flex; align-items:center; gap:.25rem;
  padding:.25rem .7rem; border-radius:99px; font-size:.75rem; font-weight:700;
  text-decoration:none; border:1.5px solid var(--surface-2);
  background:var(--surface-2); color:var(--text-muted); transition:.12s;
}
.age-chip:hover { border-color:var(--navy); color:var(--navy); }
.age-chip.active { background:var(--navy); border-color:var(--navy); color:#fff; }

/* bulk bar */
#bulk-bar {
  display:none; position:sticky; top:0; z-index:100;
  background:#fffbeb; border:1.5px solid var(--amber);
  border-radius:var(--radius); padding:.65rem 1rem;
  margin-bottom:.75rem; align-items:center; gap:.6rem; flex-wrap:wrap;
}
</style>
{% endblock %}

{% block content %}

<!-- Bulk Archive Modal -->
<div id="bulk-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:14px;padding:1.75rem;max-width:460px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.25)">
    <h3 style="font-size:1rem;font-weight:900;color:var(--navy);margin-bottom:1rem">ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡</h3>
    <p style="font-size:.875rem;color:var(--text-muted);margin-bottom:1rem" id="modal-desc"></p>
    <div style="margin-bottom:1.25rem">
      <label style="font-size:.85rem;font-weight:700;display:block;margin-bottom:.35rem">Ø¯Ù„ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="bulk-reason" rows="2" placeholder="Ø¯Ù„ÛŒÙ„ Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ..."
                style="width:100%;padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.85rem;resize:none"></textarea>
    </div>
    <div style="display:flex;gap:.6rem;justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeBulkModal()">Ø§Ù†ØµØ±Ø§Ù</button>
      <button class="btn btn-red" onclick="confirmBulk()">ØªØ£ÛŒÛŒØ¯</button>
    </div>
  </div>
</div>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1rem">
  <div>
    <h1 style="font-size:1.1rem;font-weight:900;color:var(--navy)">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h1>
    <p style="font-size:.82rem;color:var(--text-muted)">{{ total_count }} Ø¨Ø§Ø²ÛŒÚ©Ù† ÙØ¹Ø§Ù„</p>
  </div>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    {% if request.user.is_technical_director or request.user.is_superuser %}
    <a href="{% url 'registration:bulk-import' %}" class="btn btn-navy btn-sm">ğŸ“¥ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø§Ú©Ø³Ù„</a>
    {% endif %}
    <a href="{% url 'registration:recycle-bin' %}" class="btn btn-sm" style="border:1.5px solid #ef4444;color:#ef4444">ğŸ—‘ï¸ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡</a>
  </div>
</div>

<!-- â”€â”€ Ø¬Ø³ØªØ¬Ùˆ + ÙÛŒÙ„ØªØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<form method="get" id="filter-form">
  <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.65rem">
    <input type="text" name="q" value="{{ q }}"
           placeholder="ğŸ” Ù†Ø§Ù…ØŒ Ú©Ø¯ Ù…Ù„ÛŒØŒ Ù…ÙˆØ¨Ø§ÛŒÙ„..."
           style="flex:1;min-width:180px;max-width:260px;padding:.55rem .85rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.875rem">

    <select name="category" class="filter-select" style="min-width:140px">
      <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§</option>
      {% for cat in all_categories %}
      <option value="{{ cat.pk }}" {% if category_filter == cat.pk|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>

    <button type="button" class="btn btn-outline btn-sm"
            onclick="document.getElementById('adv-filter').classList.toggle('open')">
      âš™ï¸ ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ {% if has_adv_filter %}â—{% endif %}
    </button>
    <button type="submit" class="btn btn-primary btn-sm">Ø¬Ø³ØªØ¬Ùˆ</button>
    {% if q or category_filter or has_adv_filter %}<a href="?" class="btn btn-outline btn-sm">âœ• Ù¾Ø§Ú©</a>{% endif %}
  </div>

  <!-- â”€â”€ ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="adv-filter-panel {% if has_adv_filter %}open{% endif %}" id="adv-filter">
    <div style="font-size:.75rem;font-weight:800;color:var(--navy);margin-bottom:.75rem;text-transform:uppercase;letter-spacing:.06em">âš™ï¸ ÙÛŒÙ„ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡</div>
    <div class="filter-row">
      <div class="filter-group">
        <span class="filter-label">Ù¾Ø³Øª</span>
        <select name="position" class="filter-select">
          <option value="">Ù‡Ù…Ù‡ Ù¾Ø³Øªâ€ŒÙ‡Ø§</option>
          <option value="gk" {% if filter_position == 'gk' %}selected{% endif %}>ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</option>
          <option value="fixo" {% if filter_position == 'fixo' %}selected{% endif %}>ğŸ›¡ï¸ ÙÛŒÚ©Ø³Ùˆ</option>
          <option value="winger" {% if filter_position == 'winger' %}selected{% endif %}>ğŸ’¨ ÙˆÛŒÙ†Ú¯Ø±</option>
          <option value="pivot" {% if filter_position == 'pivot' %}selected{% endif %}>âš¡ Ù¾ÛŒÙˆØª</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Ø³Ø·Ø­ Ù…Ù‡Ø§Ø±Øª</span>
        <select name="skill_level" class="filter-select">
          <option value="">Ù‡Ù…Ù‡ Ø³Ø·ÙˆØ­</option>
          {% for lv in "ABCDEF" %}
          <option value="{{ lv }}" {% if filter_skill == lv %}selected{% endif %}>{{ lv }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Ù¾Ø§ÛŒ Ø¨Ø±ØªØ±</span>
        <select name="preferred_foot" class="filter-select">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="right" {% if filter_foot == 'right' %}selected{% endif %}>Ø±Ø§Ø³Øª</option>
          <option value="left" {% if filter_foot == 'left' %}selected{% endif %}>Ú†Ù¾</option>
          <option value="both" {% if filter_foot == 'both' %}selected{% endif %}>Ù‡Ø± Ø¯Ùˆ</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Ø¯Ùˆâ€ŒÙ¾Ø§</span>
        <select name="two_footed" class="filter-select">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="1" {% if filter_two_footed == '1' %}selected{% endif %}>Ø¨Ù„Ù‡</option>
          <option value="0" {% if filter_two_footed == '0' %}selected{% endif %}>Ø®ÛŒØ±</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡</span>
        <select name="insurance" class="filter-select">
          <option value="">Ù‡Ù…Ù‡</option>
          <option value="active" {% if filter_insurance == 'active' %}selected{% endif %}>âœ… ÙØ¹Ø§Ù„</option>
          <option value="none" {% if filter_insurance == 'none' %}selected{% endif %}>âŒ Ù†Ø¯Ø§Ø±Ø¯</option>
          <option value="expired" {% if filter_insurance == 'expired' %}selected{% endif %}>âš ï¸ Ù…Ù†Ù‚Ø¶ÛŒ</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:.5rem">
      <button type="submit" class="btn btn-navy btn-sm">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
    </div>
  </div>
</form>

<!-- â”€â”€ ÙÛŒÙ„ØªØ± Ø±Ø¯Ù‡ Ø³Ù†ÛŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if age_category_counts %}
<div style="display:flex;gap:.3rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem">
  <span style="font-size:.75rem;font-weight:800;color:var(--text-muted)">ğŸ§’ Ø±Ø¯Ù‡ Ø³Ù†ÛŒ:</span>
  <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}"
     class="age-chip {% if not age_filter %}active{% endif %}">Ù‡Ù…Ù‡</a>
  {% for cat, cnt in age_category_counts %}
  <a href="?{% if q %}q={{ q }}&{% endif %}{% if category_filter %}category={{ category_filter }}&{% endif %}age_cat={{ cat }}"
     class="age-chip {% if age_filter == cat %}active{% endif %}">
    {{ cat }} <span style="opacity:.7">({{ cnt }})</span>
  </a>
  {% endfor %}
</div>
{% endif %}

<!-- â”€â”€ ØªÙ†Ø¸ÛŒÙ… Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="col-toggle-bar" id="col-toggle-bar">
  <span style="font-size:.72rem;font-weight:800;color:var(--text-muted)">Ø³ØªÙˆÙ†â€ŒÙ‡Ø§:</span>
  <span class="col-chip active" data-col="national_id" onclick="toggleCol(this)">Ú©Ø¯ Ù…Ù„ÛŒ</span>
  <span class="col-chip active" data-col="phone" onclick="toggleCol(this)">Ù…ÙˆØ¨Ø§ÛŒÙ„</span>
  <span class="col-chip active" data-col="father" onclick="toggleCol(this)">Ù¾Ø¯Ø±</span>
  <span class="col-chip active" data-col="age_cat" onclick="toggleCol(this)">Ø±Ø¯Ù‡ Ø³Ù†ÛŒ</span>
  <span class="col-chip active" data-col="category" onclick="toggleCol(this)">Ø¯Ø³ØªÙ‡</span>
  <span class="col-chip active" data-col="insurance" onclick="toggleCol(this)">Ø¨ÛŒÙ…Ù‡</span>
  <span class="col-chip" data-col="position" onclick="toggleCol(this)">Ù¾Ø³Øª</span>
  <span class="col-chip" data-col="skill" onclick="toggleCol(this)">Ø³Ø·Ø­</span>
  <span class="col-chip" data-col="shirt" onclick="toggleCol(this)">Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒØ±Ø§Ù‡Ù†</span>
  <span class="col-chip" data-col="foot" onclick="toggleCol(this)">Ù¾Ø§ÛŒ Ø¨Ø±ØªØ±</span>
</div>

<!-- â”€â”€ Bulk bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if request.user.is_technical_director or request.user.is_superuser %}
<div id="bulk-bar" style="display:none;background:#fffbeb;border:1.5px solid var(--amber);border-radius:var(--radius);padding:.65rem 1rem;margin-bottom:.75rem;align-items:center;gap:.6rem;flex-wrap:wrap">
  <span id="bulk-label" style="font-size:.85rem;font-weight:700">Û° Ù†ÙØ± Ø§Ù†ØªØ®Ø§Ø¨</span>
  <button class="btn btn-amber btn-sm" onclick="bulkAction('archive')">ğŸ“¦ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡</button>
  <button class="btn btn-outline btn-sm" onclick="clearSelection()">âœ• Ù„ØºÙˆ</button>
</div>
{% endif %}

<!-- â”€â”€ Ø¬Ø¯ÙˆÙ„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if players %}
<div class="card">
  <div class="table-wrap">
    <table class="data-table" id="players-table">
      <thead>
        <tr>
          {% if request.user.is_technical_director or request.user.is_superuser %}
          <th style="width:36px">
            <input type="checkbox" id="check-all" onclick="toggleAll(this)"
                   style="accent-color:var(--navy);width:15px;height:15px">
          </th>
          {% endif %}
          <th>#</th>
          <th>Ù†Ø§Ù…</th>
          <th class="col-national_id">Ú©Ø¯ Ù…Ù„ÛŒ</th>
          <th class="col-phone">Ù…ÙˆØ¨Ø§ÛŒÙ„</th>
          <th class="col-father">Ù¾Ø¯Ø±</th>
          <th class="col-age_cat">Ø±Ø¯Ù‡ Ø³Ù†ÛŒ</th>
          <th class="col-category">Ø¯Ø³ØªÙ‡</th>
          <th class="col-insurance">Ø¨ÛŒÙ…Ù‡</th>
          <th class="col-position" style="display:none">Ù¾Ø³Øª</th>
          <th class="col-skill" style="display:none">Ø³Ø·Ø­</th>
          <th class="col-shirt" style="display:none">Ù¾ÛŒØ±Ø§Ù‡Ù†</th>
          <th class="col-foot" style="display:none">Ù¾Ø§</th>
          <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
        </tr>
      </thead>
      <tbody>
        {% for player in players %}
        <tr id="row-{{ player.pk }}" onclick="rowClick(event, {{ player.pk }})" style="cursor:pointer">
          {% if request.user.is_technical_director or request.user.is_superuser %}
          <td>
            <input type="checkbox" class="row-check" value="{{ player.pk }}"
                   onclick="event.stopPropagation();onCheck(this)"
                   style="accent-color:var(--navy);width:15px;height:15px">
          </td>
          {% endif %}
          <td style="color:var(--text-muted);font-size:.78rem">{{ forloop.counter }}</td>
          <td>
            <strong style="font-size:.875rem">{{ player.first_name }} {{ player.last_name }}</strong>
          </td>
          <td class="col-national_id" style="font-family:monospace;font-size:.8rem">{{ player.national_id }}</td>
          <td class="col-phone" style="font-size:.82rem">{{ player.phone }}</td>
          <td class="col-father" style="font-size:.78rem;color:var(--text-muted)">{{ player.father_phone }}</td>
          <td class="col-age_cat" style="font-size:.78rem;font-weight:700;color:var(--navy)">
            {% if player.dob %}{{ player.get_age_category }}{% else %}â€”{% endif %}
          </td>
          <td class="col-category">
            {% for cat in player.categories.all %}
            <span style="background:rgba(14,165,233,.1);color:var(--teal);border-radius:6px;padding:.1rem .4rem;font-size:.68rem;font-weight:600;white-space:nowrap">{{ cat.name }}</span>
            {% empty %}<span style="color:var(--text-muted);font-size:.72rem">â€”</span>
            {% endfor %}
          </td>
          <td class="col-insurance">
            {% if player.insurance_status == 'active' %}<span class="badge badge-green" style="font-size:.68rem">âœ…</span>
            {% else %}<span class="badge badge-red" style="font-size:.68rem">âŒ</span>{% endif %}
          </td>
          <!-- Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù† - ÙÙ†ÛŒ -->
          <td class="col-position" style="display:none;font-size:.78rem">
            {% if player.technical_profile.position and player.technical_profile.position != '-' %}
              {{ player.technical_profile.get_position_display }}
            {% else %}â€”{% endif %}
          </td>
          <td class="col-skill" style="display:none;font-size:.78rem;font-weight:700">
            {{ player.technical_profile.skill_level|default:"â€”" }}
          </td>
          <td class="col-shirt" style="display:none;font-size:.78rem;font-weight:800;color:var(--navy)">
            {% if player.technical_profile.shirt_number %}#{{ player.technical_profile.shirt_number }}{% else %}â€”{% endif %}
          </td>
          <td class="col-foot" style="display:none;font-size:.78rem">
            {{ player.get_preferred_foot_display|default:"â€”" }}
          </td>
          <td>
            <a href="{% url 'training:player-profile' player.pk %}"
               class="btn btn-outline btn-sm" onclick="event.stopPropagation()">ğŸ‘¤</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<div style="display:flex;justify-content:center;gap:.4rem;margin-top:.85rem">
  {% if page_obj.has_previous %}
  <a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if age_filter %}&age_cat={{ age_filter }}{% endif %}" class="btn btn-outline btn-sm">â† Ù‚Ø¨Ù„ÛŒ</a>
  {% endif %}
  <span style="padding:.5rem .85rem;font-size:.82rem;color:var(--text-muted)">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
  {% if page_obj.has_next %}
  <a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if age_filter %}&age_cat={{ age_filter }}{% endif %}" class="btn btn-outline btn-sm">Ø¨Ø¹Ø¯ÛŒ â†’</a>
  {% endif %}
</div>
{% endif %}

{% else %}
<div class="card" style="text-align:center;padding:3rem">
  <div style="font-size:3rem;opacity:.4;margin-bottom:.75rem">âš½</div>
  <h3 style="font-weight:800">Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
  <p style="color:var(--text-muted);font-size:.875rem;margin-top:.35rem">
    {% if q or category_filter or has_adv_filter or age_filter %}ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯{% else %}Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡{% endif %}
  </p>
</div>
{% endif %}

<script>
// â”€â”€ Column visibility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COL_KEY = 'player_list_cols';
let activeCols = JSON.parse(localStorage.getItem(COL_KEY) || 'null');
// default: show all "active" chips
if (!activeCols) {
  activeCols = ['national_id','phone','father','age_cat','category','insurance'];
}

function applyColVisibility() {
  const allCols = ['national_id','phone','father','age_cat','category','insurance','position','skill','shirt','foot'];
  allCols.forEach(col => {
    const show = activeCols.includes(col);
    document.querySelectorAll(`.col-${col}`).forEach(el => el.style.display = show ? '' : 'none');
    const chip = document.querySelector(`[data-col="${col}"]`);
    if (chip) chip.classList.toggle('active', show);
  });
}

function toggleCol(chip) {
  const col = chip.dataset.col;
  if (activeCols.includes(col)) {
    activeCols = activeCols.filter(c => c !== col);
  } else {
    activeCols.push(col);
  }
  localStorage.setItem(COL_KEY, JSON.stringify(activeCols));
  applyColVisibility();
}

// â”€â”€ Bulk actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BULK_URL = "{% url 'registration:player-bulk-action' %}";
const CSRF     = "{{ csrf_token }}";
let selectedIds = new Set();

function onCheck(cb) {
  const id = parseInt(cb.value);
  if (cb.checked) selectedIds.add(id);
  else            selectedIds.delete(id);
  updateBulkBar();
  document.getElementById('row-' + id).style.background = cb.checked ? '#fffbeb' : '';
}

function toggleAll(cb) {
  document.querySelectorAll('.row-check').forEach(c => {
    c.checked = cb.checked;
    onCheck(c);
  });
}

function rowClick(e, id) {
  if (['A','INPUT','BUTTON','SPAN'].includes(e.target.tagName)) return;
  const cb = document.querySelector(`.row-check[value="${id}"]`);
  if (cb) { cb.checked = !cb.checked; onCheck(cb); }
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll('.row-check').forEach(c => { c.checked = false; });
  document.querySelectorAll('tr[id^=row-]').forEach(r => r.style.background = '');
  document.getElementById('check-all').checked = false;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  if (!bar) return;
  bar.style.display = selectedIds.size > 0 ? 'flex' : 'none';
  document.getElementById('bulk-label').textContent = `${selectedIds.size} Ù†ÙØ± Ø§Ù†ØªØ®Ø§Ø¨`;
}

function bulkAction(action) {
  document.getElementById('modal-desc').textContent =
    `${selectedIds.size} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯.`;
  document.getElementById('bulk-modal').style.display = 'flex';
}

function closeBulkModal() {
  document.getElementById('bulk-modal').style.display = 'none';
}

async function confirmBulk() {
  const reason = document.getElementById('bulk-reason').value;
  closeBulkModal();
  try {
    const res = await fetch(BULK_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json','X-CSRFToken':CSRF},
      body: JSON.stringify({action:'archive', player_ids:[...selectedIds], reason}),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);
    selectedIds.forEach(id => {
      const row = document.getElementById('row-' + id);
      if (row) { row.style.opacity='0'; row.style.transition='.3s'; setTimeout(()=>row.remove(),300); }
    });
    selectedIds.clear();
    updateBulkBar();
    showToast(`âœ… ${data.count} Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¨Ù‡ Ø³Ø·Ù„ Ø²Ø¨Ø§Ù„Ù‡ Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯`);
  } catch(e) { showToast('âŒ ' + e.message, 'err'); }
}

function showToast(msg, type='ok') {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = `position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:${type==='ok'?'#10b981':'#ef4444'};color:#fff;padding:.6rem 1.25rem;border-radius:99px;font-size:.85rem;font-weight:700;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,.2)`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 3000);
}

// Init
applyColVisibility();
</script>

{% endblock %}