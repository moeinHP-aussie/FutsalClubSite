{% extends "base.html" %}
{% block title %}{{ coach.first_name }} {{ coach.last_name }}{% endblock %}
{% block nav_coaches %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'training:coach-list' %}" style="text-decoration:none;color:inherit">Ù…Ø±Ø¨ÛŒØ§Ù†</a>
  <span class="sep">â€º</span><span class="cur">{{ coach.first_name }} {{ coach.last_name }}</span>
{% endblock %}

{% block content %}

{% if messages %}
{% for msg in messages %}
<div style="background:{% if msg.level == 25 %}#d1fae5{% else %}#fee2e2{% endif %};border-radius:8px;padding:.65rem 1rem;margin-bottom:.85rem;font-size:.875rem;font-weight:600">{{ msg }}</div>
{% endfor %}
{% endif %}

<!-- Header -->
<div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:.75rem;margin-bottom:1.25rem">
  <div style="display:flex;align-items:center;gap:.85rem">
    <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--navy));display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:#fff;font-weight:900;flex-shrink:0">
      {{ coach.first_name|slice:":1" }}{{ coach.last_name|slice:":1" }}
    </div>
    <div>
      <h1 style="font-size:1.2rem;font-weight:900;color:var(--navy)">
        {{ coach.first_name }} {{ coach.last_name }}
        {% if coach.is_active %}<span class="badge badge-green" style="margin-right:.5rem">ÙØ¹Ø§Ù„</span>
        {% else %}<span class="badge" style="background:#f1f5f9;color:#64748b;margin-right:.5rem">ØºÛŒØ±ÙØ¹Ø§Ù„</span>{% endif %}
      </h1>
      <p style="font-size:.82rem;color:var(--text-muted)">{{ coach.get_degree_display|default:"Ù…Ø¯Ø±Ú© Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡" }}</p>
    </div>
  </div>
  {% if request.user.is_technical_director or request.user.is_superuser %}
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <a href="{% url 'training:coach-update' coach.pk %}" class="btn btn-navy btn-sm">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</a>
    <form method="post" action="{% url 'training:coach-toggle' coach.pk %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-sm"
              style="border:1.5px solid {% if coach.is_active %}var(--red){% else %}var(--green){% endif %};color:{% if coach.is_active %}var(--red){% else %}var(--green){% endif %}">
        {% if coach.is_active %}ğŸš« ØºÛŒØ±ÙØ¹Ø§Ù„{% else %}âœ… ÙØ¹Ø§Ù„{% endif %}
      </button>
    </form>
  </div>
  {% endif %}
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">

  <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
  <div class="card">
    <div class="card-header"><span class="card-title">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</span></div>
    <div style="padding:.75rem 1rem">
      <div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <span style="font-size:.82rem;color:var(--text-muted)">Ù…ÙˆØ¨Ø§ÛŒÙ„</span>
        <span style="font-size:.875rem;font-weight:700">{{ coach.phone }}</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--surface-2)">
        <span style="font-size:.82rem;color:var(--text-muted)">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª</span>
        <span style="font-size:.82rem;font-family:monospace">
          {% if coach.bank_card_number %}{{ coach.bank_card_number|slice:":4" }}-****-****-{{ coach.bank_card_number|slice:"-4:" }}{% else %}â€”{% endif %}
        </span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:.5rem 0">
        <span style="font-size:.82rem;color:var(--text-muted)">ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</span>
        <span style="font-size:.82rem">{{ coach.created_at|date:"Y/m/d" }}</span>
      </div>
    </div>
  </div>

  <!-- Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ—‚ï¸ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</span>
      {% if request.user.is_technical_director or request.user.is_superuser %}
      {% if available_categories %}
      <button class="btn btn-amber btn-sm" id="assign-btn" onclick="toggleAssignPanel()">+ Ø§Ø®ØªØµØ§Øµ Ø¯Ø³ØªÙ‡</button>
      {% endif %}
      {% endif %}
    </div>

    <!-- ÙØ±Ù… Ø§Ø®ØªØµØ§Øµ Ø¯Ø³ØªÙ‡ -->
    {% if request.user.is_technical_director or request.user.is_superuser %}
    {% if available_categories %}
    <div id="assign-panel" style="display:none;padding:.85rem 1rem;border-bottom:2px solid var(--amber);background:#fffbeb">
      <form method="post" action="{% url 'training:coach-assign-category' coach.pk %}"
            style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:flex-end">
        {% csrf_token %}
        <div>
          <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.25rem">Ø¯Ø³ØªÙ‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ *</label>
          <select name="category_id"
                  style="padding:.45rem .65rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:inherit;font-size:.82rem;min-width:140px">
            {% for cat in available_categories %}
            <option value="{{ cat.pk }}">{{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:700;display:block;margin-bottom:.25rem">Ù†Ø±Ø® Ù‡Ø± Ø¬Ù„Ø³Ù‡ (Ø±ÛŒØ§Ù„)</label>
          <input type="number" name="session_rate" min="0" step="10000" value="0" placeholder="Ù…Ø«Ø§Ù„: 500000"
                 style="padding:.45rem .65rem;border:1.5px solid var(--surface-2);border-radius:8px;font-family:monospace;font-size:.82rem;width:140px">
        </div>
        <button type="submit" class="btn btn-navy btn-sm">âœ… Ø§Ø®ØªØµØ§Øµ</button>
      </form>
    </div>
    {% endif %}
    {% endif %}

    {% if coach_rates %}
    <div style="padding:.65rem 1rem">
      {% for cr in coach_rates %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:.6rem 0;border-bottom:1px solid var(--surface-2)">
        <div>
          <div style="font-weight:700;font-size:.875rem">{{ cr.category.name }}</div>
          <div style="font-size:.7rem;color:var(--text-muted)">{% if cr.is_active %}ğŸŸ¢ ÙØ¹Ø§Ù„{% else %}ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„{% endif %}</div>
        </div>
        <div style="display:flex;align-items:center;gap:.5rem">
          <span style="font-size:.82rem;color:var(--amber);font-weight:700">{{ cr.session_rate|floatformat:0 }} Ø±ÛŒØ§Ù„/Ø¬Ù„Ø³Ù‡</span>
          {% if request.user.is_technical_director or request.user.is_superuser %}
          <form method="post" action="{% url 'training:coach-remove-category' coach.pk cr.pk %}"
                onsubmit="return confirm('Ù…Ø±Ø¨ÛŒ Ø§Ø² Ø¯Ø³ØªÙ‡ Â«{{ cr.category.name }}Â» Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')" style="margin:0">
            {% csrf_token %}
            <button type="submit"
                    style="background:none;border:none;cursor:pointer;color:#ef4444;font-size:.85rem;padding:.2rem .35rem"
                    title="Ø­Ø°Ù Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡">âœ•</button>
          </form>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding:1.5rem;text-align:center;color:var(--text-muted);font-size:.875rem">
      Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡
    </div>
    {% endif %}
  </div>
</div>

<!-- Ù„ÛŒÙ†Ú© Ø­Ù‚ÙˆÙ‚ -->
{% if coach_rates %}
{% if request.user.is_finance_manager or request.user.is_technical_director or request.user.is_superuser %}
<div class="card" style="padding:.75rem 1rem">
  <div style="font-size:.75rem;font-weight:800;color:var(--text-muted);margin-bottom:.5rem">ğŸ’³ Ú¯Ø²Ø§Ø±Ø´ Ø­Ù‚ÙˆÙ‚</div>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    {% for cr in coach_rates %}
    <a href="{% url 'payroll:salary-list' cr.category.pk %}" class="btn btn-outline btn-sm">{{ cr.category.name }}</a>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endif %}

<script>
function toggleAssignPanel() {
  const panel = document.getElementById('assign-panel');
  const btn   = document.getElementById('assign-btn');
  const open  = panel.style.display === 'none';
  panel.style.display = open ? 'block' : 'none';
  btn.textContent = open ? 'âœ• Ø¨Ø³ØªÙ†' : '+ Ø§Ø®ØªØµØ§Øµ Ø¯Ø³ØªÙ‡';
  btn.className   = open ? 'btn btn-outline btn-sm' : 'btn btn-amber btn-sm';
}
</script>

{% endblock %}