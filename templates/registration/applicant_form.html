{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ØªÙ‚Ø§Ø¶ÛŒ â€” Ø¨Ø§Ø´Ú¯Ø§Ù‡ ÙÙˆØªØ³Ø§Ù„ Ø§Ø³Ù¾Ø§Ø¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy:#0d1b2a; --navy-2:#122236; --navy-3:#1a3150;
      --amber:#f59e0b; --amber-light:#fcd34d;
      --green:#10b981; --red:#ef4444; --teal:#0ea5e9;
      --surface:#f0f4f8; --surface-2:#e2e8f0;
      --white:#fff; --text-main:#0f172a; --text-muted:#64748b;
      --radius:12px; --radius-sm:8px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Vazirmatn",Tahoma,sans-serif;background:var(--navy);min-height:100vh;direction:rtl;display:flex;flex-direction:column}
    /* â”€â”€ Hero Header â”€â”€ */
    .reg-header{background:linear-gradient(135deg,var(--navy-2),var(--navy-3));border-bottom:1px solid rgba(255,255,255,.07);padding:1.5rem 2rem;display:flex;align-items:center;gap:1rem}
    .reg-logo{width:48px;height:48px;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(245,158,11,.4);flex-shrink:0;background:#fff}
    .reg-logo img{width:100%;height:100%;object-fit:cover}
    .reg-title{color:var(--white);font-size:1.2rem;font-weight:800}
    .reg-sub{color:rgba(255,255,255,.5);font-size:.8rem;margin-top:.15rem}
    /* â”€â”€ Layout â”€â”€ */
    .reg-main{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:2rem 1rem}
    .reg-card{background:var(--white);border-radius:var(--radius);width:100%;max-width:820px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.4)}
    /* â”€â”€ Step Progress â”€â”€ */
    .steps-bar{background:linear-gradient(135deg,var(--navy-2) 0%,var(--navy-3) 100%);display:flex;padding:1.25rem 2rem;gap:0;position:relative;overflow:hidden}
    .steps-bar::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(45deg,transparent,transparent 20px,rgba(245,158,11,.02) 20px,rgba(245,158,11,.02) 21px);pointer-events:none}
    .step-item{display:flex;align-items:center;flex:1;gap:.5rem;cursor:pointer}
    .step-circle{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;border:2px solid rgba(255,255,255,.2);color:rgba(255,255,255,.4);flex-shrink:0;transition:all .3s}
    .step-item.done .step-circle{background:var(--green);border-color:var(--green);color:var(--white)}
    .step-item.active .step-circle{background:var(--amber);border-color:var(--amber);color:var(--navy);box-shadow:0 0 12px rgba(245,158,11,.5)}
    .step-label{font-size:.75rem;color:rgba(255,255,255,.4);font-weight:600;transition:color .3s}
    .step-item.active .step-label,.step-item.done .step-label{color:rgba(255,255,255,.8)}
    .step-line{height:1px;background:rgba(255,255,255,.1);flex:1;margin:0 .25rem;align-self:center}
    /* â”€â”€ Form Sections â”€â”€ */
    .form-section{display:none;padding:2rem}
    .form-section.active{display:block}
    .section-title{font-size:1rem;font-weight:800;margin-bottom:1.25rem;padding-bottom:.75rem;border-bottom:2px solid var(--surface);display:flex;align-items:center;gap:.5rem;color:var(--navy)}
    .field-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
    .field-grid.cols-1{grid-template-columns:1fr}
    .field-grid.cols-2{grid-template-columns:1fr 1fr}
    .form-group{display:flex;flex-direction:column;gap:.35rem}
    label{font-size:.82rem;font-weight:600;color:var(--text-main)}
    label .req{color:var(--red);margin-right:.15rem}
    input,select,textarea{padding:.6rem .85rem;border:1.5px solid var(--surface-2);border-radius:var(--radius-sm);font-family:inherit;font-size:.875rem;transition:border-color .15s;width:100%;appearance:none;background:var(--white)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--navy);box-shadow:0 0 0 3px rgba(13,27,42,.1)}
    .hint{font-size:.72rem;color:var(--text-muted)}
    .field-error{font-size:.72rem;color:var(--red);display:none}
    /* â”€â”€ Radio Pills â”€â”€ */
    .radio-pills{display:flex;gap:.5rem;flex-wrap:wrap}
    .radio-pills input{display:none}
    .radio-pills label{padding:.45rem 1rem;border:1.5px solid var(--surface-2);border-radius:99px;cursor:pointer;font-size:.82rem;font-weight:600;color:var(--text-muted);transition:all .2s}
    .radio-pills input:checked+label{border-color:var(--navy);background:var(--navy);color:var(--white)}
    /* â”€â”€ Navigation â”€â”€ */
    .form-nav{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 2rem;border-top:1px solid var(--surface);background:var(--surface)}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.4rem;border-radius:var(--radius-sm);border:none;cursor:pointer;font-family:inherit;font-size:.9rem;font-weight:700;text-decoration:none;transition:all .2s}
    .btn-primary{background:var(--navy);color:var(--white)}
    .btn-primary:hover{background:var(--navy-3)}
    .btn-amber{background:var(--amber);color:var(--navy)}
    .btn-amber:hover{filter:brightness(1.1)}
    .btn-outline{background:transparent;border:1.5px solid var(--surface-2);color:var(--text-muted)}
    .btn-outline:hover{background:var(--surface-2)}
    .btn:disabled{opacity:.5;pointer-events:none}
    /* â”€â”€ Errors â”€â”€ */
    .server-errors{background:#fee2e2;border:1px solid #fecaca;border-radius:var(--radius-sm);padding:1rem;margin:0 2rem 0;font-size:.85rem;color:#991b1b}
    /* â”€â”€ Agree â”€â”€ (Ø­Ø°Ù Ø´Ø¯) */
    /* â”€â”€ Jalali Date Picker â”€â”€ */
    .jalali-picker { display: flex; gap: .4rem; align-items: center; }
    .jalali-picker select {
      flex: 1; padding: .6rem .5rem;
      border: 1.5px solid var(--surface-2); border-radius: var(--radius-sm);
      font-family: inherit; font-size: .875rem; background: var(--white);
      transition: border-color .15s; appearance: none; text-align: center; cursor: pointer;
    }
    .jalali-picker select:focus { outline: none; border-color: var(--navy); box-shadow: 0 0 0 3px rgba(13,27,42,.1); }
    .jalali-picker .jp-year { flex: 2.2; }
    .jalali-picker .jp-month { flex: 2.5; }
    .jalali-picker .jp-day  { flex: 1.2; }
    @media(max-width:600px){.field-grid{grid-template-columns:1fr}.steps-bar{padding:1rem}.form-section{padding:1.25rem}.form-nav{padding:1rem}.field-grid.cols-2{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header class="reg-header">
  <div class="reg-logo">
    <img src="{% static 'img/fcespad.jpg' %}" alt="Ù„ÙˆÚ¯ÙˆÛŒ Ø¨Ø§Ø´Ú¯Ø§Ù‡ Ø§Ø³Ù¾Ø§Ø¯">
  </div>
  <div>
    <div class="reg-title">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø¨Ø§Ø´Ú¯Ø§Ù‡ ÙÙˆØªØ³Ø§Ù„ Ø§Ø³Ù¾Ø§Ø¯</div>
    <div class="reg-sub">ÙØ±Ù… Ø¬Ø§Ù…Ø¹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… â€” Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ø¯Ù‚Øª ØªÚ©Ù…ÛŒÙ„ Ø´ÙˆØ¯</div>
  </div>
</header>

<main class="reg-main">
<div class="reg-card">

  <!-- Progress Steps -->
  <div class="steps-bar">
    <div class="step-item active" id="step-ind-1" onclick="goStep(1)">
      <div class="step-circle">Û±</div>
      <span class="step-label">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" id="step-ind-2" onclick="goStep(2)">
      <div class="step-circle">Û²</div>
      <span class="step-label">Ø¨ÛŒÙˆÙ…ØªØ±ÛŒÚ©</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" id="step-ind-3" onclick="goStep(3)">
      <div class="step-circle">Û³</div>
      <span class="step-label">Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡</span>
    </div>
    <div class="step-line"></div>
    <div class="step-item" id="step-ind-4" onclick="goStep(4)">
      <div class="step-circle">Û´</div>
      <span class="step-label">Ø¨ÛŒÙ…Ù‡ Ùˆ ØªØ£ÛŒÛŒØ¯</span>
    </div>
  </div>

  <!-- Server Errors -->
  {% if form.errors %}
  <div class="server-errors" style="margin-top:1rem">
    <strong>Ø®Ø·Ø§:</strong>
    {% for field, errors in form.errors.items %}
      {% for err in errors %}<div>{{ err }}</div>{% endfor %}
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="reg-form" novalidate>
    {% csrf_token %}

    <!-- â”€â”€ Step 1: Personal Info â”€â”€ -->
    <div class="form-section active" id="section-1">
      <div style="padding:2rem 2rem 0">
        <div class="section-title">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ</div>
        <div class="field-grid">
          <div class="form-group">
            <label>Ù†Ø§Ù… <span class="req">*</span></label>
            <input type="text" name="first_name" value="{{ form.first_name.value|default:'' }}" required placeholder="Ù†Ø§Ù…">
          </div>
          <div class="form-group">
            <label>Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ <span class="req">*</span></label>
            <input type="text" name="last_name" value="{{ form.last_name.value|default:'' }}" required placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
          </div>
          <div class="form-group">
            <label>Ù†Ø§Ù… Ù¾Ø¯Ø± <span class="req">*</span></label>
            <input type="text" name="father_name" value="{{ form.father_name.value|default:'' }}" required placeholder="Ù†Ø§Ù… Ù¾Ø¯Ø±">
          </div>
          <div class="form-group">
            <label>Ú©Ø¯ Ù…Ù„ÛŒ <span class="req">*</span></label>
            <input type="text" name="national_id" value="{{ form.national_id.value|default:'' }}" required maxlength="10" inputmode="numeric" placeholder="Û±Û° Ø±Ù‚Ù…">
            <span class="hint">Ø¨Ø¯ÙˆÙ† Ø®Ø· ØªÛŒØ±Ù‡ØŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û±Û° Ø±Ù‚Ù…</span>
          </div>
          <div class="form-group">
            <label>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ (Ø´Ù…Ø³ÛŒ) <span class="req">*</span></label>
            <div class="jalali-picker" id="picker-dob">
              <select class="jp-year" onchange="jalaliCompose('dob')">
                <option value="">Ø³Ø§Ù„</option>
              </select>
              <select class="jp-month" onchange="jalaliCompose('dob')">
                <option value="">Ù…Ø§Ù‡</option>
                <option value="1">ÙØ±ÙˆØ±Ø¯ÛŒÙ†</option><option value="2">Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª</option>
                <option value="3">Ø®Ø±Ø¯Ø§Ø¯</option><option value="4">ØªÛŒØ±</option>
                <option value="5">Ù…Ø±Ø¯Ø§Ø¯</option><option value="6">Ø´Ù‡Ø±ÛŒÙˆØ±</option>
                <option value="7">Ù…Ù‡Ø±</option><option value="8">Ø¢Ø¨Ø§Ù†</option>
                <option value="9">Ø¢Ø°Ø±</option><option value="10">Ø¯ÛŒ</option>
                <option value="11">Ø¨Ù‡Ù…Ù†</option><option value="12">Ø§Ø³ÙÙ†Ø¯</option>
              </select>
              <select class="jp-day" onchange="jalaliCompose('dob')">
                <option value="">Ø±ÙˆØ²</option>
              </select>
            </div>
            <input type="hidden" name="dob" id="hidden-dob" value="{{ form.dob.value|default:'' }}">
            <span class="hint">Ø³Ø§Ù„ ØªÙˆÙ„Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ â€” Ø¨Ø±Ø§ÛŒ Ø±Ø¯Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ù†ÛŒ</span>
          </div>
          <div class="form-group">
            <label>Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§Ø²ÛŒÚ©Ù† <span class="req">*</span></label>
            <input type="tel" name="phone" value="{{ form.phone.value|default:'' }}" required placeholder="09xxxxxxxxx" inputmode="numeric">
          </div>
          <div class="form-group">
            <label>Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾Ø¯Ø± <span class="req">*</span></label>
            <input type="tel" name="father_phone" value="{{ form.father_phone.value|default:'' }}" required placeholder="09xxxxxxxxx" inputmode="numeric">
          </div>
          <div class="form-group">
            <label>Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø§Ø¯Ø±</label>
            <input type="tel" name="mother_phone" value="{{ form.mother_phone.value|default:'' }}" placeholder="09xxxxxxxxx (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" inputmode="numeric">
          </div>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Ø¢Ø¯Ø±Ø³</label>
          <textarea name="address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">{{ form.address.value|default:'' }}</textarea>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Step 2: Biometrics â”€â”€ -->
    <div class="form-section" id="section-2">
      <div style="padding:2rem 2rem 0">
        <div class="section-title">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø³Ù…Ø§Ù†ÛŒ</div>
        <div class="field-grid">
          <div class="form-group">
            <label>Ù‚Ø¯ (Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±)</label>
            <input type="number" name="height" value="{{ form.height.value|default:'' }}" placeholder="Û±Û·Ûµ" min="50" max="250" inputmode="numeric">
          </div>
          <div class="form-group">
            <label>ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
            <input type="number" name="weight" value="{{ form.weight.value|default:'' }}" step="0.1" placeholder="Û·Û°" min="20" max="300" inputmode="decimal">
          </div>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Ø¯Ø³Øª Ø¨Ø±ØªØ±</label>
          <div class="radio-pills">
            <input type="radio" name="preferred_hand" id="ph-r" value="R" {% if form.preferred_hand.value != 'L' %}checked{% endif %}><label for="ph-r">Ø±Ø§Ø³Øª âœ‹</label>
            <input type="radio" name="preferred_hand" id="ph-l" value="L" {% if form.preferred_hand.value == 'L' %}checked{% endif %}><label for="ph-l">Ú†Ù¾ ğŸ¤š</label>
          </div>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Ù¾Ø§ÛŒ Ø¨Ø±ØªØ±</label>
          <div class="radio-pills">
            <input type="radio" name="preferred_foot" id="pf-r" value="R" {% if form.preferred_foot.value != 'L' %}checked{% endif %}><label for="pf-r">Ø±Ø§Ø³Øª ğŸ¦µ</label>
            <input type="radio" name="preferred_foot" id="pf-l" value="L" {% if form.preferred_foot.value == 'L' %}checked{% endif %}><label for="pf-l">Ú†Ù¾ ğŸ¦µ</label>
          </div>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Ø³Ø§Ø¨Ù‚Ù‡ Ù¾Ø²Ø´Ú©ÛŒ</label>
          <textarea name="medical_history" rows="3" placeholder="Ø¨ÛŒÙ…Ø§Ø±ÛŒ Ø®Ø§ØµØŒ Ø¯Ø§Ø±Ùˆ Ù…ØµØ±ÙÛŒØŒ Ø§Ù„Ø±Ú˜ÛŒ...">{{ form.medical_history.value|default:'' }}</textarea>
        </div>
        <div class="form-group" style="margin-top:1rem">
          <label>Ø³Ø§Ø¨Ù‚Ù‡ Ø¢Ø³ÛŒØ¨â€ŒØ¯ÛŒØ¯Ú¯ÛŒ</label>
          <textarea name="injury_history" rows="2" placeholder="Ø¢Ø³ÛŒØ¨â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒØŒ Ø¹Ù…Ù„ Ø¬Ø±Ø§Ø­ÛŒ...">{{ form.injury_history.value|default:'' }}</textarea>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Step 3: Family â”€â”€ -->
    <div class="form-section" id="section-3">
      <div style="padding:2rem 2rem 0">
        <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</div>
        <div class="field-grid cols-2">
          <div class="form-group">
            <label>ØªØ­ØµÛŒÙ„Ø§Øª Ù¾Ø¯Ø±</label>
            <select name="father_education">
              <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
              {% for val, label in form.father_education.field.choices %}
              <option value="{{ val }}" {% if form.father_education.value == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Ø´ØºÙ„ Ù¾Ø¯Ø±</label>
            <input type="text" name="father_job" value="{{ form.father_job.value|default:'' }}"
                   placeholder="Ø´ØºÙ„ Ù¾Ø¯Ø±" list="job-list-father" autocomplete="off">
            <datalist id="job-list-father">
              <option value="Ù†Ø¸Ø§Ù…ÛŒ / Ø§Ø±ØªØ´">
              <option value="Ù†Ø¸Ø§Ù…ÛŒ / Ø³Ù¾Ø§Ù‡">
              <option value="Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¯ÙˆÙ„Øª">
              <option value="Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø®Ø´ Ø®ØµÙˆØµÛŒ">
              <option value="Ø¢Ø²Ø§Ø¯ / Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø´Ø®ØµÛŒ">
              <option value="Ù¾Ø²Ø´Ú© / Ù¾Ø±Ø³ØªØ§Ø±">
              <option value="Ù…Ù‡Ù†Ø¯Ø³">
              <option value="Ù…Ø¹Ù„Ù… / Ø§Ø³ØªØ§Ø¯">
              <option value="Ú©Ø´Ø§ÙˆØ±Ø²">
              <option value="Ø¨Ø§Ø²Ù†Ø´Ø³ØªÙ‡">
              <option value="Ø¨ÛŒÚ©Ø§Ø± / Ø¬ÙˆÛŒØ§ÛŒ Ú©Ø§Ø±">
            </datalist>
          </div>
          <div class="form-group">
            <label>ØªØ­ØµÛŒÙ„Ø§Øª Ù…Ø§Ø¯Ø±</label>
            <select name="mother_education">
              <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
              {% for val, label in form.mother_education.field.choices %}
              <option value="{{ val }}" {% if form.mother_education.value == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label>Ø´ØºÙ„ Ù…Ø§Ø¯Ø±</label>
            <input type="text" name="mother_job" value="{{ form.mother_job.value|default:'' }}"
                   placeholder="Ø´ØºÙ„ Ù…Ø§Ø¯Ø±" list="job-list-mother" autocomplete="off">
            <datalist id="job-list-mother">
              <option value="Ù†Ø¸Ø§Ù…ÛŒ / Ø§Ø±ØªØ´">
              <option value="Ù†Ø¸Ø§Ù…ÛŒ / Ø³Ù¾Ø§Ù‡">
              <option value="Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¯ÙˆÙ„Øª">
              <option value="Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø®Ø´ Ø®ØµÙˆØµÛŒ">
              <option value="Ø¢Ø²Ø§Ø¯ / Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø´Ø®ØµÛŒ">
              <option value="Ù¾Ø²Ø´Ú© / Ù¾Ø±Ø³ØªØ§Ø±">
              <option value="Ù…Ù‡Ù†Ø¯Ø³">
              <option value="Ù…Ø¹Ù„Ù… / Ø§Ø³ØªØ§Ø¯">
              <option value="Ø®Ø§Ù†Ù‡â€ŒØ¯Ø§Ø±">
              <option value="Ø¨Ø§Ø²Ù†Ø´Ø³ØªÙ‡">
              <option value="Ø¨ÛŒÚ©Ø§Ø± / Ø¬ÙˆÛŒØ§ÛŒ Ú©Ø§Ø±">
            </datalist>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Step 4: Insurance + Agree â”€â”€ -->
    <div class="form-section" id="section-4">
      <div style="padding:2rem 2rem 0">
        <div class="section-title">ğŸ›¡ï¸ Ø¨ÛŒÙ…Ù‡</div>
        <div class="form-group">
          <label>ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒÙ…Ù‡</label>
          <div class="radio-pills">
            <input type="radio" name="insurance_status" id="ins-none" value="none" {% if form.insurance_status.value != 'active' %}checked{% endif %} onchange="toggleInsuranceDate(this.value)">
            <label for="ins-none">Ø¨Ø¯ÙˆÙ† Ø¨ÛŒÙ…Ù‡ âŒ</label>
            <input type="radio" name="insurance_status" id="ins-active" value="active" {% if form.insurance_status.value == 'active' %}checked{% endif %} onchange="toggleInsuranceDate(this.value)">
            <label for="ins-active">Ø¯Ø§Ø±Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ âœ…</label>
          </div>
        </div>
        <div id="insurance-date-wrap" style="display:none;margin-top:1rem">
          <div class="form-group">
            <label>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¨ÛŒÙ…Ù‡ <span class="req">*</span></label>
            <div class="jalali-picker" id="picker-ins">
              <select class="jp-year" onchange="jalaliCompose('ins')">
                <option value="">Ø³Ø§Ù„</option>
              </select>
              <select class="jp-month" onchange="jalaliCompose('ins')">
                <option value="">Ù…Ø§Ù‡</option>
              </select>
              <select class="jp-day" onchange="jalaliCompose('ins')">
                <option value="">Ø±ÙˆØ²</option>
              </select>
            </div>
            <input type="hidden" name="insurance_expiry_date" id="hidden-ins" value="{{ form.insurance_expiry_date.value|default:'' }}">
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="form-nav">
      <button type="button" class="btn btn-outline" id="prev-btn" onclick="prevStep()" style="display:none">â† Ù‚Ø¨Ù„ÛŒ</button>
      <div id="step-counter" style="font-size:.8rem;color:var(--text-muted)">Ù…Ø±Ø­Ù„Ù‡ <span id="cur-step">Û±</span> Ø§Ø² Û´</div>
      <button type="button" class="btn btn-primary" id="next-btn" onclick="nextStep()">Ø¨Ø¹Ø¯ÛŒ â†</button>
      <button type="submit" class="btn btn-amber" id="submit-btn" style="display:none">âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
    </div>

  </form>
</div>
</main>

<script>
const PERSIAN_NUMS = ["Û°","Û±","Û²","Û³","Û´","Ûµ","Û¶","Û·","Û¸","Û¹"];
const toP = n => String(n).split("").map(d => PERSIAN_NUMS[+d] || d).join("");

let currentStep = 1;
const totalSteps = 4;

function goStep(step) {
  if (step > currentStep) { nextStep(); return; }
  showStep(step);
}

function showStep(step) {
  document.querySelectorAll(".form-section").forEach((s,i) => {
    s.classList.toggle("active", i+1 === step);
  });
  document.querySelectorAll(".step-item").forEach((el,i) => {
    el.classList.toggle("active", i+1 === step);
    el.classList.toggle("done", i+1 < step);
  });
  document.getElementById("cur-step").textContent = toP(step);
  document.getElementById("prev-btn").style.display   = step > 1 ? "flex" : "none";
  document.getElementById("next-btn").style.display   = step < totalSteps ? "flex" : "none";
  document.getElementById("submit-btn").style.display = step === totalSteps ? "flex" : "none";
  currentStep = step;
  window.scrollTo({top:0, behavior:"smooth"});
}

function nextStep() {
  if (currentStep < totalSteps) showStep(currentStep + 1);
}
function prevStep() {
  if (currentStep > 1) showStep(currentStep - 1);
}

function toggleInsuranceDate(val) {
  document.getElementById("insurance-date-wrap").style.display = val === "active" ? "block" : "none";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ â€” Jalali Date Picker
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const JALALI_MONTHS = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†","Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª","Ø®Ø±Ø¯Ø§Ø¯","ØªÛŒØ±","Ù…Ø±Ø¯Ø§Ø¯","Ø´Ù‡Ø±ÛŒÙˆØ±",
                        "Ù…Ù‡Ø±","Ø¢Ø¨Ø§Ù†","Ø¢Ø°Ø±","Ø¯ÛŒ","Ø¨Ù‡Ù…Ù†","Ø§Ø³ÙÙ†Ø¯"];

// Ø¢ÛŒØ§ Ø³Ø§Ù„ Ú©Ø¨ÛŒØ³Ù‡ Ø´Ù…Ø³ÛŒ Ø§Ø³ØªØŸ
function isJalaliLeap(y) {
  const r = ((y - (y > 0 ? 474 : 473)) % 2820 + 474 + 38) * 682;
  return (r % 2816) < 682;
}

// ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù‡Ø± Ù…Ø§Ù‡
function jalaliDaysInMonth(month, year) {
  if (month <= 6) return 31;
  if (month <= 11) return 30;
  return isJalaliLeap(year) ? 30 : 29;
}

// Ø³Ø§Ø®Øª Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ dropdown
function buildYearOptions(sel, from, to, selectedVal) {
  sel.innerHTML = '<option value="">Ø³Ø§Ù„</option>';
  for (let y = to; y >= from; y--) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = toP(y);
    if (String(y) === String(selectedVal)) opt.selected = true;
    sel.appendChild(opt);
  }
}

function buildMonthOptions(sel, selectedVal) {
  sel.innerHTML = '<option value="">Ù…Ø§Ù‡</option>';
  JALALI_MONTHS.forEach((name, i) => {
    const opt = document.createElement("option");
    opt.value = i + 1;
    opt.textContent = name;
    if (String(i + 1) === String(selectedVal)) opt.selected = true;
    sel.appendChild(opt);
  });
}

function buildDayOptions(sel, month, year, selectedVal) {
  const days = (month && year) ? jalaliDaysInMonth(+month, +year) : 31;
  sel.innerHTML = '<option value="">Ø±ÙˆØ²</option>';
  for (let d = 1; d <= days; d++) {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = toP(d);
    if (String(d) === String(selectedVal)) opt.selected = true;
    sel.appendChild(opt);
  }
}

// ØªØ±Ú©ÛŒØ¨ Ù…Ù‚Ø§Ø¯ÛŒØ± â†’ hidden field  (ÙØ±Ù…Øª: YYYY/MM/DD)
function jalaliCompose(fieldId) {
  const picker = document.getElementById(`picker-${fieldId}`);
  const hidden = document.getElementById(`hidden-${fieldId}`);
  if (!picker || !hidden) return;
  const y = picker.querySelector(".jp-year").value;
  const m = picker.querySelector(".jp-month").value;
  const d = picker.querySelector(".jp-day").value;
  // Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ± Ø³Ø§Ù„/Ù…Ø§Ù‡ØŒ Ø±ÙˆØ²Ù‡Ø§ Ø±Ùˆ rebuild Ú©Ù†
  buildDayOptions(picker.querySelector(".jp-day"), m, y, d);
  hidden.value = (y && m && d) ? `${y}/${String(m).padStart(2,"0")}/${String(d).padStart(2,"0")}` : "";
}

// parse Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø² hidden field
function parseDateValue(val) {
  if (!val) return {y:"",m:"",d:""};
  const parts = val.replace(/[Û°-Û¹]/g, c => "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹".indexOf(c)).split("/");
  return { y: parts[0]||"", m: parts[1] ? parseInt(parts[1]) : "", d: parts[2] ? parseInt(parts[2]) : "" };
}

// Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø± Ø¯Ùˆ picker
function initPicker(fieldId, yearFrom, yearTo) {
  const picker = document.getElementById(`picker-${fieldId}`);
  const hidden = document.getElementById(`hidden-${fieldId}`);
  if (!picker) return;
  const val = parseDateValue(hidden ? hidden.value : "");
  buildYearOptions(picker.querySelector(".jp-year"),   yearFrom, yearTo, val.y);
  buildMonthOptions(picker.querySelector(".jp-month"), val.m);
  buildDayOptions(picker.querySelector(".jp-day"), val.m, val.y, val.d);
}

// Init insurance state + show correct step on error
document.addEventListener("DOMContentLoaded", () => {
  // â”€â”€ ØªÙ‚ÙˆÛŒÙ… ØªÙˆÙ„Ø¯: Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Û±Û³Û´Û° ØªØ§ Û±Û´Û±Û° â”€â”€
  initPicker("dob", 1340, 1410);

  // â”€â”€ ØªÙ‚ÙˆÛŒÙ… Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¨ÛŒÙ…Ù‡: Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Û±Û´Û°Û° ØªØ§ Û±Û´Û±Ûµ â”€â”€
  initPicker("ins", 1400, 1415);

  const active = document.getElementById("ins-active");
  if (active && active.checked) toggleInsuranceDate("active");

  // Ù†Ù…Ø§ÛŒØ´ Ù…Ø±Ø­Ù„Ù‡ Ø¯Ø±Ø³Øª Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
  {% if form.errors %}
  const errorFields = {{ form.errors|json_script:"form-errors" }};
  const step1Fields = ["first_name","last_name","father_name","national_id","dob","phone","father_phone","mother_phone","address"];
  const step2Fields = ["height","weight","preferred_hand","preferred_foot","medical_history","injury_history"];
  const step3Fields = ["father_education","father_job","mother_education","mother_job"];
  const step4Fields = ["insurance_status","insurance_expiry_date"];

  let errorStep = 1;
  const errKeys = Object.keys(JSON.parse(document.getElementById("form-errors").textContent));
  if (errKeys.some(k => step4Fields.includes(k)))      errorStep = 4;
  else if (errKeys.some(k => step3Fields.includes(k))) errorStep = 3;
  else if (errKeys.some(k => step2Fields.includes(k))) errorStep = 2;
  showStep(errorStep);
  {% endif %}
});
</script>
</body>
</html>