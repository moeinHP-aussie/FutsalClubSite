{% extends "base.html" %}
{% block title %}Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†{% endblock %}
{% block nav_import %}active{% endblock %}

{% block breadcrumb %}
  <span class="sep">â€º</span>
  <a href="{% url 'registration:applicant-list' %}" style="text-decoration:none;color:inherit">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</a>
  <span class="sep">â€º</span>
  <span class="cur">Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ</span>
{% endblock %}

{% block extra_head %}
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK IMPORT â€” scoped styles
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Drop Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drop-zone {
  border: 2px dashed var(--surface-2);
  border-radius: var(--radius);
  padding: 3rem 2rem;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  background: var(--surface);
  position: relative;
  overflow: hidden;
}
.drop-zone:hover, .drop-zone.drag-over {
  border-color: var(--amber);
  background: #fffbeb;
}
.drop-zone input[type=file] {
  position: absolute; inset: 0;
  opacity: 0; cursor: pointer; width: 100%; height: 100%;
}
.drop-icon { font-size: 3rem; margin-bottom: .75rem; }
.drop-title { font-size: 1.05rem; font-weight: 700; color: var(--text-main); }
.drop-sub   { font-size: .82rem; color: var(--text-muted); margin-top: .35rem; }
.file-chosen {
  display: none;
  align-items: center; gap: .75rem;
  padding: .85rem 1rem;
  background: #d1fae5; border: 1px solid #a7f3d0;
  border-radius: var(--radius-sm);
  font-size: .875rem; color: #065f46; font-weight: 600;
  margin-top: .75rem;
}
.file-chosen.show { display: flex; }

/* â”€â”€ Sheet Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sheet-chips { display: flex; flex-wrap: wrap; gap: .4rem; margin-top: .5rem; }
.sheet-chip  {
  padding: .35rem .85rem;
  border-radius: 99px;
  border: 1.5px solid var(--surface-2);
  font-size: .8rem; font-weight: 600;
  cursor: pointer; transition: var(--transition); color: var(--text-muted);
  user-select: none;
}
.sheet-chip:hover { border-color: var(--navy); color: var(--navy); }
.sheet-chip.selected { background: var(--navy); border-color: var(--navy); color: var(--white); }
.sheet-loading { font-size: .82rem; color: var(--text-muted); display: none; }

/* â”€â”€ Column Map Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.col-map-table { font-size: .8rem; width: 100%; border-collapse: collapse; }
.col-map-table th {
  background: var(--surface); padding: .5rem .85rem;
  text-align: right; font-size: .72rem; color: var(--text-muted); font-weight: 700;
  border-bottom: 2px solid var(--surface-2);
}
.col-map-table td { padding: .5rem .85rem; border-bottom: 1px solid var(--surface); }
.col-map-table tr:last-child td { border-bottom: none; }
.col-letter {
  font-weight: 800; font-size: .85rem; font-family: monospace;
  color: var(--navy);
}
.col-required { color: var(--red); font-weight: 700; }

/* â”€â”€ Progress / Result â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-header {
  display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
  margin-bottom: 1.25rem;
}
.result-stat {
  display: flex; flex-direction: column; align-items: center;
  padding: .85rem 1.25rem;
  border-radius: var(--radius-sm);
  min-width: 100px;
}
.result-stat.green { background: #d1fae5; color: #065f46; }
.result-stat.blue  { background: #dbeafe; color: #1e3a8a; }
.result-stat.amber { background: #fef3c7; color: #92400e; }
.result-stat.red   { background: #fee2e2; color: #991b1b; }
.result-stat .num  { font-size: 2rem; font-weight: 900; line-height: 1; }
.result-stat .lbl  { font-size: .72rem; font-weight: 600; margin-top: .2rem; }

/* â”€â”€ Row Result Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-table { font-size: .8rem; }
.action-created { color: var(--green); font-weight: 700; }
.action-updated { color: var(--teal); font-weight: 700; }
.action-skipped { color: var(--text-muted); }
.action-error   { color: var(--red); font-weight: 700; }
.filter-btns { display: flex; gap: .35rem; flex-wrap: wrap; margin-bottom: .75rem; }
.filt-btn {
  padding: .3rem .75rem; border-radius: 99px;
  font-size: .77rem; font-weight: 700;
  border: 1.5px solid var(--surface-2);
  cursor: pointer; transition: var(--transition);
  background: none; color: var(--text-muted); font-family: inherit;
}
.filt-btn.on { background: var(--navy); border-color: var(--navy); color: var(--white); }
.progress-bar-outer {
  height: 8px; border-radius: 99px;
  background: var(--surface-2); margin-top: .4rem;
}
.progress-bar-inner {
  height: 100%; border-radius: 99px;
  background: linear-gradient(90deg, var(--green), var(--teal));
  transition: width .5s ease;
}

/* â”€â”€ Loading Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes spin { to { transform: rotate(360deg); } }
.import-overlay {
  display: none;
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(13,27,42,.75);
  align-items: center; justify-content: center;
  flex-direction: column; gap: 1.25rem;
}
.import-overlay-box {
  background: #fff;
  border-radius: 16px;
  padding: 2rem 2.5rem;
  text-align: center;
  max-width: 340px; width: 90%;
  box-shadow: 0 24px 60px rgba(0,0,0,.4);
}
.import-spinner {
  font-size: 2.5rem;
  display: inline-block;
  animation: spin 1s linear infinite;
  margin-bottom: .75rem;
}
.import-overlay-title {
  font-size: 1rem; font-weight: 800; color: #0d1b2a;
  margin-bottom: .5rem;
}
.import-overlay-msg {
  font-size: .85rem; color: #64748b; min-height: 1.4rem;
  transition: opacity .3s;
}
.import-overlay-hint {
  font-size: .75rem; color: #94a3b8; margin-top: 1rem;
  padding-top: .75rem; border-top: 1px solid #e2e8f0;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>ğŸ“¥ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø¯Ø³ØªÙ‡â€ŒØ¬Ù…Ø¹ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</h1>
    <p>Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§Ø´Ú¯Ø§Ù‡ â€” Ú©Ø¯Ù…Ù„ÛŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ù„ÛŒØ¯ ÛŒÚ©ØªØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
  </div>
  {% if result %}
  <a href="{% url 'registration:bulk-import' %}" class="btn btn-outline">â† Ø§ÛŒÙ…Ù¾ÙˆØ±Øª Ø¬Ø¯ÛŒØ¯</a>
  {% endif %}
</div>

<!-- â”€â”€ Loading Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="import-loading-overlay" class="import-overlay">
  <div class="import-overlay-box">
    <div class="import-spinner">âš™ï¸</div>
    <div class="import-overlay-title">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„...</div>
    <div class="import-overlay-msg" id="import-loading-msg">ğŸ“– Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„...</div>
    <div class="import-overlay-hint">
      Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ Ùˆ ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¨Ù†Ø¯ÛŒØ¯.<br>
      Ø¨Ø³ØªÙ‡ Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯.
    </div>
  </div>
</div>

{% if not result %}
{# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UPLOAD FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
<div style="display:grid;grid-template-columns:1fr 360px;gap:1.5rem;align-items:start">

  <!-- Left: Upload Form -->
  <div>
    <form method="post" enctype="multipart/form-data" id="import-form"
          onsubmit="return onFormSubmit(this)">
      {% csrf_token %}

      <!-- Drop Zone -->
      <div class="card mb-2">
        <div class="card-header"><span class="card-title">ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„</span></div>
        <div class="card-body">
          <div class="drop-zone" id="drop-zone">
            <input type="file" name="excel_file" id="excel-file"
                   accept=".xlsx,.xls" required
                   onchange="onFileChosen(this)">
            <div class="drop-icon">ğŸ“Š</div>
            <div class="drop-title">ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
            <div class="drop-sub">{{ allowed_formats }} | Ø­Ø¯Ø§Ú©Ø«Ø± {{ max_upload_mb }} Ù…Ú¯Ø§Ø¨Ø§ÛŒØª</div>
          </div>
          <div class="file-chosen" id="file-chosen">
            <span style="font-size:1.5rem">âœ…</span>
            <div>
              <div id="chosen-name" style="font-weight:700">â€”</div>
              <div id="chosen-size" style="font-size:.75rem;color:#065f46">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sheet Selection -->
      <div class="card mb-2">
        <div class="card-header">
          <span class="card-title">ğŸ—‚ï¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø´ÛŒØªâ€ŒÙ‡Ø§</span>
          <span class="text-sm text-muted">Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ù‡Ù…Ù‡ Ø´ÛŒØªâ€ŒÙ‡Ø§</span>
        </div>
        <div class="card-body">
          <div id="sheet-loading" class="sheet-loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ø´ÛŒØªâ€ŒÙ‡Ø§...</div>
          <div class="sheet-chips" id="sheet-chips">
            <span style="font-size:.82rem;color:var(--text-muted)">Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</span>
          </div>
          <input type="hidden" name="sheet_names" id="sheet-names-input" value="">
          <div class="form-hint" style="margin-top:.5rem">
            Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø´ÛŒØªÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´ÙˆØ¯ØŒ Ù‡Ù…Ù‡ Ø´ÛŒØªâ€ŒÙ‡Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
          </div>
        </div>
      </div>

      <!-- Options -->
      <div class="card mb-2">
        <div class="card-header"><span class="card-title">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span></div>
        <div class="card-body">
          <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer;padding:.75rem;border:1.5px solid var(--surface-2);border-radius:var(--radius-sm);transition:var(--transition)"
                 id="dry-run-label">
            <input type="checkbox" name="dry_run" value="1" id="dry-run-cb"
                   onchange="toggleDryRun(this)"
                   style="width:18px;height:18px;accent-color:var(--amber)">
            <div>
              <div style="font-weight:700;font-size:.9rem">ğŸ” Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ (Dry Run)</div>
              <div style="font-size:.78rem;color:var(--text-muted);margin-top:.15rem">
                ÙØ§ÛŒÙ„ ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§Ù…Ø§ Ù‡ÛŒÚ† Ú†ÛŒØ²ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
              </div>
            </div>
          </label>
        </div>
      </div>

      <!-- Submit -->
      <div style="display:flex;gap:.75rem;justify-content:flex-end">
        <button type="submit" class="btn btn-amber btn-lg" id="import-btn">
          ğŸ“¥ Ø´Ø±ÙˆØ¹ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª
        </button>
      </div>
    </form>
  </div>

  <!-- Right: Column Map Sidebar -->
  <div>
    <div class="card" style="position:sticky;top:calc(var(--header-h) + 1rem)">
      <div class="card-header">
        <span class="card-title">ğŸ—ºï¸ Ù†Ú¯Ø§Ø´Øª Ø³ØªÙˆÙ†â€ŒÙ‡Ø§</span>
      </div>
      <div style="max-height:520px;overflow-y:auto">
        <table class="col-map-table">
          <thead>
            <tr>
              <th>Ø³ØªÙˆÙ†</th>
              <th>Ø¹Ù†ÙˆØ§Ù† ÙØ§ÛŒÙ„</th>
              <th>ÙÛŒÙ„Ø¯ Ø³ÛŒØ³ØªÙ…</th>
            </tr>
          </thead>
          <tbody>
            {% for col, persian, field, required in column_map %}
            <tr>
              <td class="col-letter">{{ col }}</td>
              <td>{{ persian }}</td>
              <td>
                {% if field == "â€”" %}
                  <span style="color:var(--text-light)">â€”</span>
                {% else %}
                  <code style="font-size:.75rem;background:var(--surface);padding:.1rem .35rem;border-radius:4px">
                    {{ field }}
                  </code>
                {% endif %}
                {% if required %}
                  <span class="col-required" title="Ø§Ù„Ø²Ø§Ù…ÛŒ">âœ±</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="padding:.75rem 1rem;border-top:1px solid var(--surface);font-size:.72rem;color:var(--text-muted)">
        <span class="col-required">âœ±</span> ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ
      </div>
    </div>
  </div>

</div>
{% endif %}

{% if result %}
{# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}

{% if dry_run %}
<div class="alert alert-warning mb-2">
  <span class="alert-icon">ğŸ”</span>
  <div>
    <strong>Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ â€” Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø¹Ù…Ø§Ù„ Ù†Ø´Ø¯</strong>
    <div style="margin-top:.3rem;font-size:.85rem">Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ§Ù‚Ø¹ÛŒØŒ ÙØ§ÛŒÙ„ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªÛŒÚ© Dry Run Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯.</div>
  </div>
</div>
{% endif %}

<!-- Result Stats -->
<div style="display:flex;gap:.85rem;flex-wrap:wrap;margin-bottom:1.5rem">
  <div class="result-stat green">
    <div class="num">{{ result.created }}</div>
    <div class="lbl">Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</div>
  </div>
  <div class="result-stat blue">
    <div class="num">{{ result.updated }}</div>
    <div class="lbl">Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡</div>
  </div>
  <div class="result-stat amber">
    <div class="num">{{ result.skipped }}</div>
    <div class="lbl">Ø±Ø¯ Ø´Ø¯Ù‡</div>
  </div>
  <div class="result-stat red">
    <div class="num">{{ result.errors }}</div>
    <div class="lbl">Ø®Ø·Ø§</div>
  </div>
  <div class="result-stat" style="background:var(--surface-2);color:var(--text-muted)">
    <div class="num">{{ result.total_rows }}</div>
    <div class="lbl">Ú©Ù„ Ø±Ø¯ÛŒÙ</div>
  </div>
  <div class="result-stat" style="background:#ede9fe;color:#5b21b6">
    <div class="num">{{ result.categories_created }}</div>
    <div class="lbl">Ø¯Ø³ØªÙ‡ Ø¬Ø¯ÛŒØ¯</div>
  </div>
</div>

<!-- Progress bar -->
<div style="margin-bottom:1.5rem">
  <div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-muted);margin-bottom:.35rem">
    <span>Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</span>
    <strong style="color:var(--text-main)">%{{ result.success_rate }}</strong>
  </div>
  <div class="progress-bar-outer">
    <div class="progress-bar-inner" style="width:{{ result.success_rate }}%"></div>
  </div>
</div>

<!-- Warnings -->
{% if result.warnings %}
<div class="card mb-2">
  <div class="card-header">
    <span class="card-title">âš ï¸ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ ({{ result.warnings|length }})</span>
  </div>
  <div class="card-body" style="padding:.75rem">
    {% for w in result.warnings %}
    <div style="font-size:.82rem;padding:.35rem 0;border-bottom:1px solid var(--surface);color:var(--amber-dim)">
      âš  {{ w }}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Row Results Table -->
<div class="card">
  <div class="card-header">
    <span class="card-title">ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§</span>
    <span class="text-sm text-muted">{{ result.rows|length }} Ø±Ø¯ÛŒÙ</span>
  </div>
  <div class="card-body" style="padding:.75rem 1rem .5rem">
    <div class="filter-btns">
      <button class="filt-btn on" onclick="filterRows('all',this)">Ù‡Ù…Ù‡</button>
      <button class="filt-btn" onclick="filterRows('created',this)" style="color:var(--green)">âœ… Ø§ÛŒØ¬Ø§Ø¯</button>
      <button class="filt-btn" onclick="filterRows('updated',this)" style="color:var(--teal)">ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²</button>
      <button class="filt-btn" onclick="filterRows('skipped',this)">â© Ø±Ø¯</button>
      <button class="filt-btn" onclick="filterRows('error',this)" style="color:var(--red)">âŒ Ø®Ø·Ø§</button>
    </div>
    <input type="text" id="row-search" class="form-control" style="max-width:280px;margin-bottom:.75rem"
           placeholder="Ø¬Ø³ØªØ¬Ùˆ Ù†Ø§Ù… / Ú©Ø¯Ù…Ù„ÛŒ..." oninput="searchRows(this.value)">
  </div>
  <div class="table-wrap">
    <table class="data-table result-table" id="result-table">
      <thead>
        <tr>
          <th>Ø´ÛŒØª</th>
          <th>Ø±Ø¯ÛŒÙ</th>
          <th>Ù†Ø§Ù…</th>
          <th>Ú©Ø¯Ù…Ù„ÛŒ</th>
          <th>ÙˆØ¶Ø¹ÛŒØª</th>
          <th>Ù¾ÛŒØ§Ù…</th>
        </tr>
      </thead>
      <tbody id="result-tbody">
        {% for row in result.rows %}
        <tr data-action="{{ row.action }}"
            data-name="{{ row.name|lower }}"
            data-nid="{{ row.national_id }}">
          <td style="font-size:.75rem;color:var(--text-muted)">{{ row.sheet }}</td>
          <td>{{ row.row_num }}</td>
          <td style="font-weight:600">{{ row.name }}</td>
          <td style="font-family:monospace;font-size:.8rem">{{ row.national_id }}</td>
          <td>
            <span class="action-{{ row.action }}">
              {% if row.action == 'created' %}âœ… Ø§ÛŒØ¬Ø§Ø¯
              {% elif row.action == 'updated' %}ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²
              {% elif row.action == 'skipped' %}â© Ø±Ø¯
              {% elif row.action == 'error' %}âŒ Ø®Ø·Ø§
              {% else %}{{ row.action }}{% endif %}
            </span>
          </td>
          <td style="font-size:.78rem;color:var(--text-muted);max-width:280px">
            {{ row.message|truncatechars:120 }}
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted)">Ù‡ÛŒÚ† Ø±Ø¯ÛŒÙÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
<script>
/* â”€â”€ File Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onFileChosen(input) {
  const file = input.files[0];
  if (!file) return;

  const el = document.getElementById("file-chosen");
  document.getElementById("chosen-name").textContent = file.name;
  document.getElementById("chosen-size").textContent = (file.size / 1024 / 1024).toFixed(2) + " MB";
  el.classList.add("show");

  // Try to load sheet names via AJAX
  loadSheetNames(input.files[0]);
}

/* â”€â”€ Drag & Drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const dz = document.getElementById("drop-zone");
if (dz) {
  dz.addEventListener("dragover",  e => { e.preventDefault(); dz.classList.add("drag-over"); });
  dz.addEventListener("dragleave", () => dz.classList.remove("drag-over"));
  dz.addEventListener("drop",      e => {
    e.preventDefault(); dz.classList.remove("drag-over");
    const fi = document.getElementById("excel-file");
    fi.files = e.dataTransfer.files;
    onFileChosen(fi);
  });
}

/* â”€â”€ Sheet Loader (AJAX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let selectedSheets = new Set();

async function loadSheetNames(file) {
  const loading = document.getElementById("sheet-loading");
  const chips   = document.getElementById("sheet-chips");
  if (!loading || !chips) return;

  loading.style.display = "block";
  chips.innerHTML = "";
  selectedSheets.clear();

  const fd = new FormData();
  fd.append("excel_file", file);
  fd.append("csrfmiddlewaretoken", getCookie("csrftoken"));

  try {
    const res  = await fetch("{% url 'registration:import-preview' %}", { method: "POST", body: fd });
    const data = await res.json();
    loading.style.display = "none";

    if (data.sheets && data.sheets.length) {
      chips.innerHTML = "";
      data.sheets.forEach(name => {
        const chip = document.createElement("div");
        chip.className   = "sheet-chip selected";
        chip.textContent = name;
        chip.dataset.name = name;
        selectedSheets.add(name);
        chip.onclick = () => toggleSheet(chip, name);
        chips.appendChild(chip);
      });
      updateSheetInput();
    } else {
      chips.innerHTML = '<span style="color:var(--text-muted);font-size:.82rem">Ù‡ÛŒÚ† Ø´ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</span>';
    }
  } catch (e) {
    loading.style.display = "none";
    chips.innerHTML = '<span style="color:var(--red);font-size:.82rem">Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø´ÛŒØªâ€ŒÙ‡Ø§</span>';
  }
}

function toggleSheet(chip, name) {
  if (selectedSheets.has(name)) {
    selectedSheets.delete(name);
    chip.classList.remove("selected");
  } else {
    selectedSheets.add(name);
    chip.classList.add("selected");
  }
  updateSheetInput();
}

function updateSheetInput() {
  const inp = document.getElementById("sheet-names-input");
  if (inp) inp.value = Array.from(selectedSheets).join(",");
}

/* â”€â”€ Dry Run Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleDryRun(cb) {
  const lbl = document.getElementById("dry-run-label");
  const btn = document.getElementById("import-btn");
  if (cb.checked) {
    lbl.style.borderColor = "var(--amber)";
    lbl.style.background  = "#fffbeb";
    btn.textContent = "ğŸ” Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´";
    btn.className = "btn btn-outline btn-lg";
  } else {
    lbl.style.borderColor = "";
    lbl.style.background  = "";
    btn.textContent = "ğŸ“¥ Ø´Ø±ÙˆØ¹ Ø§ÛŒÙ…Ù¾ÙˆØ±Øª";
    btn.className = "btn btn-amber btn-lg";
  }
}

/* â”€â”€ Form Submit Handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onFormSubmit(form) {
  const file = document.getElementById("excel-file");
  if (!file || !file.files.length) {
    return true; // browser will show required validation
  }

  // Ù†Ù…Ø§ÛŒØ´ overlay Ù¾ÛŒØ´Ø±ÙØª â€” Ù‚Ø¨Ù„ Ø§Ø² disable Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡
  showLoadingOverlay();

  // Ø¨Ø¹Ø¯ Ø§Ø² ÛŒÙ‡ ÙØ±ÛŒÙ… Ú©ÙˆØªØ§Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù† (ÙØ±Ù… Ù‚Ø¨Ù„Ø§Ù‹ submit Ø´Ø¯Ù‡)
  const btn = document.getElementById("import-btn");
  setTimeout(() => {
    if (btn) {
      btn.disabled  = true;
      btn.innerHTML = "<span style='animation:spin .8s linear infinite;display:inline-block'>â³</span> Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
      btn.style.opacity = ".8";
    }
  }, 50);

  return true; // Ø§Ø¬Ø§Ø²Ù‡ submit Ø¨Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø±
}

function showLoadingOverlay() {
  const overlay = document.getElementById("import-loading-overlay");
  if (overlay) overlay.style.display = "flex";

  // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†Ø§ÙˆØ¨ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ú©Ø§Ø±Ø¨Ø±
  const msgs = [
    "ğŸ“– Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„...",
    "ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...",
    "âš™ï¸ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†...",
    "ğŸ’¾ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³...",
    "âœ… Ø¯Ø± Ø­Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒâ€ŒØ³Ø§Ø²ÛŒ...",
  ];
  let i = 0;
  const lbl = document.getElementById("import-loading-msg");
  if (lbl) {
    lbl.textContent = msgs[0];
    setInterval(() => { i = (i+1) % msgs.length; lbl.textContent = msgs[i]; }, 2000);
  }
}

/* â”€â”€ Result Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentFilter = "all";

function filterRows(action, btn) {
  currentFilter = action;
  document.querySelectorAll(".filt-btn").forEach(b => b.classList.remove("on"));
  btn.classList.add("on");
  applyFilters();
}

function searchRows(q) {
  applyFilters(q.trim().toLowerCase());
}

function applyFilters(q = "") {
  document.querySelectorAll("#result-tbody tr").forEach(row => {
    const action = row.dataset.action  || "";
    const name   = row.dataset.name    || "";
    const nid    = row.dataset.nid     || "";

    const matchAction = currentFilter === "all" || action === currentFilter;
    const matchSearch = !q || name.includes(q) || nid.includes(q);

    row.style.display = matchAction && matchSearch ? "" : "none";
  });
}
</script>
{% endblock %}